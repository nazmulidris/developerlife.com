<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Build with Naz : Rust typestate pattern | developerlife.com</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Build with Naz : Rust typestate pattern" />
<meta name="author" content="Nazmul Idris" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The Typestate Pattern in Rust is a way to manage objects that go through different states in their lifecycle. It leverages Rust’s powerful type system to enforce these states and transitions between them, making your code safer and more predictable. Learn all about it in this article and its video." />
<meta property="og:description" content="The Typestate Pattern in Rust is a way to manage objects that go through different states in their lifecycle. It leverages Rust’s powerful type system to enforce these states and transitions between them, making your code safer and more predictable. Learn all about it in this article and its video." />
<link rel="canonical" href="http://developerlife.com/2024/05/28/typestate-pattern-rust/" />
<meta property="og:url" content="http://developerlife.com/2024/05/28/typestate-pattern-rust/" />
<meta property="og:site_name" content="developerlife.com" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-05-28T10:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Build with Naz : Rust typestate pattern" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Nazmul Idris"},"dateModified":"2024-05-28T10:00:00-05:00","datePublished":"2024-05-28T10:00:00-05:00","description":"The Typestate Pattern in Rust is a way to manage objects that go through different states in their lifecycle. It leverages Rust’s powerful type system to enforce these states and transitions between them, making your code safer and more predictable. Learn all about it in this article and its video.","headline":"Build with Naz : Rust typestate pattern","mainEntityOfPage":{"@type":"WebPage","@id":"http://developerlife.com/2024/05/28/typestate-pattern-rust/"},"url":"http://developerlife.com/2024/05/28/typestate-pattern-rust/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css" />

  <!-- Add favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

  <!-- Add font awesome -->
  <link
    rel="stylesheet"
    href="https://use.fontawesome.com/releases/v5.2.0/css/all.css"
    integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ"
    crossorigin="anonymous"
  />

  <!-- Add Google fonts-->
  <link
    href="https://fonts.googleapis.com/css?family=Spline+Sans|Work+Sans|Fira+Mono|Fira+Sans|Google+Sans|Lexend+Deca&display=swap"
    rel="stylesheet"
  /><link type="application/atom+xml" rel="alternate" href="http://developerlife.com/feed.xml" title="developerlife.com" /><!-- https://developers.google.com/analytics/devguides/collection/gtagjs -->
<script async
        src="https://www.googletagmanager.com/gtag/js?id=G-NQY9ECC58H"></script>
<script>
  window.dataLayer = window.dataLayer || []

  function gtag() {
    window.dataLayer.push(arguments)
  }

  gtag("js", new Date())
  gtag("config", "G-NQY9ECC58H")
</script>
<!-- https://us14.admin.mailchimp.com/account/connected-sites/site-detail/ -->

<script id="mcjs">
  !(function (c, h, i, m, p) {
    ;(m = c.createElement(h)),
      (p = c.getElementsByTagName(h)[0]),
      (m.async = 1),
      (m.src = i),
      p.parentNode.insertBefore(m, p)
  })(
    document,
    "script",
    "https://chimpstatic.com/mcjs-connected/js/users/c2470ddfa863eb8ace707651b/2bb3bcad193ef862398700457.js"
  )
</script>
</head>
<body><!-- https://github.com/mermaid-js/mermaid/blob/develop/docs/n00b-gettingStarted.md -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

<script>
  // https://mermaid-js.github.io/mermaid/#/theming
  mermaid.initialize({
    startOnLoad: true,
    theme: "dark",
    themeVariables: {
      fontFamily: "Fira Code",
      fontSize: "0.95rem",
      darkMode: true,
      primaryColor: "#2f9ece",
      mainBkg: "#303439",
    },
  })
</script>
<header class="site-header" role="banner">

    <div class="wrapper header-wrapper"><div class="logo-container">
        <div class="logo-image">
          <a class="site-title"
             rel="author"
             href="/">
              <!-- This is the logo image placeholder. -->
                <picture>
                  <source srcset="/assets/dl-logo-icon-dark.svg" media="(max-width: 600px)"/>
                  <img  src="/assets/dl-logo-icon-and-text-dark.svg" />
                </picture>
          </a>
        </div>
      </div><nav class="site-nav">
            <input type="checkbox" id="nav-trigger" class="nav-trigger"/>
            <label for="nav-trigger">
          <span class="menu-icon">
              <svg class="svg-icon">
              <use xlink:href="/assets/minima-social-icons.svg#menu">
              </use>
            </svg>
          </span>
            </label>

            <div class="trigger"><!--
    Iterate over all the pages in the site, where page_cursor holds the current
    page for each pass of the for loop.
    Note that page is the currently loaded page itself.
--><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/Android/"> Android </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/CC/"> Concurrency </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/CLI/"> CLI </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/CS/"> CS </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/DB/"> Database </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/DI/"> DI </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/FE/"> Frontend </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/Hardware/"> Hardware </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/IJ/"> IntelliJ </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/KT/"> Kotlin </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/Linux/"> Linux </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/MP/"> MP </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/Misc/"> Misc </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/Node/"> Node </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/Productivity/"> Productivity </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/RN/"> React-Native </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/React/"> React </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/Rust/"> Rust </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/Server/"> Server </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/State/"> State-Management </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/Stories/"> Stories </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/TDD/"> Testing </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/TS/"> TypeScript </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/TUI/"> TUI </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/Web/"> Web </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/about-me/"> Nazmul Idris </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/about-site/"> About Us </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/authors/"> Authors </a></div>
        </nav></div>
</header>

<!-- Debug to show the value of page.title and page.category variables -->
<!--<pre>page_cursor.exclude = nil</pre>-->
<!--<pre>page.exclude = nil</pre>-->
<!--<pre>page.title = &quot;Build with Naz : Rust typestate pattern&quot;</pre>-->
<!--<pre>page.category = nil</pre>-->
<!--<pre>page.title (json) = Build with Naz : Rust typestate pattern</pre>-->
<!--<pre>page.category (json) = </pre>-->
<div class="page-and-sidebar-wrapper">
      <main class="page-content" aria-label="Content">
        <div class="wrapper"><article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting"><header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Build with Naz : Rust typestate pattern</h1>

    <!-- Create all the variables needed for this page (and all the includes) -->
    

    <div class="post-meta">
        <p>
            <!-- Date -->May 28, 2024

            <!--Author-->
            ∙ <a href="/about-me">Nazmul Idris</a>

            <!-- One line social blurb --><ul class="contact-list">
    <li class="p-name">Hi, I'm
            <a href="/about-me">Nazmul</a>,
            an ex-Googler, <a href="https://github.com/r3bl-org/r3bl-open-core/tree/main/tui" target="_blank">r3bl_tui maintainer</a>, SWE, entrepreneur, designer, leader,
            TaiChi-er, racer, storyteller.
            <!-- This is font awesome icon -->
            I <i class="fas fa-heart"></i>
            leadership, authenticity, empowerment, lifelong learning,
            <i class="fas fa-code"></i>,
            <i class="fas fa-terminal"></i>, &
            <i class="fas fa-coffee"></i>,
            😃.</li>
</ul>
</p>
    </div><div class="social-media-container">
  <!-- <iframe
    src="https://github.com/sponsors/nazmulidris/button"
    title="Sponsor nazmulidris"
    height="35"
    width="116"
    style="border: 0; padding-right: 6px"
  ></iframe> -->

  <a href="/subscribe.html" target="_blank"
    ><kbd>Subscribe for updates</kbd></a
  ><p class="social-media-item">
    <a
      href="https://www.linkedin.com/in/nazmulidris"
      target="_blank"
    >
      <svg class="svg-icon">
        <use xlink:href="/assets/minima-social-icons.svg#linkedin"></use>
      </svg>
    </a>
  </p><p class="social-media-item">
    <a href="https://www.youtube.com/channel/UCMcsxfCwzwDevc3NRqFgfEg" target="_blank">
      <svg class="svg-icon">
        <use xlink:href="/assets/minima-social-icons.svg#youtube"></use>
      </svg>
    </a>
  </p><p class="social-media-item">
    <a href="https://www.github.com/nazmulidris" target="_blank">
      <svg class="svg-icon">
        <use xlink:href="/assets/minima-social-icons.svg#github"></use>
      </svg>
    </a>
  </p><p class="social-media-item">
    <a href="/feed.xml" target="_blank">
      <svg class="svg-icon">
        <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
      </svg>
    </a>
  </p></div>
</header>
<div class="post-content e-content" itemprop="articleBody">
        <blockquote>
  👀 Watch Rust 🦀 live coding videos on our
  <a href="https://www.youtube.com/@developerlifecom">YouTube Channel</a>.

  <br />

  <!-- effective async rust video & async rust playlist -->
  <iframe src="https://www.youtube.com/embed/qvIt8MF-pCM?si=hDVrz64pLbTLYe_m"
    title="YouTube video player"
    frameborder="0"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
    referrerpolicy="strict-origin-when-cross-origin" allowfullscreen>
  </iframe>

  <!-- video on rust polymorphism (no playlist) -->
  <!-- <iframe
      src="https://www.youtube.com/embed/kYTgGtJjSro?si=XmW-_CAvCfB5e269"
      title="YouTube video player" frameborder="0"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
      referrerpolicy="strict-origin-when-cross-origin"
      allowfullscreen
      >
  </iframe> -->

  <!-- video on intro to testing (with playlist) -->
  <!-- <iframe
    src="https://www.youtube.com/embed/videoseries?si=7gmhXY5DVYJG7OdU&amp;list=PLofhE49PEwmwLR_4Noa0dFOSPmSpIg_l8"
    title="YouTube video player"
    frameborder="0"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
    referrerpolicy="strict-origin-when-cross-origin"
    allowfullscreen
  >
  </iframe> -->

</blockquote>
        <!-- If a page has a hero-image defined in it, then show it here -->


        <p><img class="post-hero-image" src="/assets/rust-typestate-pattern.svg" /></p>

<!-- TOC -->

<ul>
  <li><a href="#what-is-the-typestate-pattern">What is the typestate pattern?</a></li>
  <li><a href="#more-resources-on-typestate-pattern-and-others-in-rust">More resources on typestate pattern and others in Rust</a></li>
  <li><a href="#youtube-video-for-this-article">YouTube video for this article</a></li>
  <li><a href="#examples-of-typestate-pattern-in-rust">Examples of typestate pattern in Rust</a>
    <ul>
      <li><a href="#example-1-simple-version-of-this-is-using-enums-to-encapsulate-states-as-variants">Example 1: Simple version of this is using enums to encapsulate states as variants</a></li>
      <li><a href="#example-2-slightly-more-complex-versions-are-where-one-type--data--another-type">Example 2: Slightly more complex versions are where one type + data = another type</a></li>
      <li><a href="#example-3-best-of-both-worlds-using-generics-and-struct--enum-with-a-marker-trait">Example 3: Best of both worlds, using generics and struct / enum with a marker trait</a></li>
      <li><a href="#parting-thoughts">Parting thoughts</a></li>
    </ul>
  </li>
  <li><a href="#build-with-naz-video-series-on-developerlifecom-youtube-channel">Build with Naz video series on developerlife.com YouTube channel</a></li>
</ul>

<!-- /TOC -->
      <h2 id="what-is-the-typestate-pattern">
        
        
          What is the typestate pattern? <a href="#what-is-the-typestate-pattern">#</a>
        
        
      </h2>
    
<p><a id="markdown-what-is-the-typestate-pattern%3F" name="what-is-the-typestate-pattern%3F"></a></p>

<p>The Typestate Pattern in Rust is a way to manage objects that go through different states
in their lifecycle. It leverages Rust’s powerful type system to enforce these states and
transitions between them, making your code safer and more predictable.</p>

<p>Here are the key ideas behind the Typestate Pattern:</p>

<ul>
  <li><em>States as structs</em>: Each possible state of the object is represented by a separate
struct. This lets you associate specific methods and data with each state.</li>
  <li><em>Transitions with ownership</em>: Methods that transition the object to a new state consume
the old state and return a value representing the new state. Rust’s ownership system
ensures you can’t accidentally use the object in an invalid state.</li>
  <li><em>Encapsulated functionality</em>: Methods are only available on the structs representing the
valid states. This prevents you from trying to perform actions that aren’t allowed in
the current state.</li>
</ul>

<p>Benefits of using the Typestate Pattern:</p>

<ul>
  <li><em>Safer code</em>: By statically checking types at compile time, the compiler prevents you from
accidentally using the object in an invalid state. This leads to fewer runtime errors
and more robust code.</li>
  <li><em>Improved readability</em>: The code becomes more self-documenting because the valid state
transitions are encoded in the types themselves.</li>
  <li><em>Clearer APIs</em>: By separating functionality based on state, APIs become more intuitive and
easier to understand.</li>
</ul>
      <h2 id="more-resources-on-typestate-pattern-and-others-in-rust">
        
        
          More resources on typestate pattern and others in Rust <a href="#more-resources-on-typestate-pattern-and-others-in-rust">#</a>
        
        
      </h2>
    
<p><a id="markdown-more-resources-on-typestate-pattern-and-others-in-rust" name="more-resources-on-typestate-pattern-and-others-in-rust"></a></p>

<ul>
  <li><a href="https://arxiv.org/pdf/2307.07069">Functional typed design patterns</a>.</li>
  <li><a href="https://gemini.google.com/app/5bd7fed51858cb4d">Enums and typestate (and limitations)</a>.</li>
  <li><a href="https://willcrichton.net/rust-api-type-patterns/typestate.html">Type-Driven API Design in Rust</a>.</li>
  <li><a href="https://ruk.si/notes/rust/typestate/">Rust typestate notes</a>.</li>
  <li><a href="https://rustype.github.io/notes/notes/rust-typestate-series/rust-typestate-part-1">Rusty Typestates - Starting Out</a>.</li>
  <li><a href="https://docs.rust-embedded.org/book/static-guarantees/typestate-programming.html">The Embedded Rust Book - Typestate programming</a>.</li>
  <li><a href="https://yoric.github.io/post/rust-typestate/">Typestates in Rust</a>.</li>
</ul>
      <h2 id="youtube-video-for-this-article">
        
        
          YouTube video for this article <a href="#youtube-video-for-this-article">#</a>
        
        
      </h2>
    
<p><a id="markdown-youtube-video-for-this-article" name="youtube-video-for-this-article"></a></p>

<p>This blog post has short examples on how to use the typestate pattern in Rust. If you like
to learn via video, please watch the companion video on the <a href="https://www.youtube.com/@developerlifecom">developerlife.com YouTube
channel</a>.</p>

<!-- rust typestate pattern -->
<iframe src="https://www.youtube.com/embed/FTSb0dyDOCA?si=ZdUYIxxGTsaAC1B3" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen="">
</iframe>

<p><br /></p>
      <h2 id="examples-of-typestate-pattern-in-rust">
        
        
          Examples of typestate pattern in Rust <a href="#examples-of-typestate-pattern-in-rust">#</a>
        
        
      </h2>
    
<p><a id="markdown-examples-of-typestate-pattern-in-rust" name="examples-of-typestate-pattern-in-rust"></a></p>

<p>Let’s create some examples to illustrate how to use the typestate pattern in Rust. You can run
<code class="language-plaintext highlighter-rouge">cargo new --bin typestate-pattern</code> to create a new binary crate.</p>

<blockquote>
  <p>The code in the video and this tutorial are all in <a href="https://github.com/nazmulidris/rust-scratch/blob/main/typestate-pattern/">this GitHub
repo</a>.</p>
</blockquote>

<p>Then add the following to the <code class="language-plaintext highlighter-rouge">Cargo.toml</code> file that’s generated. These pull in all the
dependencies that we need for these examples.</p>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[package]</span>
<span class="py">name</span> <span class="p">=</span> <span class="s">"typestate-pattern"</span>
<span class="py">version</span> <span class="p">=</span> <span class="s">"0.1.0"</span>
<span class="py">edition</span> <span class="p">=</span> <span class="s">"2021"</span>

<span class="nn">[[bin]]</span>
<span class="py">name</span> <span class="p">=</span> <span class="s">"ex1"</span>
<span class="py">path</span> <span class="p">=</span> <span class="s">"src/ex1.rs"</span>

<span class="nn">[[bin]]</span>
<span class="py">name</span> <span class="p">=</span> <span class="s">"ex2"</span>
<span class="py">path</span> <span class="p">=</span> <span class="s">"src/ex2.rs"</span>

<span class="nn">[[bin]]</span>
<span class="py">name</span> <span class="p">=</span> <span class="s">"ex3"</span>
<span class="py">path</span> <span class="p">=</span> <span class="s">"src/ex3.rs"</span>

<span class="nn">[[bin]]</span>
<span class="py">name</span> <span class="p">=</span> <span class="s">"ex3_1"</span>
<span class="py">path</span> <span class="p">=</span> <span class="s">"src/ex3_1.rs"</span>

<span class="c"># See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html</span>

<span class="nn">[dependencies]</span>
<span class="py">crossterm</span> <span class="o">=</span> <span class="p">{</span> <span class="py">version</span> <span class="p">=</span> <span class="s">"0.27.0"</span><span class="p">,</span> <span class="py">features</span> <span class="p">=</span> <span class="p">[</span><span class="s">"event-stream"</span><span class="p">]</span> <span class="p">}</span>
</code></pre></div></div>
      <h3 id="example-1-simple-version-of-this-is-using-enums-to-encapsulate-states-as-variants">
        
        
          Example 1: Simple version of this is using enums to encapsulate states as variants <a href="#example-1-simple-version-of-this-is-using-enums-to-encapsulate-states-as-variants">#</a>
        
        
      </h3>
    
<p><a id="markdown-example-1%3A-simple-version-of-this-is-using-enums-to-encapsulate-states-as-variants" name="example-1%3A-simple-version-of-this-is-using-enums-to-encapsulate-states-as-variants"></a></p>

<p>Then you can add the following code to the <code class="language-plaintext highlighter-rouge">src/ex1.rs</code> file.</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[derive(Debug)]</span>
<span class="k">pub</span> <span class="k">enum</span> <span class="n">InputEvent</span> <span class="p">{</span>
    <span class="nf">Keyboard</span><span class="p">((</span><span class="n">KeyPress</span><span class="p">,</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Modifier</span><span class="o">&gt;&gt;</span><span class="p">)),</span>
    <span class="nf">Resize</span><span class="p">(</span><span class="n">Size</span><span class="p">),</span>
    <span class="nf">Mouse</span><span class="p">(</span><span class="n">MouseEvent</span><span class="p">),</span>
<span class="p">}</span>

<span class="nd">#[derive(Debug)]</span>
<span class="k">pub</span> <span class="k">enum</span> <span class="n">Modifier</span> <span class="p">{</span>
    <span class="n">Shift</span><span class="p">,</span>
    <span class="n">Control</span><span class="p">,</span>
    <span class="n">Alt</span><span class="p">,</span>
<span class="p">}</span>

<span class="nd">#[derive(Debug)]</span>
<span class="k">pub</span> <span class="k">enum</span> <span class="n">KeyPress</span> <span class="p">{</span>
    <span class="nf">Char</span><span class="p">(</span><span class="nb">char</span><span class="p">),</span>
    <span class="n">Enter</span><span class="p">,</span>
    <span class="n">Backspace</span><span class="p">,</span>
    <span class="n">Delete</span><span class="p">,</span>
    <span class="n">Left</span><span class="p">,</span>
    <span class="n">Right</span><span class="p">,</span>
    <span class="n">Up</span><span class="p">,</span>
    <span class="n">Down</span><span class="p">,</span>
    <span class="n">Home</span><span class="p">,</span>
    <span class="n">End</span><span class="p">,</span>
    <span class="n">PageUp</span><span class="p">,</span>
    <span class="n">PageDown</span><span class="p">,</span>
    <span class="n">Tab</span><span class="p">,</span>
    <span class="nf">F</span><span class="p">(</span><span class="nb">u8</span><span class="p">),</span>
<span class="p">}</span>

<span class="nd">#[derive(Debug)]</span>
<span class="k">pub</span> <span class="k">enum</span> <span class="n">Size</span> <span class="p">{</span>
    <span class="nf">Height</span><span class="p">(</span><span class="nb">u16</span><span class="p">),</span>
    <span class="nf">Width</span><span class="p">(</span><span class="nb">u16</span><span class="p">),</span>
<span class="p">}</span>

<span class="nd">#[derive(Debug)]</span>
<span class="k">pub</span> <span class="k">enum</span> <span class="n">MouseEvent</span> <span class="p">{</span>
    <span class="nf">Press</span><span class="p">(</span><span class="n">MouseButton</span><span class="p">,</span> <span class="nb">u16</span><span class="p">,</span> <span class="nb">u16</span><span class="p">),</span>
    <span class="nf">Release</span><span class="p">(</span><span class="nb">u16</span><span class="p">,</span> <span class="nb">u16</span><span class="p">),</span>
    <span class="nf">Hold</span><span class="p">(</span><span class="nb">u16</span><span class="p">,</span> <span class="nb">u16</span><span class="p">),</span>
<span class="p">}</span>

<span class="nd">#[derive(Debug)]</span>
<span class="k">pub</span> <span class="k">enum</span> <span class="n">MouseButton</span> <span class="p">{</span>
    <span class="n">Left</span><span class="p">,</span>
    <span class="n">Right</span><span class="p">,</span>
    <span class="n">Middle</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">InputEvent</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">pretty_print</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">it</span> <span class="o">=</span> <span class="k">match</span> <span class="k">self</span> <span class="p">{</span>
            <span class="nn">InputEvent</span><span class="p">::</span><span class="nf">Keyboard</span><span class="p">((</span><span class="n">keypress</span><span class="p">,</span> <span class="n">modifiers</span><span class="p">))</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="k">let</span> <span class="k">mut</span> <span class="n">result</span> <span class="o">=</span> <span class="nd">format!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span> <span class="n">keypress</span><span class="p">);</span>
                <span class="k">if</span> <span class="k">let</span> <span class="nf">Some</span><span class="p">(</span><span class="n">modifiers</span><span class="p">)</span> <span class="o">=</span> <span class="n">modifiers</span> <span class="p">{</span>
                    <span class="n">result</span><span class="nf">.push_str</span><span class="p">(</span><span class="o">&amp;</span><span class="nd">format!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span> <span class="n">modifiers</span><span class="p">));</span>
                <span class="p">}</span>
                <span class="n">result</span>
            <span class="p">}</span>
            <span class="nn">InputEvent</span><span class="p">::</span><span class="nf">Resize</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nd">format!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span>
            <span class="nn">InputEvent</span><span class="p">::</span><span class="nf">Mouse</span><span class="p">(</span><span class="n">mouse_event</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nd">format!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span> <span class="n">mouse_event</span><span class="p">),</span>
        <span class="p">};</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="n">it</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">a_pressed</span> <span class="o">=</span> <span class="nn">InputEvent</span><span class="p">::</span><span class="nf">Keyboard</span><span class="p">((</span><span class="nn">KeyPress</span><span class="p">::</span><span class="nf">Char</span><span class="p">(</span><span class="sc">'a'</span><span class="p">),</span> <span class="nb">None</span><span class="p">));</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span> <span class="n">a_pressed</span><span class="p">);</span>

    <span class="k">let</span> <span class="n">ctrl_c_pressed</span> <span class="o">=</span> <span class="nn">InputEvent</span><span class="p">::</span><span class="nf">Keyboard</span><span class="p">(</span>
        <span class="p">(</span><span class="nn">KeyPress</span><span class="p">::</span><span class="nf">Char</span><span class="p">(</span><span class="sc">'c'</span><span class="p">),</span> <span class="nf">Some</span><span class="p">(</span><span class="nd">vec!</span><span class="p">[</span><span class="nn">Modifier</span><span class="p">::</span><span class="n">Control</span><span class="p">]))</span>
    <span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span> <span class="n">ctrl_c_pressed</span><span class="p">);</span>

    <span class="k">let</span> <span class="n">enter_pressed</span> <span class="o">=</span> <span class="nn">InputEvent</span><span class="p">::</span><span class="nf">Keyboard</span><span class="p">((</span><span class="nn">KeyPress</span><span class="p">::</span><span class="n">Enter</span><span class="p">,</span> <span class="nb">None</span><span class="p">));</span>
    <span class="n">enter_pressed</span><span class="nf">.pretty_print</span><span class="p">();</span>

    <span class="k">let</span> <span class="n">mouse_pressed</span> <span class="o">=</span> <span class="nn">InputEvent</span><span class="p">::</span><span class="nf">Mouse</span><span class="p">(</span>
        <span class="nn">MouseEvent</span><span class="p">::</span><span class="nf">Press</span><span class="p">(</span><span class="nn">MouseButton</span><span class="p">::</span><span class="n">Left</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
    <span class="p">);</span>
    <span class="n">mouse_pressed</span><span class="nf">.pretty_print</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>The code for this example is
<a href="https://github.com/nazmulidris/rust-scratch/blob/main/typestate-pattern/src/ex1.rs">here</a>.
Here’s the code for the real
<a href="https://github.com/r3bl-org/r3bl-open-core/blob/main/tui/src/tui/terminal_lib_backends/input_event.rs"><code class="language-plaintext highlighter-rouge">InputEvent</code></a>.</p>
</blockquote>

<p>The main things to note about this code.</p>

<ul>
  <li>We have a bunch of enums that represent different types of input events.</li>
  <li>We have a method on the <code class="language-plaintext highlighter-rouge">InputEvent</code> enum that pretty prints the event for all variants.
We don’t have a way to restrict methods on a specific variant using this approach.</li>
</ul>

<p>When you run this code (using <code class="language-plaintext highlighter-rouge">cargo run --bin ex1</code>), it should produce the following
output:</p>

<pre class="pre-manual-highlight">$ cargo run --bin ex1
Keyboard((Char('a'), None))
Keyboard((Char('c'), Some([Control])))
Enter
Press(Left, 10, 20)
</pre>
      <h3 id="example-2-slightly-more-complex-versions-are-where-one-type--data--another-type">
        
        
          Example 2: Slightly more complex versions are where one type + data = another type <a href="#example-2-slightly-more-complex-versions-are-where-one-type--data--another-type">#</a>
        
        
      </h3>
    
<p><a id="markdown-example-2%3A-slightly-more-complex-versions-are-where-one-type-%2B-data-%3D-another-type" name="example-2%3A-slightly-more-complex-versions-are-where-one-type-%2B-data-%3D-another-type"></a></p>

<p>For this example, let’s add the following code to the <code class="language-plaintext highlighter-rouge">src/ex2.rs</code> file.</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">mod</span> <span class="n">ex1</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">ex1</span><span class="p">::</span><span class="n">InputEvent</span><span class="p">;</span>

<span class="nd">#[derive(Debug)]</span>
<span class="k">pub</span> <span class="k">enum</span> <span class="n">EditorEvent</span> <span class="p">{</span>
    <span class="nf">InsertChar</span><span class="p">(</span><span class="nb">char</span><span class="p">),</span>
    <span class="n">InsertNewLine</span><span class="p">,</span>
    <span class="n">Delete</span><span class="p">,</span>
    <span class="n">Backspace</span><span class="p">,</span>
    <span class="n">MoveCursorLeft</span><span class="p">,</span>
    <span class="n">MoveCursorRight</span><span class="p">,</span>
    <span class="n">MoveCursorUp</span><span class="p">,</span>
    <span class="n">MoveCursorDown</span><span class="p">,</span>
    <span class="nb">Copy</span><span class="p">,</span>
    <span class="n">Paste</span><span class="p">,</span>
    <span class="n">Cut</span><span class="p">,</span>
    <span class="n">Undo</span><span class="p">,</span>
    <span class="n">Redo</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="nb">TryFrom</span><span class="o">&lt;</span><span class="n">InputEvent</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">EditorEvent</span> <span class="p">{</span>
    <span class="k">type</span> <span class="n">Error</span> <span class="o">=</span> <span class="nb">String</span><span class="p">;</span>

    <span class="k">fn</span> <span class="nf">try_from</span><span class="p">(</span><span class="n">input_event</span><span class="p">:</span> <span class="n">InputEvent</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="k">Self</span><span class="p">,</span> <span class="k">Self</span><span class="p">::</span><span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">match</span> <span class="n">input_event</span> <span class="p">{</span>
            <span class="nn">InputEvent</span><span class="p">::</span><span class="nf">Keyboard</span><span class="p">((</span><span class="n">keypress</span><span class="p">,</span> <span class="n">modifiers</span><span class="p">))</span> <span class="k">=&gt;</span>
                <span class="k">match</span> <span class="p">(</span><span class="n">keypress</span><span class="p">,</span> <span class="n">modifiers</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="nf">Char</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span> <span class="nb">None</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nf">Ok</span><span class="p">(</span><span class="k">Self</span><span class="p">::</span><span class="nf">InsertChar</span><span class="p">(</span><span class="n">ch</span><span class="p">)),</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="nf">Char</span><span class="p">(</span><span class="n">_</span><span class="p">),</span> <span class="nf">Some</span><span class="p">(</span><span class="n">_</span><span class="p">))</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="n">Enter</span><span class="p">,</span> <span class="nb">None</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nf">Ok</span><span class="p">(</span><span class="k">Self</span><span class="p">::</span><span class="n">InsertNewLine</span><span class="p">),</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="n">Enter</span><span class="p">,</span> <span class="nf">Some</span><span class="p">(</span><span class="n">_</span><span class="p">))</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="n">Backspace</span><span class="p">,</span> <span class="nb">None</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="n">Backspace</span><span class="p">,</span> <span class="nf">Some</span><span class="p">(</span><span class="n">_</span><span class="p">))</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="n">Delete</span><span class="p">,</span> <span class="nb">None</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="n">Delete</span><span class="p">,</span> <span class="nf">Some</span><span class="p">(</span><span class="n">_</span><span class="p">))</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="n">Left</span><span class="p">,</span> <span class="nb">None</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="n">Left</span><span class="p">,</span> <span class="nf">Some</span><span class="p">(</span><span class="n">_</span><span class="p">))</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="n">Right</span><span class="p">,</span> <span class="nb">None</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="n">Right</span><span class="p">,</span> <span class="nf">Some</span><span class="p">(</span><span class="n">_</span><span class="p">))</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="n">Up</span><span class="p">,</span> <span class="nb">None</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="n">Up</span><span class="p">,</span> <span class="nf">Some</span><span class="p">(</span><span class="n">_</span><span class="p">))</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="n">Down</span><span class="p">,</span> <span class="nb">None</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="n">Down</span><span class="p">,</span> <span class="nf">Some</span><span class="p">(</span><span class="n">_</span><span class="p">))</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="n">Home</span><span class="p">,</span> <span class="nb">None</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="n">Home</span><span class="p">,</span> <span class="nf">Some</span><span class="p">(</span><span class="n">_</span><span class="p">))</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="n">End</span><span class="p">,</span> <span class="nb">None</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="n">End</span><span class="p">,</span> <span class="nf">Some</span><span class="p">(</span><span class="n">_</span><span class="p">))</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="n">PageUp</span><span class="p">,</span> <span class="nb">None</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="n">PageUp</span><span class="p">,</span> <span class="nf">Some</span><span class="p">(</span><span class="n">_</span><span class="p">))</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="n">PageDown</span><span class="p">,</span> <span class="nb">None</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="n">PageDown</span><span class="p">,</span> <span class="nf">Some</span><span class="p">(</span><span class="n">_</span><span class="p">))</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="n">Tab</span><span class="p">,</span> <span class="nb">None</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="n">Tab</span><span class="p">,</span> <span class="nf">Some</span><span class="p">(</span><span class="n">_</span><span class="p">))</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="nf">F</span><span class="p">(</span><span class="n">_</span><span class="p">),</span> <span class="nb">None</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
                <span class="p">(</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="nf">F</span><span class="p">(</span><span class="n">_</span><span class="p">),</span> <span class="nf">Some</span><span class="p">(</span><span class="n">_</span><span class="p">))</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
            <span class="p">},</span>
            <span class="nn">InputEvent</span><span class="p">::</span><span class="nf">Resize</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
            <span class="nn">InputEvent</span><span class="p">::</span><span class="nf">Mouse</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nd">todo!</span><span class="p">(),</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">a_pressed</span> <span class="o">=</span> <span class="nn">InputEvent</span><span class="p">::</span><span class="nf">Keyboard</span><span class="p">((</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="nf">Char</span><span class="p">(</span><span class="sc">'a'</span><span class="p">),</span> <span class="nb">None</span><span class="p">));</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span> <span class="nn">EditorEvent</span><span class="p">::</span><span class="nf">try_from</span><span class="p">(</span><span class="n">a_pressed</span><span class="p">));</span>

    <span class="k">let</span> <span class="n">enter_pressed</span> <span class="o">=</span> <span class="nn">InputEvent</span><span class="p">::</span><span class="nf">Keyboard</span><span class="p">((</span><span class="nn">ex1</span><span class="p">::</span><span class="nn">KeyPress</span><span class="p">::</span><span class="n">Enter</span><span class="p">,</span> <span class="nb">None</span><span class="p">));</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span> <span class="nn">EditorEvent</span><span class="p">::</span><span class="nf">try_from</span><span class="p">(</span><span class="n">enter_pressed</span><span class="p">));</span>
<span class="p">}</span>

</code></pre></div></div>

<blockquote>
  <p>You can get the source code for this example
<a href="https://github.com/nazmulidris/rust-scratch/blob/main/typestate-pattern/src/ex2.rs">here</a>.
Here’s the code for the real
<a href="https://github.com/r3bl-org/r3bl-open-core/blob/main/tui/src/tui/editor/editor_component/editor_event.rs#L74"><code class="language-plaintext highlighter-rouge">EditorEvent</code></a>.</p>
</blockquote>

<p>Here are some notes on this code:</p>

<ul>
  <li>We have a new enum called <code class="language-plaintext highlighter-rouge">EditorEvent</code> that represents different types of events that
can happen in an editor.</li>
  <li>We have a <code class="language-plaintext highlighter-rouge">TryFrom</code> implementation for <code class="language-plaintext highlighter-rouge">InputEvent</code> that converts an <code class="language-plaintext highlighter-rouge">InputEvent</code> into
an <code class="language-plaintext highlighter-rouge">EditorEvent</code>. This is a way to restrict methods to specific variants of an enum by
converting it into a totally different type.</li>
  <li>We still don’t have a way to restrict methods to specific variants of the enum.</li>
</ul>

<p>When you run this code (using <code class="language-plaintext highlighter-rouge">cargo run --bin ex2</code>), it should produce the following:</p>

<pre class="pre-manual-highlight">$ cargo run --bin ex2
Ok(InsertChar('a'))
Ok(InsertNewLine)
</pre>
      <h3 id="example-3-best-of-both-worlds-using-generics-and-struct--enum-with-a-marker-trait">
        
        
          Example 3: Best of both worlds, using generics and struct / enum with a marker trait <a href="#example-3-best-of-both-worlds-using-generics-and-struct--enum-with-a-marker-trait">#</a>
        
        
      </h3>
    
<p><a id="markdown-example-3%3A-best-of-both-worlds%2C-using-generics-and-struct-%2F-enum-with-a-marker-trait" name="example-3%3A-best-of-both-worlds%2C-using-generics-and-struct-%2F-enum-with-a-marker-trait"></a></p>

<p>Finally we have arrived at the typestate pattern in Rust. With this example:</p>
<ul>
  <li>You can now group all the states under a marker.</li>
  <li>You can have methods that are specific to a variant.</li>
  <li>You can specify methods that are common to all.</li>
  <li>It’s like a very sophisticated builder pattern if you’re already familiar with that.</li>
</ul>

<p>Add the following code to the <code class="language-plaintext highlighter-rouge">src/ex3.rs</code> file.</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="k">self</span><span class="p">::</span><span class="nn">type_state_builder</span><span class="p">::</span><span class="n">HttpResponse</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">crossterm</span><span class="p">::</span><span class="nn">style</span><span class="p">::</span><span class="n">Stylize</span><span class="p">;</span>

<span class="k">pub</span> <span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="nb">String</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">response</span> <span class="o">=</span> <span class="nn">HttpResponse</span><span class="p">::</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="s">"Start state"</span><span class="nf">.red</span><span class="p">()</span><span class="nf">.bold</span><span class="p">()</span><span class="nf">.underlined</span><span class="p">());</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"response: {:#?}"</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span>
        <span class="s">"response size: {}"</span><span class="p">,</span>
        <span class="n">response</span><span class="nf">.get_size</span><span class="p">()</span><span class="nf">.to_string</span><span class="p">()</span><span class="nf">.blue</span><span class="p">()</span><span class="nf">.bold</span><span class="p">()</span>
    <span class="p">);</span>

    <span class="c1">// Transition to HeaderAndBody state by calling `set_status_line`.</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="nf">.set_status_line</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s">"OK"</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"response: {:#?}"</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>

    <span class="c1">// Status line is required.</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="s">"HeaderAndBody state"</span><span class="nf">.red</span><span class="p">()</span><span class="nf">.bold</span><span class="p">()</span><span class="nf">.underlined</span><span class="p">());</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"response_code: {}"</span><span class="p">,</span> <span class="n">response</span><span class="nf">.get_response_code</span><span class="p">());</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"response body: {:#?}"</span><span class="p">,</span> <span class="n">response</span><span class="nf">.get_body</span><span class="p">());</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"response: {:#?}"</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span>
        <span class="s">"response size: {}"</span><span class="p">,</span>
        <span class="n">response</span><span class="nf">.get_size</span><span class="p">()</span><span class="nf">.to_string</span><span class="p">()</span><span class="nf">.blue</span><span class="p">()</span><span class="nf">.bold</span><span class="p">()</span>
    <span class="p">);</span>

    <span class="c1">// Body and headers are optional.</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="s">"HeaderAndBody state # 2"</span><span class="nf">.red</span><span class="p">()</span><span class="nf">.bold</span><span class="p">()</span><span class="nf">.underlined</span><span class="p">());</span>
    <span class="n">response</span><span class="nf">.add_header</span><span class="p">(</span><span class="s">"Content-Type"</span><span class="p">,</span> <span class="s">"text/html"</span><span class="p">);</span>
    <span class="n">response</span><span class="nf">.set_body</span><span class="p">(</span><span class="s">"&lt;html&gt;&lt;body&gt;Hello World!&lt;/body&gt;&lt;/html&gt;"</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"response: {:#?}"</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span>
        <span class="s">"response size: {}"</span><span class="p">,</span>
        <span class="n">response</span><span class="nf">.get_size</span><span class="p">()</span><span class="nf">.to_string</span><span class="p">()</span><span class="nf">.blue</span><span class="p">()</span><span class="nf">.bold</span><span class="p">()</span>
    <span class="p">);</span>

    <span class="c1">// Final state.</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="s">"Final state"</span><span class="nf">.red</span><span class="p">()</span><span class="nf">.bold</span><span class="p">()</span><span class="nf">.underlined</span><span class="p">());</span>
    <span class="k">let</span> <span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="nf">.finish</span><span class="p">();</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"response_code: {}"</span><span class="p">,</span> <span class="n">response</span><span class="nf">.get_response_code</span><span class="p">());</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"status_line: {}"</span><span class="p">,</span> <span class="n">response</span><span class="nf">.get_status_line</span><span class="p">());</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"headers: {:#?}"</span><span class="p">,</span> <span class="n">response</span><span class="nf">.get_headers</span><span class="p">());</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"body: {}"</span><span class="p">,</span> <span class="n">response</span><span class="nf">.get_body</span><span class="p">());</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"response: {:#?}"</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span>
        <span class="s">"response size: {}"</span><span class="p">,</span>
        <span class="n">response</span><span class="nf">.get_size</span><span class="p">()</span><span class="nf">.to_string</span><span class="p">()</span><span class="nf">.blue</span><span class="p">()</span><span class="nf">.bold</span><span class="p">()</span>
    <span class="p">);</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Note the API that we have built here:</p>
<ul>
  <li>You can’t call <code class="language-plaintext highlighter-rouge">get_response_code</code> or <code class="language-plaintext highlighter-rouge">get_body</code> until you’ve called <code class="language-plaintext highlighter-rouge">set_status_line</code>.</li>
  <li>You can’t call <code class="language-plaintext highlighter-rouge">add_header</code> or <code class="language-plaintext highlighter-rouge">set_body</code> until you’ve called <code class="language-plaintext highlighter-rouge">set_status_line</code>.</li>
  <li>You can’t call <code class="language-plaintext highlighter-rouge">finish</code> until you’ve called <code class="language-plaintext highlighter-rouge">set_status_line</code>.</li>
  <li>We have 3 states: <code class="language-plaintext highlighter-rouge">Start</code>, <code class="language-plaintext highlighter-rouge">HeaderAndBody</code>, and <code class="language-plaintext highlighter-rouge">Final</code>. These are meant to be used as
markers to restrict methods to specific states. Each is a struct with a marker trait.
And it may or may not contain data / fields.</li>
  <li>We have a <code class="language-plaintext highlighter-rouge">HttpResponse</code> struct that uses a generic type <code class="language-plaintext highlighter-rouge">T: Marker</code> to represent the
state. This is a way to restrict methods to specific states.</li>
  <li>We can transition between states by calling methods that consume the current state and
return a new state. These methods are specific to the state they transition from. And
they can be implemented via <code class="language-plaintext highlighter-rouge">impl HttpResponse&lt;T: Marker&gt; { ... }</code> blocks, where <code class="language-plaintext highlighter-rouge">T</code> is
the <code class="language-plaintext highlighter-rouge">Start</code>, <code class="language-plaintext highlighter-rouge">HeaderAndBody</code>, or <code class="language-plaintext highlighter-rouge">Final</code> state.</li>
  <li>We can even implement methods that are valid for a non-existent state using <code class="language-plaintext highlighter-rouge">impl
HttpResponse&lt;()&gt; { ... }</code>. This is the constructor.</li>
  <li>In the <code class="language-plaintext highlighter-rouge">Final</code> state, the data becomes immutable.</li>
</ul>

<p>Add the following code to desribe the different state structs.</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">mod</span> <span class="n">state</span> <span class="p">{</span>
    <span class="nd">#[derive(Debug,</span> <span class="nd">Clone,</span> <span class="nd">Default)]</span>
    <span class="k">pub</span> <span class="k">struct</span> <span class="n">Start</span> <span class="p">{}</span>

    <span class="nd">#[derive(Debug,</span> <span class="nd">Clone,</span> <span class="nd">Default)]</span>
    <span class="k">pub</span> <span class="k">struct</span> <span class="n">HeaderAndBody</span> <span class="p">{</span>
        <span class="k">pub</span> <span class="n">response_code</span><span class="p">:</span> <span class="nb">u8</span><span class="p">,</span>
        <span class="k">pub</span> <span class="n">status_line</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
        <span class="k">pub</span> <span class="n">headers</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="p">(</span><span class="nb">String</span><span class="p">,</span> <span class="nb">String</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="p">,</span>
        <span class="k">pub</span> <span class="n">body</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nd">#[derive(Debug,</span> <span class="nd">Clone,</span> <span class="nd">Default)]</span>
    <span class="k">pub</span> <span class="k">struct</span> <span class="n">Final</span> <span class="p">{</span>
        <span class="k">pub</span> <span class="n">response_code</span><span class="p">:</span> <span class="nb">u8</span><span class="p">,</span>
        <span class="k">pub</span> <span class="n">status_line</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
        <span class="k">pub</span> <span class="n">headers</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="p">(</span><span class="nb">String</span><span class="p">,</span> <span class="nb">String</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="k">pub</span> <span class="n">body</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1">// The following marker trait is used to restrict the operations</span>
    <span class="c1">// that are available in each state. This isn't strictly necessary,</span>
    <span class="c1">// but it's a nice thing to use in a where clause to restrict types.</span>
    <span class="k">pub</span> <span class="k">trait</span> <span class="n">Marker</span> <span class="p">{}</span>
    <span class="k">impl</span> <span class="n">Marker</span> <span class="k">for</span> <span class="p">()</span> <span class="p">{}</span>
    <span class="k">impl</span> <span class="n">Marker</span> <span class="k">for</span> <span class="n">Start</span> <span class="p">{}</span>
    <span class="k">impl</span> <span class="n">Marker</span> <span class="k">for</span> <span class="n">HeaderAndBody</span> <span class="p">{}</span>
    <span class="k">impl</span> <span class="n">Marker</span> <span class="k">for</span> <span class="n">Final</span> <span class="p">{}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here is the code for the <code class="language-plaintext highlighter-rouge">HttpResponse</code> struct.</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">mod</span> <span class="n">type_state_builder</span> <span class="p">{</span>
    <span class="k">use</span> <span class="k">super</span><span class="p">::</span><span class="nn">state</span><span class="p">::{</span><span class="n">Final</span><span class="p">,</span> <span class="n">HeaderAndBody</span><span class="p">,</span> <span class="n">Marker</span><span class="p">,</span> <span class="n">Start</span><span class="p">};</span>

    <span class="nd">#[derive(Debug,</span> <span class="nd">Clone,</span> <span class="nd">Default)]</span>
    <span class="k">pub</span> <span class="k">struct</span> <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">S</span><span class="p">:</span> <span class="n">Marker</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">pub</span> <span class="n">state</span><span class="p">:</span> <span class="n">S</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1">// Operations that are available in all states.</span>
    <span class="k">impl</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span> <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span>
    <span class="k">where</span>
        <span class="n">S</span><span class="p">:</span> <span class="n">Marker</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">get_size</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">String</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="nn">std</span><span class="p">::</span><span class="nn">mem</span><span class="p">::</span><span class="nf">size_of_val</span><span class="p">(</span><span class="k">self</span><span class="p">);</span>
            <span class="nd">format!</span><span class="p">(</span><span class="s">"{} bytes"</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Operations that are only valid in `()`.</span>
    <span class="k">impl</span> <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">new</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">Start</span><span class="o">&gt;</span> <span class="p">{</span>
            <span class="n">HttpResponse</span> <span class="p">{</span> <span class="n">state</span><span class="p">:</span> <span class="n">Start</span> <span class="p">{}</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Operations that are only valid in `Start`.</span>
    <span class="k">impl</span> <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">Start</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">set_status_line</span><span class="p">(</span>
            <span class="k">self</span><span class="p">,</span>
            <span class="n">response_code</span><span class="p">:</span> <span class="nb">u8</span><span class="p">,</span>
            <span class="n">message</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">-&gt;</span> <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">HeaderAndBody</span><span class="o">&gt;</span> <span class="p">{</span>
            <span class="n">HttpResponse</span> <span class="p">{</span>
                <span class="n">state</span><span class="p">:</span> <span class="n">HeaderAndBody</span> <span class="p">{</span>
                    <span class="n">response_code</span><span class="p">,</span>
                    <span class="n">status_line</span><span class="p">:</span> <span class="nd">format!</span><span class="p">(</span>
                        <span class="s">"HTTP/1.1 {} {}"</span><span class="p">,</span> <span class="n">response_code</span><span class="p">,</span> <span class="n">message</span>
                    <span class="p">),</span>
                    <span class="o">..</span><span class="nn">Default</span><span class="p">::</span><span class="nf">default</span><span class="p">()</span>
                <span class="p">},</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Operations that are only valid in `HeaderAndBodyState`.</span>
    <span class="k">impl</span> <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">HeaderAndBody</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="c1">// setter.</span>
        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">add_header</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">self</span><span class="py">.state.headers</span><span class="nf">.is_none</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">self</span><span class="py">.state.headers</span><span class="nf">.replace</span><span class="p">(</span><span class="nn">Vec</span><span class="p">::</span><span class="nf">new</span><span class="p">());</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nf">Some</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="k">self</span><span class="py">.state.headers</span><span class="nf">.as_mut</span><span class="p">()</span> <span class="p">{</span>
                <span class="n">v</span><span class="nf">.push</span><span class="p">((</span><span class="n">key</span><span class="nf">.to_string</span><span class="p">(),</span> <span class="n">value</span><span class="nf">.to_string</span><span class="p">()))</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// getter.</span>
        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">get_response_code</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">u8</span> <span class="p">{</span>
            <span class="k">self</span><span class="py">.state.response_code</span>
        <span class="p">}</span>

        <span class="c1">// setter.</span>
        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">set_body</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">self</span><span class="py">.state.body</span><span class="nf">.replace</span><span class="p">(</span><span class="n">body</span><span class="nf">.to_string</span><span class="p">());</span>
        <span class="p">}</span>

        <span class="c1">// getter.</span>
        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">get_body</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="nb">str</span><span class="o">&gt;</span> <span class="p">{</span>
            <span class="k">self</span><span class="py">.state.body</span><span class="nf">.as_deref</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1">// transition to Final state.</span>
        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">finish</span><span class="p">(</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">Final</span><span class="o">&gt;</span> <span class="p">{</span>
            <span class="n">HttpResponse</span> <span class="p">{</span>
                <span class="n">state</span><span class="p">:</span> <span class="n">Final</span> <span class="p">{</span>
                    <span class="n">response_code</span><span class="p">:</span> <span class="k">self</span><span class="py">.state.response_code</span><span class="p">,</span>
                    <span class="n">status_line</span><span class="p">:</span> <span class="k">self</span><span class="py">.state.status_line</span><span class="nf">.clone</span><span class="p">(),</span>
                    <span class="n">headers</span><span class="p">:</span> <span class="k">self</span><span class="py">.state.headers</span><span class="nf">.take</span><span class="p">()</span><span class="nf">.unwrap_or_default</span><span class="p">(),</span>
                    <span class="n">body</span><span class="p">:</span> <span class="k">self</span><span class="py">.state.body</span><span class="nf">.take</span><span class="p">()</span><span class="nf">.unwrap_or_default</span><span class="p">(),</span>
                <span class="p">},</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Operations that are only valid in `Final`.</span>
    <span class="k">impl</span> <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">Final</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="c1">// getter.</span>
        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">get_headers</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="p">(</span><span class="nb">String</span><span class="p">,</span> <span class="nb">String</span><span class="p">)</span><span class="o">&gt;</span> <span class="p">{</span>
            <span class="o">&amp;</span><span class="k">self</span><span class="py">.state.headers</span>
        <span class="p">}</span>

        <span class="c1">// getter.</span>
        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">get_body</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="nb">str</span> <span class="p">{</span>
            <span class="o">&amp;</span><span class="k">self</span><span class="py">.state.body</span>
        <span class="p">}</span>

        <span class="c1">// getter.</span>
        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">get_response_code</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">u8</span> <span class="p">{</span>
            <span class="k">self</span><span class="py">.state.response_code</span>
        <span class="p">}</span>

        <span class="c1">// getter.</span>
        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">get_status_line</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="nb">str</span> <span class="p">{</span>
            <span class="o">&amp;</span><span class="k">self</span><span class="py">.state.status_line</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>When you run the code using <code class="language-plaintext highlighter-rouge">cargo run --bin ex3</code>, it should produce the following output.</p>

<pre class="pre-manual-highlight">$ cargo run --bin ex3
<span style="color:#BF616A"><u style="text-decoration-style:single"><b>Start state</b></u></span>
response: HttpResponse {
    state: Start,
}
response size: <span style="color:#81A1C1"><b>0 bytes</b></span>
response: HttpResponse {
    state: HeaderAndBody {
        response_code: 200,
        status_line: &quot;HTTP/1.1 200 OK&quot;,
        headers: None,
        body: None,
    },
}
<span style="color:#BF616A"><u style="text-decoration-style:single"><b>HeaderAndBody state</b></u></span>
response_code: 200
response body: None
response: HttpResponse {
    state: HeaderAndBody {
        response_code: 200,
        status_line: &quot;HTTP/1.1 200 OK&quot;,
        headers: None,
        body: None,
    },
}
response size: <span style="color:#81A1C1"><b>80 bytes</b></span>
<span style="color:#BF616A"><u style="text-decoration-style:single"><b>HeaderAndBody state # 2</b></u></span>
response: HttpResponse {
    state: HeaderAndBody {
        response_code: 200,
        status_line: &quot;HTTP/1.1 200 OK&quot;,
        headers: Some(
            [
                (
                    &quot;Content-Type&quot;,
                    &quot;text/html&quot;,
                ),
            ],
        ),
        body: Some(
            &quot;&lt;html&gt;&lt;body&gt;Hello World!&lt;/body&gt;&lt;/html&gt;&quot;,
        ),
    },
}
response size: <span style="color:#81A1C1"><b>80 bytes</b></span>
<span style="color:#BF616A"><u style="text-decoration-style:single"><b>Final state</b></u></span>
response_code: 200
status_line: HTTP/1.1 200 OK
headers: [
    (
        &quot;Content-Type&quot;,
        &quot;text/html&quot;,
    ),
]
body: &lt;html&gt;&lt;body&gt;Hello World!&lt;/body&gt;&lt;/html&gt;
response: HttpResponse {
    state: Final {
        response_code: 200,
        status_line: &quot;HTTP/1.1 200 OK&quot;,
        headers: [
            (
                &quot;Content-Type&quot;,
                &quot;text/html&quot;,
            ),
        ],
        body: &quot;&lt;html&gt;&lt;body&gt;Hello World!&lt;/body&gt;&lt;/html&gt;&quot;,
    },
}
response size: <span style="color:#81A1C1"><b>80 bytes</b></span>
</pre>
      <h3 id="example-31-using-enum-and-phantomdata-instead-of-struct">
        
        
          Example 3.1: Using enum and PhantomData instead of struct <a href="#example-31-using-enum-and-phantomdata-instead-of-struct">#</a>
        
        
      </h3>
    

<ul>
  <li>You can use enums instead of structs if you have shared data (inner) that you move with
state transitions.</li>
  <li>And you have to use <code class="language-plaintext highlighter-rouge">PhantomData</code> here.</li>
</ul>

<p>Add the following code to the <code class="language-plaintext highlighter-rouge">src/ex3_1.rs</code> file.</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="k">self</span><span class="p">::</span><span class="nn">type_state_builder</span><span class="p">::</span><span class="n">HttpResponse</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">crossterm</span><span class="p">::</span><span class="nn">style</span><span class="p">::</span><span class="n">Stylize</span><span class="p">;</span>

<span class="k">pub</span> <span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="nb">String</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">response</span> <span class="o">=</span> <span class="nn">HttpResponse</span><span class="p">::</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="s">"Start state"</span><span class="nf">.red</span><span class="p">()</span><span class="nf">.bold</span><span class="p">()</span><span class="nf">.underlined</span><span class="p">());</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"response: {:#?}"</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span>
        <span class="s">"response size: {}"</span><span class="p">,</span>
        <span class="n">response</span><span class="nf">.get_size</span><span class="p">()</span><span class="nf">.to_string</span><span class="p">()</span><span class="nf">.blue</span><span class="p">()</span><span class="nf">.bold</span><span class="p">()</span>
    <span class="p">);</span>

    <span class="c1">// Status line is required.</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="s">"HeaderAndBody state"</span><span class="nf">.red</span><span class="p">()</span><span class="nf">.bold</span><span class="p">()</span><span class="nf">.underlined</span><span class="p">());</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="nf">.set_status_line</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s">"OK"</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"response_code: {}"</span><span class="p">,</span> <span class="n">response</span><span class="nf">.get_response_code</span><span class="p">());</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"response body: {:#?}"</span><span class="p">,</span> <span class="n">response</span><span class="nf">.get_body</span><span class="p">());</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"response: {:#?}"</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span>
        <span class="s">"response size: {}"</span><span class="p">,</span>
        <span class="n">response</span><span class="nf">.get_size</span><span class="p">()</span><span class="nf">.to_string</span><span class="p">()</span><span class="nf">.blue</span><span class="p">()</span><span class="nf">.bold</span><span class="p">()</span>
    <span class="p">);</span>

    <span class="c1">// Body and headers are optional.</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="s">"HeaderAndBody state # 2"</span><span class="nf">.red</span><span class="p">()</span><span class="nf">.bold</span><span class="p">()</span><span class="nf">.underlined</span><span class="p">());</span>
    <span class="n">response</span><span class="nf">.add_header</span><span class="p">(</span><span class="s">"Content-Type"</span><span class="p">,</span> <span class="s">"text/html"</span><span class="p">);</span>
    <span class="n">response</span><span class="nf">.set_body</span><span class="p">(</span><span class="s">"&lt;html&gt;&lt;body&gt;Hello World!&lt;/body&gt;&lt;/html&gt;"</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"response: {:#?}"</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span>
        <span class="s">"response size: {}"</span><span class="p">,</span>
        <span class="n">response</span><span class="nf">.get_size</span><span class="p">()</span><span class="nf">.to_string</span><span class="p">()</span><span class="nf">.blue</span><span class="p">()</span><span class="nf">.bold</span><span class="p">()</span>
    <span class="p">);</span>

    <span class="c1">// Final state.</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="s">"Final state"</span><span class="nf">.red</span><span class="p">()</span><span class="nf">.bold</span><span class="p">()</span><span class="nf">.underlined</span><span class="p">());</span>
    <span class="k">let</span> <span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="nf">.finish</span><span class="p">();</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"response_code: {}"</span><span class="p">,</span> <span class="n">response</span><span class="nf">.get_response_code</span><span class="p">());</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"status_line: {}"</span><span class="p">,</span> <span class="n">response</span><span class="nf">.get_status_line</span><span class="p">());</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"headers: {:#?}"</span><span class="p">,</span> <span class="n">response</span><span class="nf">.get_headers</span><span class="p">());</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"body: {:#?}"</span><span class="p">,</span> <span class="n">response</span><span class="nf">.get_body</span><span class="p">());</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"response: {:#?}"</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span>
        <span class="s">"response size: {}"</span><span class="p">,</span>
        <span class="n">response</span><span class="nf">.get_size</span><span class="p">()</span><span class="nf">.to_string</span><span class="p">()</span><span class="nf">.blue</span><span class="p">()</span><span class="nf">.bold</span><span class="p">()</span>
    <span class="p">);</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Note that this <code class="language-plaintext highlighter-rouge">main</code> function is the same as the one in the previous example.</p>

<p>The following code will be different. We are adding a new <code class="language-plaintext highlighter-rouge">data</code> module.</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">mod</span> <span class="n">data</span> <span class="p">{</span>
    <span class="nd">#[derive(Debug,</span> <span class="nd">Clone,</span> <span class="nd">Default)]</span>
    <span class="k">pub</span> <span class="k">struct</span> <span class="n">HttpResponseData</span> <span class="p">{</span>
        <span class="k">pub</span> <span class="n">response_code</span><span class="p">:</span> <span class="nb">u8</span><span class="p">,</span>
        <span class="k">pub</span> <span class="n">status_line</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
        <span class="k">pub</span> <span class="n">headers</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="p">(</span><span class="nb">String</span><span class="p">,</span> <span class="nb">String</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="p">,</span>
        <span class="k">pub</span> <span class="n">body</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here’s the new <code class="language-plaintext highlighter-rouge">state</code> module. Note the use of enums and <code class="language-plaintext highlighter-rouge">PhantomData</code> instead of structs.</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">mod</span> <span class="n">state</span> <span class="p">{</span>
    <span class="nd">#[derive(Debug,</span> <span class="nd">Clone)]</span>
    <span class="k">pub</span> <span class="k">enum</span> <span class="n">Start</span> <span class="p">{}</span>

    <span class="nd">#[derive(Debug,</span> <span class="nd">Clone)]</span>
    <span class="k">pub</span> <span class="k">enum</span> <span class="n">HeaderAndBody</span> <span class="p">{}</span>

    <span class="nd">#[derive(Debug,</span> <span class="nd">Clone)]</span>
    <span class="k">pub</span> <span class="k">struct</span> <span class="n">Final</span> <span class="p">{}</span>

    <span class="c1">// The following marker trait is used to restrict the operations</span>
    <span class="c1">// that are available in each state. This isn't strictly necessary,</span>
    <span class="c1">// but it's a nice thing to use in a where clause to restrict types.</span>
    <span class="k">pub</span> <span class="k">trait</span> <span class="n">Marker</span> <span class="p">{}</span>
    <span class="k">impl</span> <span class="n">Marker</span> <span class="k">for</span> <span class="p">()</span> <span class="p">{}</span>
    <span class="k">impl</span> <span class="n">Marker</span> <span class="k">for</span> <span class="n">Start</span> <span class="p">{}</span>
    <span class="k">impl</span> <span class="n">Marker</span> <span class="k">for</span> <span class="n">HeaderAndBody</span> <span class="p">{}</span>
    <span class="k">impl</span> <span class="n">Marker</span> <span class="k">for</span> <span class="n">Final</span> <span class="p">{}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here is the changed code for the <code class="language-plaintext highlighter-rouge">HttpResponse</code> struct.</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">mod</span> <span class="n">type_state_builder</span> <span class="p">{</span>
    <span class="k">use</span> <span class="k">super</span><span class="p">::{</span>
        <span class="nn">data</span><span class="p">::</span><span class="n">HttpResponseData</span><span class="p">,</span>
        <span class="nn">state</span><span class="p">::{</span><span class="n">Final</span><span class="p">,</span> <span class="n">HeaderAndBody</span><span class="p">,</span> <span class="n">Marker</span><span class="p">,</span> <span class="n">Start</span><span class="p">},</span>
    <span class="p">};</span>
    <span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">marker</span><span class="p">::</span><span class="n">PhantomData</span><span class="p">;</span>

    <span class="nd">#[derive(Debug,</span> <span class="nd">Clone)]</span>
    <span class="k">pub</span> <span class="k">struct</span> <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">S</span><span class="p">:</span> <span class="n">Marker</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">pub</span> <span class="n">data</span><span class="p">:</span> <span class="n">HttpResponseData</span><span class="p">,</span>
        <span class="k">pub</span> <span class="n">state</span><span class="p">:</span> <span class="n">PhantomData</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1">// Operations that are only valid in ().</span>
    <span class="k">impl</span> <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">new</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">Start</span><span class="o">&gt;</span> <span class="p">{</span>
            <span class="n">HttpResponse</span> <span class="p">{</span>
                <span class="n">data</span><span class="p">:</span> <span class="nn">HttpResponseData</span><span class="p">::</span><span class="nf">default</span><span class="p">(),</span>
                <span class="n">state</span><span class="p">:</span> <span class="nn">PhantomData</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Start</span><span class="o">&gt;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Operations that are only valid in Start.</span>
    <span class="k">impl</span> <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">Start</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="c1">// setter.</span>
        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">set_status_line</span><span class="p">(</span>
            <span class="k">self</span><span class="p">,</span>
            <span class="n">response_code</span><span class="p">:</span> <span class="nb">u8</span><span class="p">,</span>
            <span class="n">message</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">-&gt;</span> <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">HeaderAndBody</span><span class="o">&gt;</span> <span class="p">{</span>
            <span class="n">HttpResponse</span> <span class="p">{</span>
                <span class="n">data</span><span class="p">:</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="k">mut</span> <span class="n">data</span> <span class="o">=</span> <span class="k">self</span><span class="py">.data</span><span class="p">;</span>
                    <span class="n">data</span><span class="py">.response_code</span> <span class="o">=</span> <span class="n">response_code</span><span class="p">;</span>
                    <span class="n">data</span><span class="py">.status_line</span> <span class="o">=</span> <span class="nd">format!</span><span class="p">(</span>
                        <span class="s">"HTTP/1.1 {} {}"</span><span class="p">,</span> <span class="n">response_code</span><span class="p">,</span> <span class="n">message</span>
                    <span class="p">);</span>
                    <span class="n">data</span>
                <span class="p">},</span>
                <span class="n">state</span><span class="p">:</span> <span class="nn">PhantomData</span><span class="p">::</span><span class="o">&lt;</span><span class="n">HeaderAndBody</span><span class="o">&gt;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Operations that are only valid in HeaderAndBodyState.</span>
    <span class="k">impl</span> <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">HeaderAndBody</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="c1">// setter.</span>
        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">add_header</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">mut_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="py">.data</span><span class="p">;</span>
            <span class="k">if</span> <span class="n">mut_data</span><span class="py">.headers</span><span class="nf">.is_none</span><span class="p">()</span> <span class="p">{</span>
                <span class="n">mut_data</span><span class="py">.headers</span><span class="nf">.replace</span><span class="p">(</span><span class="nn">Vec</span><span class="p">::</span><span class="nf">new</span><span class="p">());</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nf">Some</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span> <span class="o">=</span> <span class="n">mut_data</span><span class="py">.headers</span><span class="nf">.as_mut</span><span class="p">()</span> <span class="p">{</span>
                <span class="n">headers</span><span class="nf">.push</span><span class="p">((</span><span class="n">key</span><span class="nf">.to_string</span><span class="p">(),</span> <span class="n">value</span><span class="nf">.to_string</span><span class="p">()))</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// getter.</span>
        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">get_response_code</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">u8</span> <span class="p">{</span>
            <span class="k">self</span><span class="py">.data.response_code</span>
        <span class="p">}</span>

        <span class="c1">// setter.</span>
        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">set_body</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">self</span><span class="py">.data.body</span><span class="nf">.replace</span><span class="p">(</span><span class="n">body</span><span class="nf">.to_string</span><span class="p">());</span>
        <span class="p">}</span>

        <span class="c1">// getter.</span>
        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">get_body</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="nb">str</span><span class="o">&gt;</span> <span class="p">{</span>
            <span class="k">self</span><span class="py">.data.body</span><span class="nf">.as_deref</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1">// transition to Final state.</span>
        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">finish</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">Final</span><span class="o">&gt;</span> <span class="p">{</span>
            <span class="k">let</span> <span class="k">mut</span> <span class="n">data</span> <span class="o">=</span> <span class="k">self</span><span class="py">.data</span><span class="p">;</span>
            <span class="n">HttpResponse</span> <span class="p">{</span>
                <span class="n">data</span><span class="p">:</span> <span class="n">HttpResponseData</span> <span class="p">{</span>
                    <span class="n">response_code</span><span class="p">:</span> <span class="n">data</span><span class="py">.response_code</span><span class="p">,</span>
                    <span class="n">status_line</span><span class="p">:</span> <span class="n">data</span><span class="py">.status_line</span><span class="nf">.clone</span><span class="p">(),</span>
                    <span class="n">headers</span><span class="p">:</span> <span class="nf">Some</span><span class="p">(</span><span class="n">data</span><span class="py">.headers</span><span class="nf">.take</span><span class="p">()</span><span class="nf">.unwrap_or_default</span><span class="p">()),</span>
                    <span class="n">body</span><span class="p">:</span> <span class="nf">Some</span><span class="p">(</span><span class="n">data</span><span class="py">.body</span><span class="nf">.take</span><span class="p">()</span><span class="nf">.unwrap_or_default</span><span class="p">()),</span>
                <span class="p">},</span>
                <span class="n">state</span><span class="p">:</span> <span class="nn">PhantomData</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Final</span><span class="o">&gt;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Operations that are only valid in FinalState.</span>
    <span class="k">impl</span> <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">Final</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">get_headers</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="p">(</span><span class="nb">String</span><span class="p">,</span> <span class="nb">String</span><span class="p">)</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
            <span class="o">&amp;</span><span class="k">self</span><span class="py">.data.headers</span>
        <span class="p">}</span>

        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">get_body</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span> <span class="p">{</span>
            <span class="o">&amp;</span><span class="k">self</span><span class="py">.data.body</span>
        <span class="p">}</span>

        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">get_response_code</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">u8</span> <span class="p">{</span>
            <span class="k">self</span><span class="py">.data.response_code</span>
        <span class="p">}</span>

        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">get_status_line</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="nb">str</span> <span class="p">{</span>
            <span class="o">&amp;</span><span class="k">self</span><span class="py">.data.status_line</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Operations that are available in all states.</span>
    <span class="k">impl</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span> <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span>
    <span class="k">where</span>
        <span class="n">S</span><span class="p">:</span> <span class="n">Marker</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">get_size</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">String</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="nn">std</span><span class="p">::</span><span class="nn">mem</span><span class="p">::</span><span class="nf">size_of_val</span><span class="p">(</span><span class="k">self</span><span class="p">);</span>
            <span class="nd">format!</span><span class="p">(</span><span class="s">"{} bytes"</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here’s the output when you run the code using <code class="language-plaintext highlighter-rouge">cargo run --bin ex3_1</code>.</p>

<pre class="pre-manual-highlight">$ cargo run --bin ex3_1
<span style="color:#BF616A"><u style="text-decoration-style:single"><b>Start state</b></u></span>
response: HttpResponse {
    data: HttpResponseData {
        response_code: 0,
        status_line: &quot;&quot;,
        headers: None,
        body: None,
    },
    state: PhantomData&lt;ex3_1::state::Start&gt;,
}
response size: <span style="color:#81A1C1"><b>80 bytes</b></span>
<span style="color:#BF616A"><u style="text-decoration-style:single"><b>HeaderAndBody state</b></u></span>
response_code: 200
response body: None
response: HttpResponse {
    data: HttpResponseData {
        response_code: 200,
        status_line: &quot;HTTP/1.1 200 OK&quot;,
        headers: None,
        body: None,
    },
    state: PhantomData&lt;ex3_1::state::HeaderAndBody&gt;,
}
response size: <span style="color:#81A1C1"><b>80 bytes</b></span>
<span style="color:#BF616A"><u style="text-decoration-style:single"><b>HeaderAndBody state # 2</b></u></span>
response: HttpResponse {
    data: HttpResponseData {
        response_code: 200,
        status_line: &quot;HTTP/1.1 200 OK&quot;,
        headers: Some(
            [
                (
                    &quot;Content-Type&quot;,
                    &quot;text/html&quot;,
                ),
            ],
        ),
        body: Some(
            &quot;&lt;html&gt;&lt;body&gt;Hello World!&lt;/body&gt;&lt;/html&gt;&quot;,
        ),
    },
    state: PhantomData&lt;ex3_1::state::HeaderAndBody&gt;,
}
response size: <span style="color:#81A1C1"><b>80 bytes</b></span>
<span style="color:#BF616A"><u style="text-decoration-style:single"><b>Final state</b></u></span>
response_code: 200
status_line: HTTP/1.1 200 OK
headers: Some(
    [
        (
            &quot;Content-Type&quot;,
            &quot;text/html&quot;,
        ),
    ],
)
body: Some(
    &quot;&lt;html&gt;&lt;body&gt;Hello World!&lt;/body&gt;&lt;/html&gt;&quot;,
)
response: HttpResponse {
    data: HttpResponseData {
        response_code: 200,
        status_line: &quot;HTTP/1.1 200 OK&quot;,
        headers: Some(
            [
                (
                    &quot;Content-Type&quot;,
                    &quot;text/html&quot;,
                ),
            ],
        ),
        body: Some(
            &quot;&lt;html&gt;&lt;body&gt;Hello World!&lt;/body&gt;&lt;/html&gt;&quot;,
        ),
    },
    state: PhantomData&lt;ex3_1::state::Final&gt;,
}
response size: <span style="color:#81A1C1"><b>80 bytes</b></span>
</pre>
      <h3 id="parting-thoughts">
        
        
          Parting thoughts <a href="#parting-thoughts">#</a>
        
        
      </h3>
    
<p><a id="markdown-parting-thoughts" name="parting-thoughts"></a></p>

<p>To get an experiential understanding of the typestate pattern, you should try to build
something using it. It’s a powerful pattern that can help you write more robust and
predictable code. And it’s a great way to leverage Rust’s type system to enforce state
transitions in your code. I encourage you to clone the repo and run the code to see how it
works. And make changes to it to see if you can make it behave differently and use it in
your own projects.</p>
      <h2 id="build-with-naz-video-series-on-developerlifecom-youtube-channel">
        
        
          Build with Naz video series on developerlife.com YouTube channel <a href="#build-with-naz-video-series-on-developerlifecom-youtube-channel">#</a>
        
        
      </h2>
    
<p><a id="markdown-build-with-naz-video-series-on-developerlife.com-youtube-channel" name="build-with-naz-video-series-on-developerlife.com-youtube-channel"></a></p>

<p>You can watch a video series on building this crate with Naz on the
<a href="https://www.youtube.com/@developerlifecom">developerlife.com YouTube channel</a>.</p>

<ul>
  <li><a href="https://www.youtube.com/@developerlifecom">YT channel</a></li>
  <li>Playlists
    <ul>
      <li><a href="https://www.youtube.com/playlist?list=PLofhE49PEwmza94sS7UmJnN9gSCHTVTfz">Build with Naz, fundamental effective Rust</a></li>
      <li><a href="https://www.youtube.com/playlist?list=PLofhE49PEwmwO69E7eiQ-ewnMME8ydgQ5">Build with Naz, effective async Rust and tokio</a></li>
      <li><a href="https://www.youtube.com/watch?v=3vQJguti02I&amp;list=PLofhE49PEwmwelPkhfiqdFQ9IXnmGdnSE">Build with Naz, async readline and spinner for CLI in Rust</a></li>
      <li><a href="https://www.youtube.com/watch?v=Xt495QLrFFk&amp;list=PLofhE49PEwmwLR_4Noa0dFOSPmSpIg_l8">Build with Naz, testing in Rust</a></li>
    </ul>
  </li>
</ul>

        <!--
    Display all the categories for this page
    More info:
    - Tutorial - http://tinyurl.com/yc6fq6zx
    - Liquid language reference - http://tinyurl.com/y8s4qpwo
-->
<div class="categories-block">
    
    
    <span class="category">
            <a href="/category/CLI">
                #cli</a>
        </span>
    
    <span class="category">
            <a href="/category/Rust">
                #rust</a>
        </span>
    
    <span class="category">
            <a href="/category/Server">
                #server</a>
        </span>
    
</div>

        
<blockquote>

📦 Install our useful Rust command line apps using <code>cargo install r3bl-cmdr</code>
(they are from the <a href="https://github.com/r3bl-org/r3bl-open-core">r3bl-open-core</a>
project):
<ul>
  <li>🐱<code>giti</code>: run interactive git commands with confidence in your terminal</li>
  <li>🦜<code>edi</code>: edit Markdown with style in your terminal</li>
</ul>

<p>
<kbd>giti in action</kbd>
<video width="100%" controls>
  <source src="https://github.com/nazmulidris/developerlife.com/assets/2966499/262f59d1-a95c-4af3-accf-c3d6cac6e586" type="video/mp4"/>
</video>
</p>

<p>
<kbd>edi in action</kbd>
<video width="100%" controls>
  <source src="https://github.com/nazmulidris/developerlife.com/assets/2966499/f2c4b07d-b5a2-4f41-af7a-06d1b6660c41" type="video/mp4"/>
</video>
</p>

</blockquote>

        <!--
    Display related posts (by category)
    More info:
    - Tutorial - http://tinyurl.com/j5tevq7
    - Liquid language reference - http://tinyurl.com/y9ru5msq
-->
<div class="related-post-block">

    <h3>Related Posts</h3>

    <!-- Get all the related posts into the string `postsString`-->
    
    
    

    <!--
        At this point `postsString` string might look like:
        Post 3|Post 1|Post 3|Post 2|Post 1|Post 3|Post 2|
    -->

    <!-- Remove all the dupes from the `postsString` string, and split it into an array -->
    

    <ul>
        
            
                
                <li>
                    <a class="post-list" href="/2024/06/10/rust-miette-error-handling/">
                        Rust error handling with miette
                    </a>
                </li>
            
        
            
        
            
                
                <li>
                    <a class="post-list" href="/2024/05/25/tokio-uring-exploration-rust/">
                        Build with Naz : Linux io_uring and tokio-uring exploration with Rust
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2024/05/19/effective-async-rust/">
                        Build with Naz : Rust async, non-blocking, concurrent, parallel, event loops, cancellation safety
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2024/05/15/tokio-tracing-otel-rust/">
                        Build with Naz : tokio tracing &amp; OTel and how to use it in Rust
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2024/04/28/rust-polymorphism-dyn-impl-trait-objects-for-testing-and-extensibiity/">
                        Build with Naz : Rust Polymorphism, dyn, impl, using existing traits, trait objects for testing and extensibility
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2024/04/21/build-async-interactive-cli-apps-in-rust/">
                        Build with Naz : Build interactive and non blocking CLI apps with ease in Rust using r3bl_terminal_async
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2024/01/13/write-simple-netcat-in-rust/">
                        Write a simple netcat client and server in Rust
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2024/01/13/write-simple-chat-server-in-rust/">
                        Write a simple TCP chat server in Rust
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2023/09/22/overcome-your-fear-of-merge-conflicts/">
                        How to overcome your fear of git merge conflicts
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2023/09/17/tuify-clap/">
                        tuify your clap CLI apps and make them more interactive
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2023/08/28/justfile/">
                        Use just to manage project specific commands
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2022/08/04/rust-dsl-part-1/">
                        Create a simple DSL for CSS like syntax for TUIs
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2022/03/12/rust-redux/">
                        Write a Redux library in Rust
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2022/03/12/rust-tokio/">
                        Write code using async/await in Rust
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2022/03/02/rust-grep-cli-app/">
                        Build a grep CLI app in Rust
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2022/02/24/rust-non-binary-tree/">
                        Build a non-binary tree that is thread safe using Rust
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2021/11/25/ink-v3-advanced-ui-components/">
                        Reference handbook for using Ink v3.2.0 components (w/ React, Node.js and TypeScript)
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2021/11/05/ink-v3-advanced/">
                        Advanced guide to Ink v3.2.0 (w/ React, Node.js and TypeScript)
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2021/11/04/introduction-to-ink-v3/">
                        Introduction to Ink v3.2.0 (w/ React, Node.js and TypeScript)
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2023/02/20/guide-to-nom-parsing/">
                        Guide to parsing with nom
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2022/03/30/rust-proc-macro/">
                        Guide to Rust procedural macros
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2021/07/02/nodejs-typescript-handbook/">
                        Node.js (v16.3.0) Handbook using TypeScript (v4.3.4)
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2019/12/02/project-loom-experiment/">
                        Experimenting w/ Fibers in Project Loom preview
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2011/04/13/creating-asynchronous-servlets-with-tomcat-7-servlet-3-0-api/">
                        Creating asynchronous servlets with Tomcat 7 (Servlet 3.0 API)
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2009/03/06/using-json-for-mobile-object-exchange/">
                        Using JSON for mobile object exchange
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2008/04/21/geocoding-tutorial-accessing-google-static-maps-from-java/">
                        Geocoding tutorial - Accessing Google Static Maps from Java
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2007/11/27/what-is-xml-an-introduction/">
                        What is XML? An introduction
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2000/09/20/advanced-threads/">
                        Advanced Threads
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/1998/12/01/xml-and-java-tutorial-part-1/">
                        XML and Java Tutorial, Part 1
                    </a>
                </li>
            
        
    </ul>

</div>

        <a class="u-url" href="/2024/05/28/typestate-pattern-rust/" hidden></a>
    </div></article>
</div>
      </main><div>
  <section class="sidebar">
    <h2 class="star-us-github-heading">
      Subscribe to our Rust live coding
      <a href="https://www.youtube.com/@developerlifecom">YouTube Channel</a
      ><span class="heading-emoji"> 🦀</span>
    </h2>

    <!-- video on intro to testing (with playlist) -->
    <!-- <iframe
      src="https://www.youtube.com/embed/videoseries?si=7gmhXY5DVYJG7OdU&amp;list=PLofhE49PEwmwLR_4Noa0dFOSPmSpIg_l8"
      title="YouTube video player"
      frameborder="0"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
      referrerpolicy="strict-origin-when-cross-origin"
      allowfullscreen
    >
    </iframe> -->

    <!-- rust async readline and spinner & playlist -->
    <!-- <iframe
      src="https://www.youtube.com/embed/videoseries?si=i37Ei9nCfvslOoaI&amp;list=PLofhE49PEwmwelPkhfiqdFQ9IXnmGdnSE"
      title="YouTube video player"
      frameborder="0"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
      referrerpolicy="strict-origin-when-cross-origin"
      allowfullscreen
    >
    </iframe> -->

  <!-- rust tokio tracing and otel for async rust & playlist -->
  <iframe
    src="https://www.youtube.com/embed/Wf8JrLgBuKI?si=cmLaUWs-pbJ39lLc"
    title="YouTube video player"
    frameborder="0"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
    referrerpolicy="strict-origin-when-cross-origin"
    allowfullscreen>
  </iframe>

    <br />
    <br />

    <h2 class="star-us-github-heading">
      Use our extensions, apps, binary and library crates<span class="heading-emoji"> 📦</span>
    </h2>

    <ul class="sidebar-ul">
      <li class="app-container">
        <a href="https://github.com/r3bl-org/r3bl-open-core/tree/main/cmdr" target="_blank">
          <img class="star-icon-img" src="/assets/r3bl-apps.svg" />
          <div class="sidebar-list-item">
            <p class="p-tag">INSTALL & USE OUR APPS (giti, edi)</p>
            <h3 class="sidebar-h3"><code>r3bl-cmdr</code></h3>
          </div>
        </a>
      </li>
      <li class="app-container">
        <a href="https://github.com/r3bl-org/shortlink" target="_blank">
          <img class="star-icon-img" src="/assets/r3bl-shortlink.svg" />
          <div class="sidebar-list-item">
            <p class="p-tag">SHORTLINK browser extension</p>
            <h3 class="sidebar-h3"><code>shortlink</code></h3>
          </div>
        </a>
      </li>
      <li class="app-container">
        <a href="https://github.com/r3bl-org/r3bl-open-core/tree/main/tui" target="_blank">
          <img class="star-icon-img" src="/assets/crate.png" />
          <div class="sidebar-list-item">
            <p class="p-tag">R3BL TUI LIB</p>
            <h3 class="sidebar-h3"><code>r3bl_tui</code></h3>
          </div>
        </a>
      </li>
      <li class="app-container">
        <a href="https://github.com/r3bl-org/r3bl-open-core/tree/main/tuify" target="_blank">
          <img class="star-icon-img" src="/assets/crate.png" />
          <div class="sidebar-list-item">
            <p class="p-tag">R3BL TUIFY LIB</p>
            <h3 class="sidebar-h3"><code>r3bl_tuify</code></h3>
          </div>
        </a>
      </li>
      <li class="app-container">
        <a
          href="https://github.com/r3bl-org/r3bl-open-core/tree/main/terminal_async"
          target="_blank"
        >
          <img class="star-icon-img" src="/assets/crate.png" />
          <div class="sidebar-list-item">
            <p class="p-tag">R3BL TERMINAL ASYNC LIB</p>
            <h3 class="sidebar-h3"><code>r3bl_terminal_async</code></h3>
          </div>
        </a>
      </li>
    </ul>

    <br />

    <h2 class="star-us-github-heading">
      Join our <a href="https://discord.gg/PhuF4qFpcA">Discord</a>
      <span class="heading-emoji"> 💬</span>
    </h2>
  </section>
</div>
</div><footer class="site-footer h-card">

    <div class="wrapper">

        <div class="footer-col-wrapper">

            <div class="footer-col"><!-- <p>
    developerlife.com site was started in Nov 1998 with coverage for
    topics related to Java, XML, and web and desktop technologies.
    Today it covers Kotlin, TypeScript, Node.js, React, Android, JDK,
    Web, Cloud technologies, User Experience Engineering (UXE)
    and design topics. © Nazmul Idris 2022. All rights reserved.
</p> -->
<div>
  <p class="footer-p">
    developerlife.com site was started in Nov 1998 by <a href="https://developerlife.com/about-me/">Nazmul Idris</a>, with coverage for topics related to Java, XML,
    and web and desktop technologies. Today it covers Rust, TUI, CLI, Kotlin, TypeScript, Node.js, React, Android,
    JDK, Web, Cloud technologies, User Experience Engineering (UXE) and design topics. © Nazmul
    Idris 2022. All rights reserved.
  </p>
  <div class="footer-container">
    <!-- element 1 -->
    <kbd>
      <a class="footer-elem-1" href="/subscribe.html" target="_blank"
        >Subscribe for updates</a
      >
    </kbd>

    <!-- element 2 -->
    <kbd>
      <a class="footer-elem-2" href="https://r3bl.com" target="_blank">Sponsored by R3BL</a>
    </kbd>
  </div>
</div>
</div>

        </div>

    </div>

</footer>
<script>
//open external links in a new window
function external_new_window() {
    for(var c = document.getElementsByTagName("a"), a = 0;a < c.length;a++) {
    var b = c[a];
    b.getAttribute("href") && b.hostname !== location.hostname && (b.target = "_blank")
    }
}
//open PDF links in a new window
function pdf_new_window ()
{
    if (!document.getElementsByTagName) return false;
    var links = document.getElementsByTagName("a");
    for (var eleLink=0; eleLink < links.length; eleLink ++) {
    if ((links[eleLink].href.indexOf('.pdf') !== -1)||(links[eleLink].href.indexOf('.doc') !== -1)||(links[eleLink].href.indexOf('.docx') !== -1)) {
        links[eleLink].onclick =
        function() {
            window.open(this.href);
            return false;
        }
    }
    }
} 
pdf_new_window()
external_new_window();
</script></body>
</html>
