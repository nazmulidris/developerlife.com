<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Advanced guide to creating IntelliJ IDEA plugins | developerlife.com</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Advanced guide to creating IntelliJ IDEA plugins" />
<meta name="author" content="Nazmul Idris" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Advanced guide to creating JetBrains Platform plugins: VFS, PSI, Kotlin UI DSL, Dialog, Tool window, List, Swing UI and layout managers, ConsoleView, LineMarker. This is a companion of the Introduction to creating IntelliJ IDEA plugins tutorial." />
<meta property="og:description" content="Advanced guide to creating JetBrains Platform plugins: VFS, PSI, Kotlin UI DSL, Dialog, Tool window, List, Swing UI and layout managers, ConsoleView, LineMarker. This is a companion of the Introduction to creating IntelliJ IDEA plugins tutorial." />
<link rel="canonical" href="http://developerlife.com/2021/03/13/ij-idea-plugin-advanced/" />
<meta property="og:url" content="http://developerlife.com/2021/03/13/ij-idea-plugin-advanced/" />
<meta property="og:site_name" content="developerlife.com" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-03-13T08:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Advanced guide to creating IntelliJ IDEA plugins" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Nazmul Idris"},"dateModified":"2021-03-13T08:00:00-06:00","datePublished":"2021-03-13T08:00:00-06:00","description":"Advanced guide to creating JetBrains Platform plugins: VFS, PSI, Kotlin UI DSL, Dialog, Tool window, List, Swing UI and layout managers, ConsoleView, LineMarker. This is a companion of the Introduction to creating IntelliJ IDEA plugins tutorial.","headline":"Advanced guide to creating IntelliJ IDEA plugins","mainEntityOfPage":{"@type":"WebPage","@id":"http://developerlife.com/2021/03/13/ij-idea-plugin-advanced/"},"url":"http://developerlife.com/2021/03/13/ij-idea-plugin-advanced/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css" />

  <!-- Add favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

  <!-- Add font awesome -->
  <link
    rel="stylesheet"
    href="https://use.fontawesome.com/releases/v5.2.0/css/all.css"
    integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ"
    crossorigin="anonymous"
  />

  <!-- Add Google fonts-->
  <link
    href="https://fonts.googleapis.com/css?family=Spline+Sans|Work+Sans|Fira+Mono|Fira+Sans|Google+Sans|Lexend+Deca&display=swap"
    rel="stylesheet"
  /><link type="application/atom+xml" rel="alternate" href="http://developerlife.com/feed.xml" title="developerlife.com" /><!-- https://developers.google.com/analytics/devguides/collection/gtagjs -->
<script async
        src="https://www.googletagmanager.com/gtag/js?id=G-NQY9ECC58H"></script>
<script>
  window.dataLayer = window.dataLayer || []

  function gtag() {
    window.dataLayer.push(arguments)
  }

  gtag("js", new Date())
  gtag("config", "G-NQY9ECC58H")
</script>
<!-- https://us14.admin.mailchimp.com/account/connected-sites/site-detail/ -->

<script id="mcjs">
  !(function (c, h, i, m, p) {
    ;(m = c.createElement(h)),
      (p = c.getElementsByTagName(h)[0]),
      (m.async = 1),
      (m.src = i),
      p.parentNode.insertBefore(m, p)
  })(
    document,
    "script",
    "https://chimpstatic.com/mcjs-connected/js/users/c2470ddfa863eb8ace707651b/2bb3bcad193ef862398700457.js"
  )
</script>
</head>
<body><!-- https://github.com/mermaid-js/mermaid/blob/develop/docs/n00b-gettingStarted.md -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

<script>
  // https://mermaid-js.github.io/mermaid/#/theming
  mermaid.initialize({
    startOnLoad: true,
    theme: "dark",
    themeVariables: {
      fontFamily: "Fira Code",
      fontSize: "0.95rem",
      darkMode: true,
      primaryColor: "#2f9ece",
      mainBkg: "#303439",
    },
  })
</script>
<header class="site-header" role="banner">

    <div class="wrapper header-wrapper"><div class="logo-container">
        <div class="logo-image">
          <a class="site-title"
             rel="author"
             href="/">
              <!-- This is the logo image placeholder. -->
                <picture>
                  <source srcset="/assets/dl-logo-icon-dark.svg" media="(max-width: 600px)"/>
                  <img  src="/assets/dl-logo-icon-and-text-dark.svg" />
                </picture>
          </a>
        </div>
      </div><nav class="site-nav">
            <input type="checkbox" id="nav-trigger" class="nav-trigger"/>
            <label for="nav-trigger">
          <span class="menu-icon">
              <svg class="svg-icon">
              <use xlink:href="/assets/minima-social-icons.svg#menu">
              </use>
            </svg>
          </span>
            </label>

            <div class="trigger"><!--
    Iterate over all the pages in the site, where page_cursor holds the current
    page for each pass of the for loop.
    Note that page is the currently loaded page itself.
--><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/Android/"> Android </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/CC/"> Concurrency </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/CLI/"> CLI </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/CS/"> CS </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/DB/"> Database </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/DI/"> DI </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/FE/"> Frontend </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/Hardware/"> Hardware </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/IJ/"> IntelliJ </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/KT/"> Kotlin </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/Linux/"> Linux </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/MP/"> MP </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/Misc/"> Misc </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/Node/"> Node </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/Productivity/"> Productivity </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/RN/"> React-Native </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/React/"> React </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/Rust/"> Rust </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/Server/"> Server </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/State/"> State-Management </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/Stories/"> Stories </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/TDD/"> Testing </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/TS/"> TypeScript </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/TUI/"> TUI </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/category/Web/"> Web </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/about-me/"> Nazmul Idris </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/about-site/"> About Us </a><!-- This item is not selected -->
        <!-- Don't list excluded pages --><a class="page-link" href="/authors/"> Authors </a></div>
        </nav></div>
</header>

<!-- Debug to show the value of page.title and page.category variables -->
<!--<pre>page_cursor.exclude = nil</pre>-->
<!--<pre>page.exclude = nil</pre>-->
<!--<pre>page.title = &quot;Advanced guide to creating IntelliJ IDEA plugins&quot;</pre>-->
<!--<pre>page.category = nil</pre>-->
<!--<pre>page.title (json) = Advanced guide to creating IntelliJ IDEA plugins</pre>-->
<!--<pre>page.category (json) = </pre>-->
<div class="page-and-sidebar-wrapper">
      <main class="page-content" aria-label="Content">
        <div class="wrapper"><article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting"><header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Advanced guide to creating IntelliJ IDEA plugins</h1>

    <!-- Create all the variables needed for this page (and all the includes) -->
    

    <div class="post-meta">
        <p>
            <!-- Date -->Mar 13, 2021

            <!--Author-->
            ‚àô <a href="/about-me">Nazmul Idris</a>

            <!-- One line social blurb --><ul class="contact-list">
    <li class="p-name">Hi, I'm
            <a href="/about-me">Nazmul</a>,
            an ex-Googler, <a href="https://github.com/r3bl-org/r3bl-open-core/tree/main/tui" target="_blank">r3bl_tui maintainer</a>, SWE, entrepreneur, designer, leader,
            TaiChi-er, racer, storyteller.
            <!-- This is font awesome icon -->
            I <i class="fas fa-heart"></i>
            leadership, authenticity, empowerment, lifelong learning,
            <i class="fas fa-code"></i>,
            <i class="fas fa-terminal"></i>, &
            <i class="fas fa-coffee"></i>,
            üòÉ.</li>
</ul>
</p>
    </div><div class="social-media-container">
  <!-- <iframe
    src="https://github.com/sponsors/nazmulidris/button"
    title="Sponsor nazmulidris"
    height="35"
    width="116"
    style="border: 0; padding-right: 6px"
  ></iframe> -->

  <a href="/subscribe.html" target="_blank"
    ><kbd>Subscribe for updates</kbd></a
  ><p class="social-media-item">
    <a
      href="https://www.linkedin.com/in/nazmulidris"
      target="_blank"
    >
      <svg class="svg-icon">
        <use xlink:href="/assets/minima-social-icons.svg#linkedin"></use>
      </svg>
    </a>
  </p><p class="social-media-item">
    <a href="https://www.youtube.com/channel/UCMcsxfCwzwDevc3NRqFgfEg" target="_blank">
      <svg class="svg-icon">
        <use xlink:href="/assets/minima-social-icons.svg#youtube"></use>
      </svg>
    </a>
  </p><p class="social-media-item">
    <a href="https://www.github.com/nazmulidris" target="_blank">
      <svg class="svg-icon">
        <use xlink:href="/assets/minima-social-icons.svg#github"></use>
      </svg>
    </a>
  </p><p class="social-media-item">
    <a href="/feed.xml" target="_blank">
      <svg class="svg-icon">
        <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
      </svg>
    </a>
  </p></div>
</header>
<div class="post-content e-content" itemprop="articleBody">
        <blockquote>
  üëÄ Watch Rust ü¶Ä live coding videos on our
  <a href="https://www.youtube.com/@developerlifecom">YouTube Channel</a>.

  <br />

  <!-- video on rust polymorphism (no playlist) -->
  <iframe
      src="https://www.youtube.com/embed/kYTgGtJjSro?si=XmW-_CAvCfB5e269"
      title="YouTube video player" frameborder="0"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
      referrerpolicy="strict-origin-when-cross-origin"
      allowfullscreen
      >
  </iframe>

  <!-- video on intro to testing (with playlist) -->
  <!-- <iframe
    src="https://www.youtube.com/embed/videoseries?si=7gmhXY5DVYJG7OdU&amp;list=PLofhE49PEwmwLR_4Noa0dFOSPmSpIg_l8"
    title="YouTube video player"
    frameborder="0"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
    referrerpolicy="strict-origin-when-cross-origin"
    allowfullscreen
  >
  </iframe> -->

</blockquote>

        <!-- If a page has a hero-image defined in it, then show it here -->


        <p><img class="post-hero-image" src="/assets/jetbrains-plugin.svg" /></p>

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->

<ul>
  <li><a href="#overview">Overview</a></li>
  <li><a href="#idea-threading-model">IDEA threading model</a>
    <ul>
      <li><a href="#what-was-submittransaction-all-about">What was submitTransaction() all about?</a></li>
      <li><a href="#what-is-a-write-safe-context">What is a write-safe context?</a></li>
      <li><a href="#what-is-the-replacement-for-submittransaction">What is the replacement for submitTransaction()?</a></li>
      <li><a href="#invokelater-and-modalitystate">invokeLater() and ModalityState</a></li>
      <li><a href="#how-to-use-invokelater-to-perform-asynchronous-and-synchronous-tasks">How to use invokeLater to perform asynchronous and synchronous tasks</a>
        <ul>
          <li><a href="#synchronous-execution-of-runnable-from-an-already-write-safe-context-using-submittransactioninvokelater">Synchronous execution of Runnable (from an already write-safe context using submitTransaction()/invokeLater())</a></li>
          <li><a href="#asynchronous-execution-of-runnable-from-a-write-unsafe--write-safe-context-using-submittransaction">Asynchronous execution of Runnable (from a write-unsafe / write-safe context using submitTransaction())</a></li>
        </ul>
      </li>
      <li><a href="#side-effect---invokelater-vs-submittransaction-and-impacts-on-test-code">Side effect - invokeLater() vs submitTransaction() and impacts on test code</a></li>
    </ul>
  </li>
  <li><a href="#psi-access-and-mutation">PSI access and mutation</a>
    <ul>
      <li><a href="#how-to-create-a-psifile-or-get-a-reference-to-one">How to create a PSIFile or get a reference to one</a></li>
      <li><a href="#psi-access">PSI Access</a>
        <ul>
          <li><a href="#visitor-pattern-for-top-down-navigation-_without_-threading-considerations">Visitor pattern for top down navigation (<em>without</em> threading considerations)</a></li>
          <li><a href="#threading-locking-and-progress-cancellation-check-during-psi-access">Threading, locking, and progress cancellation check during PSI access</a></li>
          <li><a href="#background-tasks-and-multiple-threads---the-incorrect-way">Background tasks and multiple threads - The incorrect way</a></li>
          <li><a href="#background-tasks-and-multiple-threads---the-correct-way">Background tasks and multiple threads - The correct way</a></li>
        </ul>
      </li>
      <li><a href="#psi-mutation">PSI Mutation</a>
        <ul>
          <li><a href="#psiviewer-plugin">PsiViewer plugin</a></li>
          <li><a href="#generate-psi-elements-from-text">Generate PSI elements from text</a></li>
          <li><a href="#example-of-walking-up-and-down-psi-trees-to-find-elements">Example of walking up and down PSI trees to find elements</a></li>
          <li><a href="#finding-elements-up-the-tree-parents">Finding elements up the tree (parents)</a></li>
          <li><a href="#finding-elements-down-the-tree-children">Finding elements down the tree (children)</a></li>
          <li><a href="#threading-considerations">Threading considerations</a></li>
        </ul>
      </li>
      <li><a href="#additional-references">Additional references</a></li>
    </ul>
  </li>
  <li><a href="#dynamic-plugins">Dynamic plugins</a>
    <ul>
      <li><a href="#extension-points-poststartupactivity-backgroundpoststartupactivity-to-initialize-a-plugin-on-project-load">Extension points postStartupActivity, backgroundPostStartupActivity to initialize a plugin on project load</a></li>
      <li><a href="#light-services">Light services</a></li>
      <li><a href="#migration-strategies">Migration strategies</a>
        <ul>
          <li><a href="#1-component---service">1. Component -&gt; Service</a></li>
          <li><a href="#2-component---poststartupactivity">2. Component -&gt; postStartupActivity</a></li>
          <li><a href="#3-component---poststartupactivity--service">3. Component -&gt; postStartupActivity + Service</a></li>
          <li><a href="#4-component---projectlistener">4. Component -&gt; projectListener</a></li>
          <li><a href="#5-component---projectlistener--service">5. Component -&gt; projectListener + Service</a></li>
          <li><a href="#6-delete-component">6. Delete Component</a></li>
          <li><a href="#7-component---applifecyclelistener">7. Component -&gt; AppLifecycleListener</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#vfs-document-psi">VFS, Document, PSI</a>
    <ul>
      <li><a href="#vfs">VFS</a>
        <ul>
          <li><a href="#getting-a-list-of-all-the-virtual-files-in-a-project">Getting a list of all the virtual files in a project</a></li>
          <li><a href="#attach-listeners-to-see-changes-to-virtual-files-programmatically">Attach listeners to see changes to virtual files programmatically</a></li>
          <li><a href="#attach-listeners-to-see-changes-to-virtual-files-declaratively">Attach listeners to see changes to virtual files declaratively</a></li>
          <li><a href="#asynchronously-process-file-system-events">Asynchronously process file system events</a></li>
          <li><a href="#intercept-when-the-currently-open-file-gets-saved">Intercept when the currently open file gets saved</a></li>
        </ul>
      </li>
      <li><a href="#document">Document</a>
        <ul>
          <li><a href="#example-of-an-action-that-uses-the-document-api">Example of an action that uses the Document API</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#ui-jetbrains-ui-components-swing-and-kotlin-ui-dsl">UI (JetBrains UI components, Swing and Kotlin UI DSL)</a>
    <ul>
      <li><a href="#simple-ui-components---notifications-popups-dialogs">Simple UI components - notifications, popups, dialogs</a>
        <ul>
          <li><a href="#notifications">Notifications</a></li>
          <li><a href="#popups">Popups</a></li>
          <li><a href="#dialogs">Dialogs</a></li>
        </ul>
      </li>
      <li><a href="#create-complex-uis-using-kotlin-ui-dsl-forms-dialogs-settings-screens">Create complex UIs using Kotlin UI DSL (forms, dialogs, settings screens)</a>
        <ul>
          <li><a href="#understanding-the-structure-of-the-dsl-layout-row-and-cell">Understanding the structure of the DSL (layout, row, and cell)</a></li>
          <li><a href="#how-to-bind-data-to-the-form-ui">How to bind data to the form UI</a></li>
          <li><a href="#what-ui-elements-are-available-for-use-in-the-forms">What UI elements are available for use in the forms</a></li>
          <li><a href="#how-to-display-a-form-in-a-dialog">How to display a form in a dialog</a></li>
          <li><a href="#how-to-persist-the-data-createdselected-by-the-user-between-ide-restarts-persistentstatecomponent">How to persist the data created/selected by the user, between IDE restarts (PersistentStateComponent)</a></li>
          <li><a href="#example-of-a-form-ui">Example of a form UI</a></li>
          <li><a href="#miglayout-panel-and-grow">MigLayout, panel, and grow</a></li>
        </ul>
      </li>
      <li><a href="#create-ide-settings-ui-for-plugin">Create IDE Settings UI for plugin</a></li>
      <li><a href="#complex-ui-creation-in-dialogs">Complex UI creation in dialogs</a></li>
      <li><a href="#adding-your-plugin-ui-in-tool-windows">Adding your plugin UI in Tool windows</a>
        <ul>
          <li><a href="#1-declarative-tool-window">1. Declarative tool window</a></li>
          <li><a href="#2-programmatic-tool-window">2. Programmatic tool window</a></li>
          <li><a href="#indices-and-dumb-aware">Indices and dumb aware</a></li>
          <li><a href="#creating-a-content-for-any-kind-of-tool-window">Creating a content for any kind of tool window</a></li>
          <li><a href="#content-closeability">Content closeability</a></li>
        </ul>
      </li>
      <li><a href="#add-line-marker-provider-in-your-plugin">Add Line marker provider in your plugin</a>
        <ul>
          <li><a href="#example-of-a-provider-for-markdown-language">Example of a provider for Markdown language</a></li>
          <li><a href="#1-declare-dependencies">1. Declare dependencies</a></li>
          <li><a href="#2-register-the-provider-in-xml">2. Register the provider in XML</a></li>
          <li><a href="#3-provide-an-implementation-of-linemarkerprovider">3. Provide an implementation of LineMarkerProvider</a></li>
          <li><a href="#4-provide-a-more-complex-implementation-of-linemarkerprovider">4. Provide a more complex implementation of LineMarkerProvider</a></li>
          <li><a href="#references">References</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<!-- END doctoc generated TOC please keep comment here to allow auto update -->
      <h2 id="overview">
        
        
          Overview <a href="#overview">#</a>
        
        
      </h2>
    

<p>This article is a reference covering a lot of advanced topics related to creating IDEA plugins using
the JetBrains IntelliJ Platform SDK. However there are many advanced topics that are not covered
here (such as
<a href="https://plugins.jetbrains.com/docs/intellij/custom-language-support.html">custom language support</a>).</p>

<p>In order to be successful creating advanced plugins, this is what I suggest:</p>

<ol>
  <li>Read thru the <a href="/2020/11/20/idea-plugin-example-intro/">Introduction to creating IntelliJ IDEA
plugins</a> in detail. Modify the
<a href="https://github.com/nazmulidris/idea-plugin-example">idea-plugin-example</a>,
<a href="https://github.com/nazmulidris/idea-plugin-example2">idea-plugin-example2</a>, or
<a href="https://github.com/r3bl-org/shorty-idea-plugin">shorty-idea-plugin</a> to get some hands on
experience working with the plugin APIs.</li>
  <li>Use the
<a href="https://plugins.jetbrains.com/docs/intellij/welcome.html">Official JetBrains IntelliJ Platform SDK docs</a>,
along with the source code examples (from the list of repos above) to get a better understanding
of how to create plugins.</li>
  <li>When you are looking for something not in tutorials here (on developerlife.com) and in the
official docsd, then search the
<a href="https://github.com/JetBrains/intellij-community"><code class="language-plaintext highlighter-rouge">intellij-community</code></a> repo itself to find code
examples on how to use APIs that might not have any documentation. An effective approach is to
find some functionality in IDEA that is similar to what you are looking to build, and then locate
the source code for that feature in the repo and see how JetBrains has done it.</li>
</ol>
<blockquote>

üëÄ Watch Rust ü¶Ä live coding videos on our <a href="https://www.youtube.com/@developerlifecom">YouTube Channel</a>.

<br />
<br />

<!-- video on rust polymorphism (no playlist) -->
<iframe src="https://www.youtube.com/embed/kYTgGtJjSro?si=XmW-_CAvCfB5e269" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen="">
</iframe>

<br />
<br />

üì¶ Install our useful Rust command line apps using <code>cargo install r3bl-cmdr</code>
(they are from the <a href="https://github.com/r3bl-org/r3bl-open-core">r3bl-open-core</a>
project):
<ul>
  <li>üê±<code>giti</code>: run interactive git commands with confidence in your terminal</li>
  <li>ü¶ú<code>edi</code>: edit Markdown with style in your terminal</li>
</ul>

<p>
<kbd>giti in action</kbd>
<video width="100%" controls="">
  <source src="https://github.com/nazmulidris/developerlife.com/assets/2966499/262f59d1-a95c-4af3-accf-c3d6cac6e586" type="video/mp4" />
</video>
</p>

<p>
<kbd>edi in action</kbd>
<video width="100%" controls="">
  <source src="https://github.com/nazmulidris/developerlife.com/assets/2966499/f2c4b07d-b5a2-4f41-af7a-06d1b6660c41" type="video/mp4" />
</video>
</p>

</blockquote>
      <h2 id="idea-threading-model">
        
        
          IDEA threading model <a href="#idea-threading-model">#</a>
        
        
      </h2>
    

<p>For the most part, the code that you write in your plugins is executed on the main thread. Some
operations such as changing anything in the IDE‚Äôs ‚Äúdata model‚Äù (PSI, VFS, project root model) all
have to done in the main thread in order to keep race conditions from occurring. Here‚Äôs the
<a href="https://plugins.jetbrains.com/docs/intellij/general-threading-rules.html#modality-and-invokelater">official docs</a>
on this.</p>

<p>There are many situations where some of your plugin code needs to run in a background thread so that
the UI doesn‚Äôt get frozen when long running operations occur. The plugin SDK has quite a few
strategies to allow you to do this. However, one thing that you should not do is use
<code class="language-plaintext highlighter-rouge">SwingUtilities.invokeLater()</code>.</p>

<ol>
  <li>One of the ways that you could run background tasks is by using
<code class="language-plaintext highlighter-rouge">TransactionGuard.submitTransaction()</code> but that has been deprecated.</li>
  <li>The new way is to use <code class="language-plaintext highlighter-rouge">ApplicationManager.getApplication().invokeLater()</code>.</li>
</ol>

<blockquote>
      <h4 id="api-deprecations">
        
        
          API deprecations <a href="#api-deprecations">#</a>
        
        
      </h4>
    

  <ul>
    <li>
      <p>You can find a detailed list of the major API deprecations and changes in various versions of
IDEA <a href="https://plugins.jetbrains.com/docs/intellij/api-notable.html">here</a>.</p>
    </li>
    <li>
      <p>You can search the JB platform codebase for deprecations by looking for
<code class="language-plaintext highlighter-rouge">@ApiStatus.ScheduledForRemoval(inVersion = &lt;version&gt;)</code>, where <code class="language-plaintext highlighter-rouge">&lt;version&gt;</code> can be <code class="language-plaintext highlighter-rouge">2020.1</code>, etc.</p>
    </li>
  </ul>
</blockquote>

<p>However, before we can understand what all of this means exactly, there are some important concepts
that we have to understand - ‚Äúmodality‚Äù, and ‚Äúwrite lock‚Äù, and ‚Äúwrite-safe context‚Äù. So we will
start with talking about <code class="language-plaintext highlighter-rouge">submitTransaction()</code> and get to each of these concepts along the way to
using <code class="language-plaintext highlighter-rouge">invokeLater()</code>.</p>
      <h3 id="what-was-submittransaction-all-about">
        
        
          What was submitTransaction() all about? <a href="#what-was-submittransaction-all-about">#</a>
        
        
      </h3>
    

<p>The now deprecated <code class="language-plaintext highlighter-rouge">TransactionGuard.submitTransaction(Runnable)</code> basically runs the passed
<code class="language-plaintext highlighter-rouge">Runnable</code> in:</p>

<ol>
  <li>a <a href="#what-is-a-write-safe-context">write-safe context</a> (which simply ensures that no one will be
able to perform an unexpected IDE model data changes using <code class="language-plaintext highlighter-rouge">SwingUtilities#invokeLater()</code>, or
equivalent APIs, while a dialog is shown).</li>
  <li>in a write thread (eg the EDT).</li>
</ol>

<p>However, <code class="language-plaintext highlighter-rouge">submitTransaction()</code> does not acquire a write lock or start a write action (this must be
done explicitly by your code if you need to modify IDE model data).</p>

<blockquote>
  <p>What does a write action have to do with a write-safe context? Nothing. However, it easy to
conflate the two concepts and think that a write-safe context has a write lock; it does not. These
are two separate things -</p>

  <ol>
    <li><em>write-safe context</em>,</li>
    <li><em>write lock</em>.</li>
  </ol>

  <p>You can be in a <em>write-safe context</em>, and you will still need to acquire a <em>write lock</em> to mutate
IDE model data. You can also use the following methods to check if your execution context already
holds the write lock:</p>

  <ol>
    <li><code class="language-plaintext highlighter-rouge">ApplicationManager.getApplication().isWriteAccessAllowed()</code>.</li>
    <li><code class="language-plaintext highlighter-rouge">ApplicationManager.getApplication().assertWriteAccessAllowed()</code>.</li>
  </ol>
</blockquote>
      <h3 id="what-is-a-write-safe-context">
        
        
          What is a write-safe context? <a href="#what-is-a-write-safe-context">#</a>
        
        
      </h3>
    

<p>The
<a href="https://github.com/JetBrains/intellij-community/blob/master/platform/core-api/src/com/intellij/openapi/application/TransactionGuard.java#L25">JavaDocs from</a>
<code class="language-plaintext highlighter-rouge">TransactionGuard.java</code> explain what a write-safe context is:</p>

<ul>
  <li>A mechanism to ensure that no one will be able to perform an unexpected IDE model data changes
using <code class="language-plaintext highlighter-rouge">SwingUtilities#invokeLater()</code> or analogs while a dialog is shown.</li>
</ul>

<p>Here are some examples of write-safe contexts:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Application#invokeLater(Runnable, ModalityState)</code> calls with a modality state that‚Äôs either
non-modal or was started inside a write-safe context. The use cases shown in the sections below
are related to the non-modal scenario.</li>
  <li>Direct user activity processing (key/mouse presses, actions) in non-modal state.</li>
  <li>User activity processing in a modality state that was started (e.g. by showing a dialog or
progress) in a write-safe context.</li>
</ul>

<p>Here is more information about how to handle code running on the EDT:</p>

<ul>
  <li>Code running in the EDT is <em>not necessarily</em> in a write-safe context, which is why
<code class="language-plaintext highlighter-rouge">submitTransaction()</code> provided the mechanism to execute a given <code class="language-plaintext highlighter-rouge">Runnable</code> in a write-safe context
(on the EDT itself).</li>
  <li>There are some exceptions to this, for example code running in actions in a non-modal state, while
running on the EDT are also running in a write-safe context (described above).</li>
  <li>
    <p>The JavaDocs from
<a href="https://github.com/JetBrains/intellij-community/blob/master/platform/util/ui/src/com/intellij/ui/DirtyUI.java#L8"><code class="language-plaintext highlighter-rouge">@DirtyUI</code> annotation source</a>
also provide some more information about UI code running in the EDT and write actions.</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
* &lt;p&gt;
* This annotation specifies code which runs on Swing Event Dispatch Thread and accesses IDE model (PSI, etc.)
* at the same time.
* &lt;p&gt;
* Accessing IDE model from EDT is prohibited by default, but many existing components are designed without
* such limitations. Such code can be marked with this annotation which will cause a dedicated instrumenter
* to modify bytecode to acquire Write Intent lock before the execution and release after the execution.
* &lt;p&gt;
* Marked methods will be modified to acquire/release IW lock. Marked classes will have a predefined set of their methods
* modified in the same way. This list of methods can be found at {@link com.intellij.ide.instrument.LockWrappingClassVisitor#METHODS_TO_WRAP}
*
* @see com.intellij.ide.instrument.WriteIntentLockInstrumenter
* @see com.intellij.openapi.application.Application
*/</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>Here are some best practices for code that runs in the EDT:</p>

<ol>
  <li>Any writes to the IDE data model must happen on the write thread, which is the EDT.</li>
  <li>Even though you can safely read IDE model data from the EDT (without acquiring a read lock), you
will still need to acquire a write lock in order to modify IDE model data.</li>
  <li>Code running in the EDT must explicitly acquire write locks explicitly (by wrapping that code in
a write action) in order to change any IDE model data. This can be done by wrapping the code in a
write action with <code class="language-plaintext highlighter-rouge">ApplicationManager.getApplication().runWriteAction()</code> or, <code class="language-plaintext highlighter-rouge">WriteAction</code>
<code class="language-plaintext highlighter-rouge">run()</code>/<code class="language-plaintext highlighter-rouge">compute()</code>.</li>
  <li>If your code is running in a dialog, and you don‚Äôt need to perform any write operations to IDE
data models, then you can simply use <code class="language-plaintext highlighter-rouge">SwingUtilities.invokeLater()</code> or analogs. You only need a
<a href="#what-is-a-write-safe-context">write-safe context</a> to run in the right
<a href="#invokelater-and-modalitystate">modality</a> if you plan to change the IDE data models.</li>
  <li>The IntelliJ Platform SDK docs have more details on IDEA threading
<a href="https://www.jetbrains.org/intellij/sdk/docs/basics/architectural_overview/general_threading_rules.html">here</a>.</li>
</ol>
      <h3 id="what-is-the-replacement-for-submittransaction">
        
        
          What is the replacement for submitTransaction()? <a href="#what-is-the-replacement-for-submittransaction">#</a>
        
        
      </h3>
    

<p>The replacement for using <code class="language-plaintext highlighter-rouge">TransactionGuard.submitTransaction(Runnable, ...)</code> is
<code class="language-plaintext highlighter-rouge">ApplicationManager.getApplication().invokeLater(Runnable, ...)</code>. <code class="language-plaintext highlighter-rouge">invokeLater()</code> makes sure that
your code is running in a write-safe context, but you still need to acquire a write lock if you want
to modify any IDE model data.</p>
      <h3 id="invokelater-and-modalitystate">
        
        
          invokeLater() and ModalityState <a href="#invokelater-and-modalitystate">#</a>
        
        
      </h3>
    

<p><code class="language-plaintext highlighter-rouge">invokeLater()</code> can take a <code class="language-plaintext highlighter-rouge">ModalityState</code> parameter in addition to a <code class="language-plaintext highlighter-rouge">Runnable</code>. Basically you can
choose when to actually execute your <code class="language-plaintext highlighter-rouge">Runnable</code>, either ASAP, during the period when a dialog box is
displayed, or when all dialog boxes have been closed.</p>

<blockquote>
  <p>To see source code examples of how <code class="language-plaintext highlighter-rouge">ModailtyState</code> can be used in a dialog box used in a plugin
(that is written using the Kotlin UI DSL) check out this sample
<a href="https://github.com/nazmulidris/idea-plugin-example/blob/main/src/main/kotlin/ui/ShowKotlinUIDSLSampleInDialogAction.kt">ShowKotlinUIDSLSampleInDialogAction.kt</a></p>
</blockquote>

<blockquote>
  <p>To learn more about what the official docs say about this,
<a href="https://github.com/JetBrains/intellij-community/blob/master/platform/core-api/src/com/intellij/openapi/application/ModalityState.java#L23">check out the JavaDocs</a>
in <code class="language-plaintext highlighter-rouge">ModalityState.java</code>. The following is an in-depth explanation of how this all works.</p>
</blockquote>

<p>There‚Äôs a user flow that is described in the docs that goes something like this:</p>

<ol>
  <li>Some action runs in a plugin, which enqueues <code class="language-plaintext highlighter-rouge">Runnable</code> A on the EDT for later invocation, using
<code class="language-plaintext highlighter-rouge">SwingUtilities.invokeLater()</code>.</li>
  <li>Then, the action shows a dialog box, and waits for user input.</li>
  <li>While the user is thinking about what choice to make on the dialog box, that <code class="language-plaintext highlighter-rouge">Runnable</code> A has
already started execution, and it does something drastic to the IDE data models (like delete a
project or something).</li>
  <li>The user finally makes up their mind and makes a choice. At this point the code that is running
in the action is not aware of the changes that have been made by <code class="language-plaintext highlighter-rouge">Runnable</code> A. And this can cause
some big problems in the action.</li>
  <li>ModalityState allows you to exert control over when the <code class="language-plaintext highlighter-rouge">Runnable</code> A is actually executed at a
later time.</li>
</ol>

<p>Here‚Äôs some more information about this scenario. If you set a breakpoint at the start of the
action‚Äôs execution, before it enqueued <code class="language-plaintext highlighter-rouge">Runnable</code> A, you might see the following if you look at
<code class="language-plaintext highlighter-rouge">ApplicationManager.getApplication().myTransactionGuard.myWriteSafeModalities</code> in the debugger. This
is <strong>BEFORE</strong> the dialog box is shown.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>myWriteSafeModalities = {ConcurrentWeakHashMap@39160}  size = 3
 {ModalityStateEx@39091} "ModalityState.NON_MODAL" -&gt; {Boolean@39735} true
 {ModalityStateEx@41404} "ModalityState:{}" -&gt; {Boolean@39735} true
 {ModalityStateEx@40112} "ModalityState:{}" -&gt; {Boolean@39735} true
</code></pre></div></div>

<p><strong>AFTER</strong> the dialog box is shown you might see something like the following for the same
<code class="language-plaintext highlighter-rouge">myWriteSafeModalities</code> object in the debugger (if you set a breakpoint after the dialog box has
returned the user selected value).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>myWriteSafeModalities = {ConcurrentWeakHashMap@39160}  size = 4
  {ModalityStateEx@39091} "ModalityState.NON_MODAL" -&gt; {Boolean@39735} true
  {ModalityStateEx@41404} "ModalityState:{}" -&gt; {Boolean@39735} true
  {ModalityStateEx@43180} "ModalityState:{[...APPLICATION_MODAL,title=Sample..." -&gt; {Boolean@39735} true
  {ModalityStateEx@40112} "ModalityState:{}" -&gt; {Boolean@39735} true
</code></pre></div></div>

<p>Notice that a new <code class="language-plaintext highlighter-rouge">ModalityState</code> has been added, which basically points to the dialog box being
displayed.</p>

<p>So this is how the modality state parameter to invokeLater() works.</p>

<ol>
  <li>If you don‚Äôt want the <code class="language-plaintext highlighter-rouge">Runnable</code> that you pass to it to be executed immediately, then you can
specify <code class="language-plaintext highlighter-rouge">ModalityState.NON_MODAL</code>, and this will run it after the dialog box has closed (there
are no more modal dialogs in the stack of active modal dialogs).</li>
  <li>Instead if you wanted to run it immediately, then you can run it using <code class="language-plaintext highlighter-rouge">ModalityState.any()</code>.</li>
  <li>However, if you pass the <code class="language-plaintext highlighter-rouge">ModalityState</code> of the dialog box as a parameter, then this <code class="language-plaintext highlighter-rouge">Runnable</code>
will only execute while that dialog box is being displayed.</li>
  <li>Now, even when the dialog box is displayed, if you enqueued another <code class="language-plaintext highlighter-rouge">Runnable</code> to run with
<code class="language-plaintext highlighter-rouge">ModalityState.NON_MODAL</code>, then it will be run after the dialog box is closed.</li>
</ol>
      <h3 id="how-to-use-invokelater-to-perform-asynchronous-and-synchronous-tasks">
        
        
          How to use invokeLater to perform asynchronous and synchronous tasks <a href="#how-to-use-invokelater-to-perform-asynchronous-and-synchronous-tasks">#</a>
        
        
      </h3>
    

<p>The following sub sections demonstrate how to get away from using <code class="language-plaintext highlighter-rouge">submitTransaction()</code> and switch
to using <code class="language-plaintext highlighter-rouge">invokeLater()</code> for the given use cases, an even remove the use of them altogether when
possible.</p>
      <h4 id="synchronous-execution-of-runnable-from-an-already-write-safe-context-using-submittransactioninvokelater">
        
        
          Synchronous execution of Runnable (from an already write-safe context using submitTransaction()/invokeLater()) <a href="#synchronous-execution-of-runnable-from-an-already-write-safe-context-using-submittransactioninvokelater">#</a>
        
        
      </h4>
    

<p>In the scenario where your code is already running in a
<a href="#what-is-a-write-safe-context">write-safe context</a>, there is no need to use <code class="language-plaintext highlighter-rouge">submitTransaction()</code>
or <code class="language-plaintext highlighter-rouge">invokeLater()</code> to queue your <code class="language-plaintext highlighter-rouge">Runnable</code>, and you can execute its contents directly.</p>

<blockquote>
  <p>From <code class="language-plaintext highlighter-rouge">TransactionGuard.java#submitTransaction()</code> JavaDoc on
<a href="https://github.com/JetBrains/intellij-community/blob/master/platform/core-api/src/com/intellij/openapi/application/TransactionGuard.java#L76">Line 76</a>:
‚ÄúIn a definitely write-safe context, just replace this call with {@code transaction} contents.
Otherwise, replace with {@link Application#invokeLater} and take care that the default or
explicitly passed modality state is write-safe.‚Äù</p>
</blockquote>

<p>Let‚Äôs say that you have a button which has a listener, in a dialog, or tool window. When the button
is clicked, it should execute a <code class="language-plaintext highlighter-rouge">Runnable</code> in a <a href="#what-is-a-write-safe-context">write-safe context</a>.
Here‚Äôs the code that registers the action listener to the button.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">init</span> <span class="p">{</span>
  <span class="n">button</span><span class="p">.</span><span class="nf">addActionListener</span> <span class="p">{</span>
    <span class="nf">processButtonClick</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here‚Äôs the code that queues the <code class="language-plaintext highlighter-rouge">Runnable</code>. If you run
<code class="language-plaintext highlighter-rouge">TransactionGuard.getInstance().isWriteSafeModality(ModalityState.NON_MODAL)</code> inside the following
function it returns <code class="language-plaintext highlighter-rouge">true</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">fun</span> <span class="nf">processButtonClick</span><span class="p">()</span> <span class="p">{</span>
  <span class="nc">TransactionGuard</span><span class="p">.</span><span class="nf">submitTransaction</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="nc">Runnable</span> <span class="p">{</span>
    <span class="c1">// Do something to the IDE data model in a write action.</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<p>However this code is running in the EDT, and since <code class="language-plaintext highlighter-rouge">processButtonClick()</code> uses a write action to
perform its job, so there‚Äôs really no need to wrap it in a <code class="language-plaintext highlighter-rouge">submitTransaction()</code> or <code class="language-plaintext highlighter-rouge">invokeLater()</code>
call. Here we have code that is:</p>

<ol>
  <li>Running the EDT,</li>
  <li>Already running in a write-safe context,</li>
  <li>And, <code class="language-plaintext highlighter-rouge">processButtonClick()</code> itself wraps its work in a write action.</li>
</ol>

<p>In this case, it is possible to safely remove the <code class="language-plaintext highlighter-rouge">Runnable</code> and just directly call its contents.
So, we can replace it with something like this.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ApplicationManager</span><span class="p">.</span><span class="nf">getApplication</span><span class="p">().</span><span class="nf">assertIsDispatchThread</span><span class="p">()</span>
<span class="c1">// Do something to the IDE data model in a write action.</span>
</code></pre></div></div>
      <h4 id="asynchronous-execution-of-runnable-from-a-write-unsafe--write-safe-context-using-submittransaction">
        
        
          Asynchronous execution of Runnable (from a write-unsafe / write-safe context using submitTransaction()) <a href="#asynchronous-execution-of-runnable-from-a-write-unsafe--write-safe-context-using-submittransaction">#</a>
        
        
      </h4>
    

<p>The simplest replacement for the <code class="language-plaintext highlighter-rouge">Runnable</code> and <code class="language-plaintext highlighter-rouge">Disposable</code> that are typically passed to
<code class="language-plaintext highlighter-rouge">submitTransaction()</code>, is simply to replace the call:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">TransactionGuard</span><span class="p">.</span><span class="nf">submitTransaction</span><span class="p">(</span><span class="nc">Disposable</span><span class="p">,</span> <span class="nc">Runnable</span><span class="p">)</span>
</code></pre></div></div>

<p>With:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ApplicationManager</span><span class="p">.</span><span class="nc">ApplicationManager</span><span class="p">.</span><span class="nf">getApplication</span><span class="p">().</span><span class="nf">invokeLater</span><span class="p">(</span>
  <span class="nc">Runnable</span><span class="p">,</span> <span class="nc">ComponentManager</span><span class="p">.</span><span class="nf">getDisposed</span><span class="p">())</span>
</code></pre></div></div>

<ol>
  <li>Note that IDE data model objects like project, etc. all expose a <code class="language-plaintext highlighter-rouge">Condition</code> object from a call
to <code class="language-plaintext highlighter-rouge">getDisposed().</code></li>
  <li>If you have to create a <code class="language-plaintext highlighter-rouge">Condition</code> yourself, then you can just wrap your <code class="language-plaintext highlighter-rouge">Disposable</code> in a call
to <code class="language-plaintext highlighter-rouge">Disposer.isDisposed(Disposable)</code>.</li>
</ol>

<p>Let‚Äôs take a look at a simple example of replacing old code that uses <code class="language-plaintext highlighter-rouge">submitTransaction()</code>.</p>

<ol>
  <li>
    <p>OId code that uses <code class="language-plaintext highlighter-rouge">submitTransaction</code>.</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">TransactionGuard</span><span class="o">.</span><span class="na">submitTransaction</span><span class="o">(</span><span class="n">myProject</span><span class="o">,</span> <span class="o">()-&gt;{</span> <span class="cm">/* Runnable */</span> <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>New code that uses <code class="language-plaintext highlighter-rouge">invokeLater()</code>.</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ApplicationManager</span><span class="o">.</span><span class="na">getApplication</span><span class="o">().</span><span class="na">invokeLater</span><span class="o">(()-&gt;{</span> <span class="cm">/* Runnable */</span> <span class="o">},</span> <span class="n">myProject</span><span class="o">.</span><span class="na">getDisposed</span><span class="o">());</span>
</code></pre></div>    </div>
  </li>
</ol>

<p>Here‚Äôs a slightly more complex example where a <code class="language-plaintext highlighter-rouge">Condition</code> object must be created.</p>

<ol>
  <li>
    <p>OId code that uses <code class="language-plaintext highlighter-rouge">submitTransaction</code>.</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">TransactionGuard</span><span class="o">.</span><span class="na">submitTransaction</span><span class="o">(</span><span class="n">myComponent</span><span class="o">.</span><span class="na">getModel</span><span class="o">(),</span> <span class="o">()-&gt;{</span> <span class="cm">/* Runnable */</span> <span class="o">})</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>New code that uses <code class="language-plaintext highlighter-rouge">invokeLater</code>.</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ApplicationManager</span><span class="o">.</span><span class="na">getApplication</span><span class="o">().</span><span class="na">invokeLater</span><span class="o">(</span>
    <span class="o">()-&gt;{</span> <span class="cm">/* Runnable */</span> <span class="o">},</span>
    <span class="n">ignore</span> <span class="o">-&gt;</span> <span class="nc">Disposer</span><span class="o">.</span><span class="na">isDisposed</span><span class="o">(</span><span class="n">myComponent</span><span class="o">.</span><span class="na">getModel</span><span class="o">())</span>
    <span class="o">);</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>You can also just check for the condition <code class="language-plaintext highlighter-rouge">Disposer.isDisposed(myComponent.getModel())</code> at the
start of the <code class="language-plaintext highlighter-rouge">Runnable</code>. And not even pass the <code class="language-plaintext highlighter-rouge">Condition</code> in <code class="language-plaintext highlighter-rouge">invokeLater()</code> if you like.</p>
  </li>
</ol>
      <h3 id="side-effect---invokelater-vs-submittransaction-and-impacts-on-test-code">
        
        
          Side effect - invokeLater() vs submitTransaction() and impacts on test code <a href="#side-effect---invokelater-vs-submittransaction-and-impacts-on-test-code">#</a>
        
        
      </h3>
    

<p>When moving from <code class="language-plaintext highlighter-rouge">submitTransaction()</code> to <code class="language-plaintext highlighter-rouge">invokeLater()</code> some tests might need to be updated, due
to one of the major differences between how these two functions actually work.</p>

<p>In some cases, one of the consequences of using <code class="language-plaintext highlighter-rouge">invokeLater()</code> instead of <code class="language-plaintext highlighter-rouge">submitTransaction()</code> is
that in tests, you might have to call
<code class="language-plaintext highlighter-rouge">PlatformTestUtil.dispatchAllInvocationEventsInIdeEventQueue()</code> to ensure that the <code class="language-plaintext highlighter-rouge">Runnables</code> that
are queued for execution on the EDT are actually executed (since the tests run in a headless
environment). You can also call <code class="language-plaintext highlighter-rouge">UIUtil.dispatchAllInvocationEvents()</code> instead of
<code class="language-plaintext highlighter-rouge">PlatformTestUtil.dispatchAllInvocationEventsInIdeEventQueue()</code>. When using <code class="language-plaintext highlighter-rouge">submitTransaction()</code> in
the past, this was not necessary.</p>

<p>Here‚Äôs old code, and test code.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@JvmStatic</span>
<span class="k">fun</span> <span class="nf">myFunction</span><span class="p">(</span><span class="n">project</span><span class="p">:</span> <span class="nc">Project</span><span class="p">)</span> <span class="p">{</span>
  <span class="nc">TransactionGuard</span><span class="p">.</span><span class="nf">submitTransaction</span><span class="p">(</span>
    <span class="n">project</span><span class="p">,</span> <span class="nc">Runnable</span> <span class="p">{</span>
      <span class="c1">// Do stuff.</span>
    <span class="p">})</span>
<span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">testMyFunction</span><span class="p">()</span> <span class="p">{</span>
  <span class="nf">myFunction</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
  <span class="nf">verify</span><span class="p">(</span><span class="cm">/* that myFunction() runs */</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here‚Äôs the new code, and test code.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@JvmStatic</span>
<span class="k">fun</span> <span class="nf">myFunction</span><span class="p">(</span><span class="n">project</span><span class="p">:</span> <span class="nc">Project</span><span class="p">)</span> <span class="p">{</span>
  <span class="nc">ApplicationManager</span><span class="p">.</span><span class="nf">getApplication</span><span class="p">().</span><span class="nf">invokeLater</span><span class="p">(</span>
    <span class="nc">Runnable</span> <span class="p">{</span>
      <span class="c1">// Do stuff.</span>
    <span class="p">})</span>
<span class="p">},</span> <span class="n">project</span><span class="p">.</span><span class="n">disposed</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">testMyFunction</span><span class="p">()</span> <span class="p">{</span>
  <span class="nf">myFunction</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
  <span class="nc">PlatformTestUtil</span><span class="p">.</span><span class="nf">dispatchAllInvocationEventsInIdeEventQueue</span><span class="p">()</span>
  <span class="nf">verify</span><span class="p">(</span><span class="cm">/* that myFunction() runs */</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
      <h2 id="psi-access-and-mutation">
        
        
          PSI access and mutation <a href="#psi-access-and-mutation">#</a>
        
        
      </h2>
    

<p>This section covers Program Structure Interface (PSI) and how to use it to access files in various
languages. And how to use it to create language specific content. Threading considerations that must
be taken into account to make sure the IDE UI is responsive is also covered here.</p>

<blockquote>
  <p>Please read the <a href="https://plugins.jetbrains.com/docs/intellij/psi.html">official docs on PSI</a>
before proceeding further.</p>
</blockquote>
      <h3 id="how-to-create-a-psifile-or-get-a-reference-to-one">
        
        
          How to create a PSIFile or get a reference to one <a href="#how-to-create-a-psifile-or-get-a-reference-to-one">#</a>
        
        
      </h3>
    

<p>There are many ways of creating a PSI file. Here are some examples of you can get a reference to a
PSI file in your plugin.</p>

<ol>
  <li>From an action‚Äôs event: <code class="language-plaintext highlighter-rouge">e.getData(LangDataKeys.PSI_FILE)</code></li>
  <li>From a <code class="language-plaintext highlighter-rouge">VirtualFile</code>: <code class="language-plaintext highlighter-rouge">PsiManager.getInstance(myProject).findFile(vFile)</code></li>
  <li>From a <code class="language-plaintext highlighter-rouge">Document</code>: <code class="language-plaintext highlighter-rouge">PsiDocumentManager.getInstance(project).getPsiFile(document)</code></li>
  <li>From a <code class="language-plaintext highlighter-rouge">PsiElement</code>: <code class="language-plaintext highlighter-rouge">psiElement.getContainingFile()</code></li>
  <li>From any project you can get a <code class="language-plaintext highlighter-rouge">PSIFile[]</code>:
<code class="language-plaintext highlighter-rouge">FilenameIndex .getFilesByName(project, "file.ext", GlobalSearchScope.allScope(project))</code></li>
</ol>

<p>There is some information on navigating PSI trees
<a href="https://www.jetbrains.org/intellij/sdk/docs/basics/architectural_overview/navigating_psi.html">here</a>.</p>
      <h3 id="psi-access">
        
        
          PSI Access <a href="#psi-access">#</a>
        
        
      </h3>
    
      <h4 id="visitor-pattern-for-top-down-navigation-without-threading-considerations">
        
        
          Visitor pattern for top down navigation (<em>without</em> threading considerations) <a href="#visitor-pattern-for-top-down-navigation-without-threading-considerations">#</a>
        
        
      </h4>
    

<p>A very common thing to do when you have a reference to a PSI file is to navigate it from the root
node to find something inside of the file. This is where the visitor pattern comes into play.</p>

<ol>
  <li>In order to get access to all the classes you might need for this, you might need to import the
right set of
<a href="https://plugins.jetbrains.com/docs/intellij/plugin-compatibility.html?from=jetbrains.org#modules-specific-to-functionality">built in modules</a>.
    <blockquote>
      <p>There are scenarios where you might want to add functionality in the IJ platform itself. For
example, let‚Äôs say you wanted to add <code class="language-plaintext highlighter-rouge">JavaRecursiveElementVisitor</code> to your project to visit a
PSI tree. Well, this class isn‚Äôt available to the plugin by default, and needs to be ‚Äúimported‚Äù
in 2 steps, just as you would for a published plugin.</p>

      <ol>
        <li><code class="language-plaintext highlighter-rouge">setPlugins()</code> in <code class="language-plaintext highlighter-rouge">build.gradle.kts</code>, and</li>
        <li><code class="language-plaintext highlighter-rouge">&lt;depends&gt;</code> in <code class="language-plaintext highlighter-rouge">plugin.xml</code>.</li>
      </ol>

      <p>Here‚Äôs what you have to do to add support for the Java language.</p>

      <ol>
        <li><code class="language-plaintext highlighter-rouge">build.gradle.kts</code>: <code class="language-plaintext highlighter-rouge">setPlugins("java", &lt;other plugins, if they exist&gt;)</code></li>
      </ol>
    </blockquote>
  </li>
  <li>In many cases, you can also use more specific APIs for top-down navigation. For example, if you
need to get a list of all methods in a Java class, you can do that using a visitor, but a much
easier way to do that is to call <code class="language-plaintext highlighter-rouge">PsiClass.getMethods()</code>.</li>
  <li><a href="https://github.com/JetBrains/intellij-community/blob/master/platform/core-api/src/com/intellij/psi/util/PsiTreeUtil.java">PsiTreeUtil.java</a>
contains a number of general-purpose, language-independent functions for PSI tree navigation,
some of which (for example, <code class="language-plaintext highlighter-rouge">findChildrenOfType()</code>) perform top-down navigation.</li>
</ol>

<blockquote>
  <p>‚ö†Ô∏è
<a href="https://www.jetbrains.org/intellij/sdk/docs/reference_guide/performance/performance.html#avoiding-ui-freezes">Threading issues</a>
might arise, since all this computation is done in the EDT, and for a really long PSI tree, this
can problematic. Especially w/ the use of a write lock to make some big changes in the tree. There
are many sections below which deal w/ cancellation and read and write locking.</p>
</blockquote>

<p>The basic visitor pattern for top down navigation looks like this. The following snippet counts the
number of header and paragraph elements in a Markdown file, where <code class="language-plaintext highlighter-rouge">psiFile</code> is a reference to this
file.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">count</span> <span class="p">=</span> <span class="kd">object</span> <span class="err">{
    var paragraph: </span><span class="nc">Int</span> <span class="p">=</span> <span class="mi">0</span>
    <span class="kd">var</span> <span class="py">header</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="mi">0</span>
<span class="p">}</span>
<span class="n">psiFile</span><span class="p">.</span><span class="nf">accept</span><span class="p">(</span><span class="kd">object</span> <span class="err">: </span><span class="nc">MarkdownRecursiveElementVisitor</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">visitParagraph</span><span class="p">(</span><span class="n">paragraph</span><span class="p">:</span> <span class="nc">MarkdownParagraphImpl</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">count</span><span class="p">.</span><span class="n">paragraph</span><span class="p">++</span>
    <span class="c1">// The following line ensures that ProgressManager.checkCancelled()</span>
    <span class="c1">// is called.</span>
    <span class="k">super</span><span class="p">.</span><span class="nf">visitParagraph</span><span class="p">(</span><span class="n">paragraph</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">visitHeader</span><span class="p">(</span><span class="n">header</span><span class="p">:</span> <span class="nc">MarkdownHeaderImpl</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">count</span><span class="p">.</span><span class="n">header</span><span class="p">++</span>
    <span class="c1">// The following line ensures that ProgressManager.checkCancelled()</span>
    <span class="c1">// is called.</span>
    <span class="k">super</span><span class="p">.</span><span class="nf">visitHeader</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">})</span>
</code></pre></div></div>

<p>This is great sample code to navigate the tree for a Java class:
<a href="https://github.com/JetBrains/intellij-sdk-docs/blob/master/code_samples/psi_demo/src/main/java/org/intellij/sdk/psi/PsiNavigationDemoAction.java">PsiNavigationDemoAction.java</a>.</p>
      <h4 id="threading-locking-and-progress-cancellation-check-during-psi-access">
        
        
          Threading, locking, and progress cancellation check during PSI access <a href="#threading-locking-and-progress-cancellation-check-during-psi-access">#</a>
        
        
      </h4>
    

<p>When creating long running actions that work on a PSI tree, you have to take care of the following
things:</p>

<ol>
  <li>Make sure that you are accessing the PSI tree after acquiring a read lock (in a read action).</li>
  <li>Make sure that your long running tasks can be cancelled by the user.</li>
  <li>Make sure that you don‚Äôt freeze the UI and make it unresponsive for a long running task that uses
the PSI tree.</li>
</ol>

<p>Here is an example of running a task in a background thread in IDEA that uses a read action, but is
NOT cancellable. Better ways of doing this are shown below.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ApplicationManager</span><span class="p">.</span><span class="nf">getApplication</span><span class="p">().</span><span class="nf">executeOnPooledThread</span> <span class="p">{</span>
  <span class="nc">ApplicationManager</span><span class="p">.</span><span class="nf">getApplication</span><span class="p">().</span><span class="nf">runReadAction</span> <span class="p">{</span>
    <span class="c1">// Your potentially long running task that uses something in the PSI tree.</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
      <h4 id="background-tasks-and-multiple-threads---the-incorrect-way">
        
        
          Background tasks and multiple threads - The incorrect way <a href="#background-tasks-and-multiple-threads---the-incorrect-way">#</a>
        
        
      </h4>
    

<p>The following is a bad example of using <code class="language-plaintext highlighter-rouge">Task.Backgroundable</code> object. It is cancellable, and it
works, but it accesses some PSI structures inside of this task (in a background thread) which is
actually a <strong>bad thing</strong> that leads to race conditions w/ the data in the EDT and the data that the
background thead is currently getting from the PSI objects.</p>

<p>Here‚Äôs the code for an action that creates the task and runs it in the background (<strong>without</strong>
acquiring a read lock in a read action):</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">override</span> <span class="k">fun</span> <span class="nf">actionPerformed</span><span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nc">AnActionEvent</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">psiFile</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nf">getRequiredData</span><span class="p">(</span><span class="nc">CommonDataKeys</span><span class="p">.</span><span class="nc">PSI_FILE</span><span class="p">)</span>
  <span class="kd">val</span> <span class="py">psiFileViewProvider</span> <span class="p">=</span> <span class="n">psiFile</span><span class="p">.</span><span class="n">viewProvider</span>
  <span class="kd">val</span> <span class="py">project</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nf">getRequiredData</span><span class="p">(</span><span class="nc">CommonDataKeys</span><span class="p">.</span><span class="nc">PROJECT</span><span class="p">)</span>
  <span class="kd">val</span> <span class="py">progressTitle</span> <span class="p">=</span> <span class="s">"Doing heavy PSI computation"</span>

  <span class="kd">val</span> <span class="py">task</span> <span class="p">=</span> <span class="kd">object</span> <span class="err">: </span><span class="nc">Backgroundable</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">progressTitle</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">run</span><span class="p">(</span><span class="n">indicator</span><span class="p">:</span> <span class="nc">ProgressIndicator</span><span class="p">)</span> <span class="p">{</span>
      <span class="nf">doWorkInBackground</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">psiFile</span><span class="p">,</span> <span class="n">psiFileViewProvider</span><span class="p">,</span> <span class="n">indicator</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">task</span><span class="p">.</span><span class="nf">queue</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here‚Äôs the code for the <code class="language-plaintext highlighter-rouge">doWorkInBackground(...)</code>. As you can see this function does not acquire a
read lock, and simply runs the <code class="language-plaintext highlighter-rouge">navigateXXXTree()</code> functions based on whether the current file has
Markdown or Java code in it.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="kd">data class</span> <span class="nc">Count</span><span class="p">(</span><span class="kd">var</span> <span class="py">paragraph</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="mi">0</span><span class="p">,</span> <span class="kd">var</span> <span class="py">links</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="mi">0</span><span class="p">,</span> <span class="kd">var</span> <span class="py">header</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">private</span> <span class="kd">val</span> <span class="py">count</span> <span class="p">=</span> <span class="nc">Count</span><span class="p">()</span>

<span class="k">private</span> <span class="k">fun</span> <span class="nf">doWorkInBackground</span><span class="p">(</span><span class="n">project</span><span class="p">:</span> <span class="nc">Project</span><span class="p">,</span>
                               <span class="n">psiFile</span><span class="p">:</span> <span class="nc">PsiFile</span><span class="p">,</span>
                               <span class="n">psiFileViewProvider</span><span class="p">:</span> <span class="nc">FileViewProvider</span><span class="p">,</span>
                               <span class="n">indicator</span><span class="p">:</span> <span class="nc">ProgressIndicator</span><span class="p">,</span>
                               <span class="n">editor</span><span class="p">:</span> <span class="nc">Editor</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="n">indicator</span><span class="p">.</span><span class="n">isIndeterminate</span> <span class="p">=</span> <span class="k">true</span>
  <span class="kd">val</span> <span class="py">languages</span> <span class="p">=</span> <span class="n">psiFileViewProvider</span><span class="p">.</span><span class="n">languages</span>
  <span class="kd">val</span> <span class="py">message</span> <span class="p">=</span> <span class="nf">buildString</span> <span class="p">{</span>
    <span class="k">when</span> <span class="p">{</span>
      <span class="n">languages</span><span class="p">.</span><span class="nf">contains</span><span class="p">(</span><span class="s">"Markdown"</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nf">navigateMarkdownTree</span><span class="p">(</span><span class="n">psiFile</span><span class="p">,</span> <span class="n">indicator</span><span class="p">,</span> <span class="n">project</span><span class="p">)</span>
      <span class="n">languages</span><span class="p">.</span><span class="nf">contains</span><span class="p">(</span><span class="s">"Java"</span><span class="p">)</span>     <span class="p">-&gt;</span> <span class="nf">navigateJavaTree</span><span class="p">(</span><span class="n">psiFile</span><span class="p">,</span> <span class="n">indicator</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">editor</span><span class="p">)</span>
      <span class="k">else</span>                           <span class="p">-&gt;</span> <span class="nf">append</span><span class="p">(</span><span class="s">"No supported languages found"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nf">append</span><span class="p">(</span><span class="s">"languages: $languages\n"</span><span class="p">)</span>
    <span class="nf">append</span><span class="p">(</span><span class="s">"count.header: ${count.header}\n"</span><span class="p">)</span>
    <span class="nf">append</span><span class="p">(</span><span class="s">"count.paragraph: ${count.paragraph}\n"</span><span class="p">)</span>
    <span class="nf">checkCancelled</span><span class="p">(</span><span class="n">indicator</span><span class="p">,</span> <span class="n">project</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nf">println</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Let‚Äôs look at the <code class="language-plaintext highlighter-rouge">navigateXXXTree()</code> functions next. They simply generate some analytics depending
on whether a Java or Markdown file is open in the editor.</p>

<ol>
  <li>For Markdown files, it simply generates the number of headers and paragraphs that exist in the
document in the editor.</li>
  <li>For Java files, if a method is selected, it generates information about the enclosing class and
any local variables that are declared inside that method.</li>
</ol>

<p>For Markdown files, here‚Äôs the function.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">fun</span> <span class="nf">navigateMarkdownTree</span><span class="p">(</span><span class="n">psiFile</span><span class="p">:</span> <span class="nc">PsiFile</span><span class="p">,</span>
                                 <span class="n">indicator</span><span class="p">:</span> <span class="nc">ProgressIndicator</span><span class="p">,</span>
                                 <span class="n">project</span><span class="p">:</span> <span class="nc">Project</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="n">psiFile</span><span class="p">.</span><span class="nf">accept</span><span class="p">(</span><span class="kd">object</span> <span class="err">: </span><span class="nc">MarkdownRecursiveElementVisitor</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">visitParagraph</span><span class="p">(</span><span class="n">paragraph</span><span class="p">:</span> <span class="nc">MarkdownParagraphImpl</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="n">count</span><span class="p">.</span><span class="n">paragraph</span><span class="p">++</span>
      <span class="nf">checkCancelled</span><span class="p">(</span><span class="n">indicator</span><span class="p">,</span> <span class="n">project</span><span class="p">)</span>
      <span class="c1">// The following line ensures that ProgressManager.checkCancelled() is called.</span>
      <span class="k">super</span><span class="p">.</span><span class="nf">visitParagraph</span><span class="p">(</span><span class="n">paragraph</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">visitHeader</span><span class="p">(</span><span class="n">header</span><span class="p">:</span> <span class="nc">MarkdownHeaderImpl</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="n">count</span><span class="p">.</span><span class="n">header</span><span class="p">++</span>
      <span class="nf">checkCancelled</span><span class="p">(</span><span class="n">indicator</span><span class="p">,</span> <span class="n">project</span><span class="p">)</span>
      <span class="c1">// The following line ensures that ProgressManager.checkCancelled()  is called.</span>
      <span class="k">super</span><span class="p">.</span><span class="nf">visitHeader</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<p>For Java files, here‚Äôs the function.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">fun</span> <span class="nf">navigateJavaTree</span><span class="p">(</span><span class="n">psiFile</span><span class="p">:</span> <span class="nc">PsiFile</span><span class="p">,</span>
                             <span class="n">indicator</span><span class="p">:</span> <span class="nc">ProgressIndicator</span><span class="p">,</span>
                             <span class="n">project</span><span class="p">:</span> <span class="nc">Project</span><span class="p">,</span>
                             <span class="n">editor</span><span class="p">:</span> <span class="nc">Editor</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">offset</span> <span class="p">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">caretModel</span><span class="p">.</span><span class="n">offset</span>
  <span class="kd">val</span> <span class="py">element</span><span class="p">:</span> <span class="nc">PsiElement</span><span class="p">?</span> <span class="p">=</span> <span class="n">psiFile</span><span class="p">.</span><span class="nf">findElementAt</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
  <span class="kd">val</span> <span class="py">javaPsiInfo</span> <span class="p">=</span> <span class="nf">buildString</span> <span class="p">{</span>
    <span class="nf">checkCancelled</span><span class="p">(</span><span class="n">indicator</span><span class="p">,</span> <span class="n">project</span><span class="p">)</span>
    <span class="n">element</span><span class="o">?.</span><span class="nf">apply</span> <span class="p">{</span>
      <span class="nf">append</span><span class="p">(</span><span class="s">"Element at caret: $element\n"</span><span class="p">)</span>
      <span class="kd">val</span> <span class="py">containingMethod</span><span class="p">:</span> <span class="nc">PsiMethod</span><span class="p">?</span> <span class="p">=</span> <span class="nc">PsiTreeUtil</span><span class="p">.</span><span class="nf">getParentOfType</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="nc">PsiMethod</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
      <span class="n">containingMethod</span><span class="o">?.</span><span class="nf">apply</span> <span class="p">{</span>
        <span class="nf">append</span><span class="p">(</span><span class="s">"Containing method: ${containingMethod.name}\n"</span><span class="p">)</span>
        <span class="n">containingMethod</span><span class="p">.</span><span class="n">containingClass</span><span class="o">?.</span><span class="nf">apply</span> <span class="p">{</span>
          <span class="nf">append</span><span class="p">(</span><span class="s">"Containing class: ${this.name} \n"</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="kd">val</span> <span class="py">list</span> <span class="p">=</span> <span class="n">mutableListOf</span><span class="p">&lt;</span><span class="nc">PsiLocalVariable</span><span class="p">&gt;()</span>
        <span class="n">containingMethod</span><span class="p">.</span><span class="nf">accept</span><span class="p">(</span><span class="kd">object</span> <span class="err">: </span><span class="nc">JavaRecursiveElementVisitor</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">override</span> <span class="k">fun</span> <span class="nf">visitLocalVariable</span><span class="p">(</span><span class="n">variable</span><span class="p">:</span> <span class="nc">PsiLocalVariable</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">list</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>
            <span class="c1">// The following line ensures that ProgressManager.checkCancelled() is called.</span>
            <span class="k">super</span><span class="p">.</span><span class="nf">visitLocalVariable</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>
          <span class="p">}</span>
        <span class="p">})</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">list</span><span class="p">.</span><span class="nf">isNotEmpty</span><span class="p">())</span>
          <span class="nf">append</span><span class="p">(</span><span class="n">list</span><span class="p">.</span><span class="nf">joinToString</span><span class="p">(</span><span class="n">prefix</span> <span class="p">=</span> <span class="s">"Local variables:\n"</span><span class="p">,</span> <span class="n">separator</span> <span class="p">=</span> <span class="s">"\n"</span><span class="p">)</span> <span class="p">{</span> <span class="n">it</span> <span class="p">-&gt;</span> <span class="s">"- ${it.name}"</span> <span class="p">})</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nf">checkCancelled</span><span class="p">(</span><span class="n">indicator</span><span class="p">,</span> <span class="n">project</span><span class="p">)</span>
  <span class="kd">val</span> <span class="py">message</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">javaPsiInfo</span> <span class="p">==</span> <span class="s">""</span><span class="p">)</span> <span class="s">"No PsiElement at caret!"</span> <span class="k">else</span> <span class="n">javaPsiInfo</span>
  <span class="nf">println</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
  <span class="nc">ApplicationManager</span><span class="p">.</span><span class="nf">getApplication</span><span class="p">().</span><span class="nf">invokeLater</span> <span class="p">{</span>
    <span class="nc">Messages</span><span class="p">.</span><span class="nf">showMessageDialog</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="s">"PSI Java Info"</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now, when you run this code, the <code class="language-plaintext highlighter-rouge">navigateMarkdownTree()</code> does not throw an exception because the
PSI was accessed outside of a read lock. However, <code class="language-plaintext highlighter-rouge">navigateJavaTree()</code> does throw the exception
below.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Throwable</span><span class="o">:</span> <span class="nc">Read</span> <span class="n">access</span> <span class="n">is</span> <span class="n">allowed</span> <span class="n">from</span> <span class="n">event</span> <span class="n">dispatch</span> <span class="n">thread</span> <span class="n">or</span> <span class="n">inside</span>
<span class="n">read</span><span class="o">-</span><span class="n">action</span> <span class="nf">only</span> <span class="o">(</span><span class="n">see</span> <span class="n">com</span><span class="o">.</span><span class="na">intellij</span><span class="o">.</span><span class="na">openapi</span><span class="o">.</span><span class="na">application</span><span class="o">.</span><span class="na">Application</span><span class="o">.</span><span class="na">runReadAction</span><span class="o">())</span>
</code></pre></div></div>

<p>This exception will most likely get thrown for any complicated access of the PSI from a non-EDT
thread without a read lock.</p>

<blockquote>
  <p>Note that if you access the PSI data from the EDT itself there is no need to acquire a read lock.</p>
</blockquote>

<p>Notes on <code class="language-plaintext highlighter-rouge">navigateMarkdownTree()</code>:</p>

<ul>
  <li>The code above doesn‚Äôt trigger any read lock assertion exceptions, and it is probably because it
is too simple. There are a few flavors of <code class="language-plaintext highlighter-rouge">assertReadAccessAllowed()</code>, one even in <code class="language-plaintext highlighter-rouge">PsiFileImpl</code>,
and they are called from various methods accessing the PSI. Maybe they‚Äôre not called everywhere (I
assume it‚Äôd be expensive to check read access for everything), just in the common APIs, and maybe
this example didn‚Äôt get to any.</li>
  <li>Also, it‚Äôs probably possible to read state without a read lock, i.e the IDE won‚Äôt necessarily
throw an exception, it‚Äôs just that you‚Äôre not guaranteed any consistent results as you‚Äôre racing
with the UI thread (making changes to the data within write actions).</li>
  <li>So just because an exception isn‚Äôt throw when failing to acquire a read lock to access PSI data
doesn‚Äôt mean the results are consistent due to possibly racing w/ the UI thread making changes to
that data within write actions.</li>
  <li>Here are the official JetBrains
<a href="https://www.jetbrains.org/intellij/sdk/docs/basics/architectural_overview/general_threading_rules.html">docs</a>
on threading and locking.</li>
</ul>

<p>Notes on <code class="language-plaintext highlighter-rouge">navigateJavaTree()</code>:</p>

<ul>
  <li>This code throws the exception right away, which is why it is important to wrap all PSI read
access inside of a read action.</li>
</ul>
      <h4 id="background-tasks-and-multiple-threads---the-correct-way">
        
        
          Background tasks and multiple threads - The correct way <a href="#background-tasks-and-multiple-threads---the-correct-way">#</a>
        
        
      </h4>
    

<p>These are the steps we can take to fix the code above.</p>

<ol>
  <li>We don‚Äôt have to deal w/ read locks in the implementation of these two functions
(<code class="language-plaintext highlighter-rouge">navigateJavaTree()</code> and <code class="language-plaintext highlighter-rouge">navigateMarkdownTree()</code>). The <code class="language-plaintext highlighter-rouge">doWorkInBackground()</code> function should
really be dealing with this.</li>
  <li>Wrapping the code in <code class="language-plaintext highlighter-rouge">doWorkInBackground()</code> that calls these two functions in a read lock by
using <code class="language-plaintext highlighter-rouge">runReadAction {}</code> eliminates these exceptions.</li>
</ol>

<blockquote>
  <p>Note that both functions <code class="language-plaintext highlighter-rouge">navigateMarkdownTree()</code> or <code class="language-plaintext highlighter-rouge">navigateJavaTree()</code> do not need to be
modified in any way!</p>
</blockquote>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">fun</span> <span class="nf">doWorkInBackground</span><span class="p">(</span><span class="n">project</span><span class="p">:</span> <span class="nc">Project</span><span class="p">,</span>
                               <span class="n">psiFile</span><span class="p">:</span> <span class="nc">PsiFile</span><span class="p">,</span>
                               <span class="n">psiFileViewProvider</span><span class="p">:</span> <span class="nc">FileViewProvider</span><span class="p">,</span>
                               <span class="n">indicator</span><span class="p">:</span> <span class="nc">ProgressIndicator</span><span class="p">,</span>
                               <span class="n">editor</span><span class="p">:</span> <span class="nc">Editor</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="n">indicator</span><span class="p">.</span><span class="n">isIndeterminate</span> <span class="p">=</span> <span class="k">true</span>
  <span class="kd">val</span> <span class="py">languages</span> <span class="p">=</span> <span class="n">psiFileViewProvider</span><span class="p">.</span><span class="n">languages</span>
  <span class="nf">buildString</span> <span class="p">{</span>
    <span class="k">when</span> <span class="p">{</span>
      <span class="n">languages</span><span class="p">.</span><span class="nf">contains</span><span class="p">(</span><span class="s">"Markdown"</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nf">runReadAction</span> <span class="p">{</span> <span class="nf">navigateMarkdownTree</span><span class="p">(</span><span class="n">psiFile</span><span class="p">,</span> <span class="n">indicator</span><span class="p">,</span> <span class="n">project</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">languages</span><span class="p">.</span><span class="nf">contains</span><span class="p">(</span><span class="s">"Java"</span><span class="p">)</span>     <span class="p">-&gt;</span> <span class="nf">runReadAction</span> <span class="p">{</span> <span class="nf">navigateJavaTree</span><span class="p">(</span><span class="n">psiFile</span><span class="p">,</span> <span class="n">indicator</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">editor</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">else</span>                           <span class="p">-&gt;</span> <span class="nf">append</span><span class="p">(</span><span class="s">"No supported languages found"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nf">append</span><span class="p">(</span><span class="s">"languages: $languages\n"</span><span class="p">)</span>
    <span class="nf">append</span><span class="p">(</span><span class="s">"count.header: ${count.header}\n"</span><span class="p">)</span>
    <span class="nf">append</span><span class="p">(</span><span class="s">"count.paragraph: ${count.paragraph}\n"</span><span class="p">)</span>
    <span class="nf">checkCancelled</span><span class="p">(</span><span class="n">indicator</span><span class="p">,</span> <span class="n">project</span><span class="p">)</span>
  <span class="p">}.</span><span class="nf">printlnAndLog</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>

<p>For any long running background task, we have to check for cancellation to ensure that unnecessary
work does nto get done after the user has requested that our long running background task be
cancelled.</p>

<p>For tasks that require a lot of virtual files, or PSI elements to be looped over it becomes
necessary to check for cancellation (in addition to acquiring a read lock). Here‚Äôs an example from
<code class="language-plaintext highlighter-rouge">MarkdownRecursiveElementVisitor</code> which can be overridden to walk the PSI tree.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">open</span> <span class="kd">class</span> <span class="nc">MarkdownRecursiveElementVisitor</span> <span class="p">:</span> <span class="nc">MarkdownElementVisitor</span><span class="p">(),</span> <span class="nc">PsiRecursiveVisitor</span> <span class="p">{</span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">visitElement</span><span class="p">(</span><span class="n">element</span><span class="p">:</span> <span class="nc">PsiElement</span><span class="p">)</span> <span class="p">{</span>
    <span class="nc">ProgressManager</span><span class="p">.</span><span class="nf">checkCanceled</span><span class="p">()</span>
    <span class="n">element</span><span class="p">.</span><span class="nf">acceptChildren</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Note about the call to <code class="language-plaintext highlighter-rouge">ProgressManager.checkCanceled()</code> above - A subclass would have to make sure
to call <code class="language-plaintext highlighter-rouge">super.visitElement(...)</code> to ensure that this cancellation check is actually made.</p>

<blockquote>
      <h4 id="dispatching-ui-events-during-checkcanceled">
        
        
          Dispatching UI events during <code class="language-plaintext highlighter-rouge">checkCanceled()</code>. <a href="#dispatching-ui-events-during-checkcanceled">#</a>
        
        
      </h4>
    

  <p>There is a mechanism for updating the UI during write actions, but it seems quite limited.</p>

  <ul>
    <li>
      <p>A <code class="language-plaintext highlighter-rouge">ProgressIndicator</code> may choose to implement the <code class="language-plaintext highlighter-rouge">PingProgress</code> interface. If it does, then
<code class="language-plaintext highlighter-rouge">PingProgress.interact()</code> will be called whenever <code class="language-plaintext highlighter-rouge">checkCanceled()</code> is called. For details see
<code class="language-plaintext highlighter-rouge">ProgressManagerImpl.executeProcessUnderProgress()</code> and
<code class="language-plaintext highlighter-rouge">ProgressManagerImpl.addCheckCanceledHook()</code>.</p>
    </li>
    <li>
      <p>The <code class="language-plaintext highlighter-rouge">PingProgress</code> mechanism is used by <code class="language-plaintext highlighter-rouge">PotemkinProgress</code>: ‚ÄúA progress indicator for write
actions. Paints itself explicitly, without resorting to normal Swing‚Äôs delayed repaint API.
Doesn‚Äôt dispatch Swing events, except for handling manually those that can cancel it or affect
the visual presentation.‚Äù I.e., <code class="language-plaintext highlighter-rouge">PotemkinProgress</code> dispatches certain UI events during a write
action to ensure that the progress dialog remains responsive. But, note the comment, ‚ÄúRepaint
just the dialog panel. We must not call custom paint methods during write action, because they
might access the model, which might be inconsistent at that moment.‚Äù</p>
    </li>
  </ul>
</blockquote>

<blockquote>
      <h4 id="dont-try-to-acquire-read-or-write-locks-directly-use-actions-instead">
        
        
          Don‚Äôt try to acquire read or write locks directly, use actions instead <a href="#dont-try-to-acquire-read-or-write-locks-directly-use-actions-instead">#</a>
        
        
      </h4>
    

  <p>Instead of trying to acquire read or write locks directly, Use lambdas and read or write actions
instead. For example: <code class="language-plaintext highlighter-rouge">runReadAction()</code>, <code class="language-plaintext highlighter-rouge">runWriteAction()</code>,
<code class="language-plaintext highlighter-rouge">WriteCommandAction#runWriteCommandAction()</code>, etc.</p>

  <p>The APIs for acquiring the read or write lock are deprecated and marked for removal in <code class="language-plaintext highlighter-rouge">2020.3</code>.
It is good they‚Äôre being deprecated, because if you think about offering nonblocking read action
semantics (from the platform perspective), if a ‚Äúread‚Äù actions is done via a lock acquire /
release, how can one interrupt and re-start it?</p>

  <ol>
    <li><a href="https://github.com/JetBrains/intellij-community/blob/2b40e2ffe3cdda51990979b81567764965d890ed/platform/core-api/src/com/intellij/openapi/application/Application.java#L430">Application.java#acquireReadActionLock()</a></li>
    <li><a href="https://github.com/JetBrains/intellij-community/blob/2b40e2ffe3cdda51990979b81567764965d890ed/platform/core-api/src/com/intellij/openapi/application/Application.java#L438">Application.java#acquireWriteActionLock()</a></li>
  </ol>
</blockquote>
      <h3 id="psi-mutation">
        
        
          PSI Mutation <a href="#psi-mutation">#</a>
        
        
      </h3>
    
      <h4 id="psiviewer-plugin">
        
        
          PsiViewer plugin <a href="#psiviewer-plugin">#</a>
        
        
      </h4>
    

<p>One of the most important things to do before modifying the PSI is to understand its structure. And
the best way to do this is to install the
<a href="https://plugins.jetbrains.com/plugin/227-psiviewer">PsiViewer plugin</a> and use it to study what the
PSI tree looks like.</p>

<p>In this example, we will be modifying a Markdown document. So we will use this plugin to examine a
Markdown file that‚Äôs open in an IDE editor window. Here are the options that you should enable for
the plugin while you‚Äôre browsing around the editor:</p>

<ol>
  <li>Open Settings -&gt; PSIViewer and change the highlight colors to something that you like and make
sure to set the alpha to 255 for both references and highlighting.</li>
  <li>Open the PSIViewer tool window and enable the following options in the toolbar:</li>
</ol>

<ul>
  <li>Enable highlight (you might want to disable this when you‚Äôre done playing around w/ the tool
window)</li>
  <li>Enable properties</li>
  <li>Enable scroll to source</li>
  <li>Enable scroll from source</li>
</ul>

<p>A great example that can help us understand how PSI modification can work is taking a look at the
built-in Markdown plugin actions themselves. There are a few actions in the toolbar of every
Markdown editor: ‚Äútoggle bold‚Äù, ‚Äútoggle italic‚Äù, etc.</p>

<p>These are great to walk thru to understand how to make our own. The source files from
<code class="language-plaintext highlighter-rouge">intellij-community</code> repo on github are:</p>

<ul>
  <li>Files in
<a href="https://github.com/JetBrains/intellij-community/tree/master/plugins/markdown/src/org/intellij/plugins/markdown/ui/actions/styling"><code class="language-plaintext highlighter-rouge">plugins/markdown/src/org/intellij/plugins/markdown/ui/actions/styling/</code></a></li>
  <li><a href="https://github.com/JetBrains/intellij-community/blob/master/plugins/markdown/src/org/intellij/plugins/markdown/ui/actions/styling/ToggleBoldAction.java"><code class="language-plaintext highlighter-rouge">ToggleBoldAction.java</code></a></li>
  <li><a href="https://github.com/JetBrains/intellij-community/blob/master/plugins/markdown/src/org/intellij/plugins/markdown/ui/actions/styling/BaseToggleStateAction.java"><code class="language-plaintext highlighter-rouge">BaseToggleStateAction.java</code></a></li>
</ul>

<p>The example we will build for this section entails finding hyperlinks and replacing the links w/
some modified version of the link string. This will require using a write lock to mutate the PSI in
a cancellable action.</p>
      <h4 id="generate-psi-elements-from-text">
        
        
          Generate PSI elements from text <a href="#generate-psi-elements-from-text">#</a>
        
        
      </h4>
    

<p>It might seem strange but the preferred way to
<a href="https://www.jetbrains.org/intellij/sdk/docs/basics/architectural_overview/modifying_psi.html">create PSI elements</a>
by generating text for the new element and then having IDEA parse this into a PSI element. Kind of
like how a browser parses text (containing HTML) into DOM elements by setting
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/innerHTML"><code class="language-plaintext highlighter-rouge">innerHTML()</code></a>.</p>

<p>Here is some code that does this for Markdown elements.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">fun</span> <span class="nf">createNewLinkElement</span><span class="p">(</span><span class="n">project</span><span class="p">:</span> <span class="nc">Project</span><span class="p">,</span> <span class="n">linkText</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">linkDestination</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">PsiElement</span><span class="p">?</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">markdownText</span> <span class="p">=</span> <span class="s">"[$linkText]($linkDestination)"</span>
  <span class="kd">val</span> <span class="py">newFile</span> <span class="p">=</span> <span class="nc">MarkdownPsiElementFactory</span><span class="p">.</span><span class="nf">createFile</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">markdownText</span><span class="p">)</span>
  <span class="kd">val</span> <span class="py">newParentLinkElement</span> <span class="p">=</span> <span class="nf">findChildElement</span><span class="p">(</span><span class="n">newFile</span><span class="p">,</span> <span class="nc">MarkdownTokenTypeSets</span><span class="p">.</span><span class="nc">LINKS</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">newParentLinkElement</span>
<span class="p">}</span>
</code></pre></div></div>
      <h4 id="example-of-walking-up-and-down-psi-trees-to-find-elements">
        
        
          Example of walking up and down PSI trees to find elements <a href="#example-of-walking-up-and-down-psi-trees-to-find-elements">#</a>
        
        
      </h4>
    

<p>This is a dump from the PSI viewer of a snippet from this
<a href="https://raw.githubusercontent.com/sonar-intellij-plugin/sonar-intellij-plugin/master/README.md">README.md</a>
file.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MarkdownParagraphImpl(Markdown:PARAGRAPH)(1201,1498)
  PsiElement(Markdown:Markdown:TEXT)('The main goal of this plugin is to show')(1201,1240)
  PsiElement(Markdown:WHITE_SPACE)(' ')(1240,1241)
  ASTWrapperPsiElement(Markdown:Markdown:INLINE_LINK)(1241,1274)  &lt;============[üî• WE WANT THIS PARENT üî•]=========
    ASTWrapperPsiElement(Markdown:Markdown:LINK_TEXT)(1241,1252)
      PsiElement(Markdown:Markdown:[)('[')(1241,1242)
      PsiElement(Markdown:Markdown:TEXT)('SonarQube')(1242,1251)  &lt;============[üî• EDITOR CARET IS HERE üî•]========
      PsiElement(Markdown:Markdown:])(']')(1251,1252)
    PsiElement(Markdown:Markdown:()('(')(1252,1253)
    MarkdownLinkDestinationImpl(Markdown:Markdown:LINK_DESTINATION)(1253,1273)
      PsiElement(Markdown:Markdown:GFM_AUTOLINK)('http://sonarqube.org')(1253,1273)
    PsiElement(Markdown:Markdown:))(')')(1273,1274)
  PsiElement(Markdown:WHITE_SPACE)(' ')(1274,1275)
  PsiElement(Markdown:Markdown:TEXT)('issues directly within your IntelliJ IDE.')(1275,1316)
  PsiElement(Markdown:Markdown:EOL)('\n')(1316,1317)
  PsiElement(Markdown:Markdown:TEXT)('Currently the plugin is build to work in IntelliJ IDEA,')(1317,1372)
  PsiElement(Markdown:WHITE_SPACE)(' ')(1372,1373)
  PsiElement(Markdown:Markdown:TEXT)('RubyMine,')(1373,1382)
  PsiElement(Markdown:WHITE_SPACE)(' ')(1382,1383)
  PsiElement(Markdown:Markdown:TEXT)('WebStorm,')(1383,1392)
  PsiElement(Markdown:WHITE_SPACE)(' ')(1392,1393)
  PsiElement(Markdown:Markdown:TEXT)('PhpStorm,')(1393,1402)
  PsiElement(Markdown:WHITE_SPACE)(' ')(1402,1403)
  PsiElement(Markdown:Markdown:TEXT)('PyCharm,')(1403,1411)
  PsiElement(Markdown:WHITE_SPACE)(' ')(1411,1412)
  PsiElement(Markdown:Markdown:TEXT)('AppCode and Android Studio with any programming ... SonarQube.')(1412,1498)
PsiElement(Markdown:Markdown:EOL)('\n')(1498,1499)
</code></pre></div></div>

<p>There are a few things to note from this tree.</p>

<ol>
  <li>The caret in the editor selects a PSI element that is at the leaf level of the selection.</li>
  <li>This will require us to walk up the tree (navigate to the parents, and their parents, and so on).
We have to use a <code class="language-plaintext highlighter-rouge">MarkdownTokenTypes</code> (singular) or <code class="language-plaintext highlighter-rouge">MarkdownTokenTypeSets</code> (a set).</li>
</ol>

<ul>
  <li>An example is that we start w/ a <code class="language-plaintext highlighter-rouge">TEXT</code>, then move up to <code class="language-plaintext highlighter-rouge">LINK_TEXT</code>, then move up to
<code class="language-plaintext highlighter-rouge">INLINE_LINK</code>.</li>
</ul>

<ol>
  <li>This will require us to walk down the tree (navigate to the children, and their children, and so
on). Similarly, we can use the same token types or token type sets above.</li>
</ol>

<ul>
  <li>An example is that we start w/ a <code class="language-plaintext highlighter-rouge">INLINE_LINK</code> and drill down the kids, then move down to the
<code class="language-plaintext highlighter-rouge">LINK_DESTINATION</code>.</li>
</ul>

<p>Here‚Äôs the code that does exactly this. And it stores the result in a <code class="language-plaintext highlighter-rouge">LinkInfo</code> data class object.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">data class</span> <span class="nc">LinkInfo</span><span class="p">(</span><span class="kd">var</span> <span class="py">parentLinkElement</span><span class="p">:</span> <span class="nc">PsiElement</span><span class="p">,</span> <span class="kd">var</span> <span class="py">linkText</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="kd">var</span> <span class="py">linkDestination</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span>

<span class="cm">/**
 * This function tries to find the first element which is a link, by walking up the tree starting w/ the element that
 * is currently under the caret.
 *
 * To simplify, something like `PsiUtilCore.getElementType(element) == INLINE_LINK` is evaluated for each element
 * starting from the element under the caret, then visiting its parents, and their parents, etc, until a node of type
 * `INLINE_LINK` is found, actually, a type contained in [MarkdownTokenTypeSets.LINKS].
 */</span>
<span class="k">private</span> <span class="k">fun</span> <span class="nf">findLink</span><span class="p">(</span><span class="n">editor</span><span class="p">:</span> <span class="nc">Editor</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span> <span class="nc">Project</span><span class="p">,</span> <span class="n">psiFile</span><span class="p">:</span> <span class="nc">PsiFile</span><span class="p">):</span> <span class="nc">LinkInfo</span><span class="p">?</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">offset</span> <span class="p">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">caretModel</span><span class="p">.</span><span class="n">offset</span>
  <span class="kd">val</span> <span class="py">elementAtCaret</span><span class="p">:</span> <span class="nc">PsiElement</span><span class="p">?</span> <span class="p">=</span> <span class="n">psiFile</span><span class="p">.</span><span class="nf">findElementAt</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>

  <span class="c1">// Find the first parent of the element at the caret, which is a link.</span>
  <span class="kd">val</span> <span class="py">parentLinkElement</span> <span class="p">=</span> <span class="nf">findParentElement</span><span class="p">(</span><span class="n">elementAtCaret</span><span class="p">,</span> <span class="nc">MarkdownTokenTypeSets</span><span class="p">.</span><span class="nc">LINKS</span><span class="p">)</span>

  <span class="kd">val</span> <span class="py">linkTextElement</span> <span class="p">=</span> <span class="nf">findChildElement</span><span class="p">(</span><span class="n">parentLinkElement</span><span class="p">,</span> <span class="nc">MarkdownTokenTypeSets</span><span class="p">.</span><span class="nc">LINK_TEXT</span><span class="p">)</span>
  <span class="kd">val</span> <span class="py">textElement</span> <span class="p">=</span> <span class="nf">findChildElement</span><span class="p">(</span><span class="n">linkTextElement</span><span class="p">,</span> <span class="nc">MarkdownTokenTypes</span><span class="p">.</span><span class="nc">TEXT</span><span class="p">)</span>
  <span class="kd">val</span> <span class="py">linkDestinationElement</span> <span class="p">=</span> <span class="nf">findChildElement</span><span class="p">(</span><span class="n">parentLinkElement</span><span class="p">,</span> <span class="nc">MarkdownTokenTypeSets</span><span class="p">.</span><span class="nc">LINK_DESTINATION</span><span class="p">)</span>

  <span class="kd">val</span> <span class="py">linkText</span> <span class="p">=</span> <span class="n">textElement</span><span class="o">?.</span><span class="n">text</span>
  <span class="kd">val</span> <span class="py">linkDestination</span> <span class="p">=</span> <span class="n">linkDestinationElement</span><span class="o">?.</span><span class="n">text</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">linkText</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span> <span class="n">linkDestination</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span> <span class="n">parentLinkElement</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span> <span class="k">null</span>

  <span class="nf">println</span><span class="p">(</span><span class="s">"Top level element of type contained in MarkdownTokenTypeSets.LINKS found! üéâ"</span><span class="p">)</span>
  <span class="nf">println</span><span class="p">(</span><span class="s">"linkText: $linkText, linkDest: $linkDestination"</span><span class="p">)</span>
  <span class="k">return</span> <span class="nc">LinkInfo</span><span class="p">(</span><span class="n">parentLinkElement</span><span class="p">,</span> <span class="n">linkText</span><span class="p">,</span> <span class="n">linkDestination</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
      <h4 id="finding-elements-up-the-tree-parents">
        
        
          Finding elements up the tree (parents) <a href="#finding-elements-up-the-tree-parents">#</a>
        
        
      </h4>
    

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">fun</span> <span class="nf">findParentElement</span><span class="p">(</span><span class="n">element</span><span class="p">:</span> <span class="nc">PsiElement</span><span class="p">?,</span> <span class="n">tokenSet</span><span class="p">:</span> <span class="nc">TokenSet</span><span class="p">):</span> <span class="nc">PsiElement</span><span class="p">?</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">element</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span> <span class="k">null</span>
  <span class="k">return</span> <span class="nc">PsiTreeUtil</span><span class="p">.</span><span class="nf">findFirstParent</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">callCheckCancelled</span><span class="p">()</span>
    <span class="kd">val</span> <span class="py">node</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">node</span>
    <span class="n">node</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">tokenSet</span><span class="p">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">elementType</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
      <h4 id="finding-elements-down-the-tree-children">
        
        
          Finding elements down the tree (children) <a href="#finding-elements-down-the-tree-children">#</a>
        
        
      </h4>
    

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">fun</span> <span class="nf">findChildElement</span><span class="p">(</span><span class="n">element</span><span class="p">:</span> <span class="nc">PsiElement</span><span class="p">?,</span> <span class="n">token</span><span class="p">:</span> <span class="nc">IElementType</span><span class="p">?):</span> <span class="nc">PsiElement</span><span class="p">?</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nf">findChildElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="nc">TokenSet</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">fun</span> <span class="nf">findChildElement</span><span class="p">(</span><span class="n">element</span><span class="p">:</span> <span class="nc">PsiElement</span><span class="p">?,</span> <span class="n">tokenSet</span><span class="p">:</span> <span class="nc">TokenSet</span><span class="p">):</span> <span class="nc">PsiElement</span><span class="p">?</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">element</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span> <span class="k">null</span>

  <span class="kd">val</span> <span class="py">processor</span><span class="p">:</span> <span class="nc">FindElement</span><span class="p">&lt;</span><span class="nc">PsiElement</span><span class="p">&gt;</span> <span class="p">=</span>
      <span class="kd">object</span> <span class="err">: </span><span class="nc">FindElement</span><span class="p">&lt;</span><span class="nc">PsiElement</span><span class="p">&gt;()</span> <span class="p">{</span>
        <span class="c1">// If found, returns false. Otherwise returns true.</span>
        <span class="k">override</span> <span class="k">fun</span> <span class="nf">execute</span><span class="p">(</span><span class="n">each</span><span class="p">:</span> <span class="nc">PsiElement</span><span class="p">):</span> <span class="nc">Boolean</span> <span class="p">{</span>
          <span class="nf">callCheckCancelled</span><span class="p">()</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">tokenSet</span><span class="p">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">each</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">elementType</span><span class="p">))</span> <span class="k">return</span> <span class="nf">setFound</span><span class="p">(</span><span class="n">each</span><span class="p">)</span>
          <span class="k">else</span> <span class="k">return</span> <span class="k">true</span>
        <span class="p">}</span>
      <span class="p">}</span>

  <span class="n">element</span><span class="p">.</span><span class="nf">accept</span><span class="p">(</span><span class="kd">object</span> <span class="err">: </span><span class="nc">PsiRecursiveElementWalkingVisitor</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">visitElement</span><span class="p">(</span><span class="n">element</span><span class="p">:</span> <span class="nc">PsiElement</span><span class="p">)</span> <span class="p">{</span>
      <span class="nf">callCheckCancelled</span><span class="p">()</span>
      <span class="kd">val</span> <span class="py">isFound</span> <span class="p">=</span> <span class="p">!</span><span class="n">processor</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">isFound</span><span class="p">)</span> <span class="nf">stopWalking</span><span class="p">()</span>
      <span class="k">else</span> <span class="k">super</span><span class="p">.</span><span class="nf">visitElement</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">})</span>

  <span class="k">return</span> <span class="n">processor</span><span class="p">.</span><span class="n">foundElement</span>
  <span class="p">}</span>
</code></pre></div></div>
      <h4 id="threading-considerations">
        
        
          Threading considerations <a href="#threading-considerations">#</a>
        
        
      </h4>
    

<p>Here are the threading rules:</p>

<ol>
  <li>PSI access can happen in any thread (EDT or background), as long as the read lock (via its read
action) is acquired before doing so.</li>
  <li>PSI mutation can only happen in the EDT (not a background thread), since as soon as the write
lock (via its write action) is acquired, that means that code is now running in the EDT.</li>
</ol>

<p>Here‚Äôs the action implementation that calls the code shown above. And it uses a very optimized
approach to acquiring read and write locks, and using the background thread for blocking network IO.</p>

<ol>
  <li>The background thread w/ read action is used to find the hyperlink.</li>
  <li>The background thread is used to shorten this long hyperlink w/ a short one. This entails making
blocking network IO call. And no locks are held during this phase.</li>
  <li>Finally, a write action is acquired in the EDT to actually mutate the PSI tree w/ the information
from the first 2 parts above. This is where the long link is replaced w/ the short link and the
PSI is mutated.</li>
</ol>

<p>And all 3 operations are done in a <code class="language-plaintext highlighter-rouge">Task.Backgroundable</code> which can be cancelled at anytime and it
will end as soon as it can w/out changing anything under the caret in the editor.</p>

<ul>
  <li>If the task actually goes to completion then a notification is shown reporting that the background
task was run successfully.</li>
  <li>And if it gets cancelled in the meantime, then a dialog box is shown w/ an error message.</li>
</ul>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">EditorReplaceLink</span><span class="p">(</span><span class="kd">val</span> <span class="py">shortenUrlService</span><span class="p">:</span> <span class="nc">ShortenUrlService</span> <span class="p">=</span> <span class="nc">TinyUrl</span><span class="p">())</span> <span class="p">:</span> <span class="nc">AnAction</span><span class="p">()</span> <span class="p">{</span>
  <span class="cm">/**
   * For some tests this is not initialized, but accessed when running [doWorkInBackground]. Use [callCheckCancelled]
   * instead of a direct call to `CheckCancelled.invoke()`.
   */</span>
  <span class="k">private</span> <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">checkCancelled</span><span class="p">:</span> <span class="nc">CheckCancelled</span>
  <span class="nd">@VisibleForTesting</span>
  <span class="k">private</span> <span class="kd">var</span> <span class="py">myIndicator</span><span class="p">:</span> <span class="nc">ProgressIndicator</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">actionPerformed</span><span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nc">AnActionEvent</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">editor</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nf">getRequiredData</span><span class="p">(</span><span class="nc">CommonDataKeys</span><span class="p">.</span><span class="nc">EDITOR</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">psiFile</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nf">getRequiredData</span><span class="p">(</span><span class="nc">CommonDataKeys</span><span class="p">.</span><span class="nc">PSI_FILE</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">project</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nf">getRequiredData</span><span class="p">(</span><span class="nc">CommonDataKeys</span><span class="p">.</span><span class="nc">PROJECT</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">progressTitle</span> <span class="p">=</span> <span class="s">"Doing heavy PSI mutation"</span>

    <span class="kd">object</span> <span class="err">: </span><span class="nc">Task</span><span class="p">.</span><span class="nc">Backgroundable</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">progressTitle</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="py">result</span><span class="p">:</span> <span class="nc">Boolean</span> <span class="p">=</span> <span class="k">false</span>

      <span class="k">override</span> <span class="k">fun</span> <span class="nf">run</span><span class="p">(</span><span class="n">indicator</span><span class="p">:</span> <span class="nc">ProgressIndicator</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nc">PluginManagerCore</span><span class="p">.</span><span class="n">isUnitTestMode</span><span class="p">)</span> <span class="p">{</span>
          <span class="nf">println</span><span class="p">(</span><span class="s">"üî• Is in unit testing mode üî•Ô∏è"</span><span class="p">)</span>
          <span class="c1">// Save a reference to this indicator for testing.</span>
          <span class="n">myIndicator</span> <span class="p">=</span> <span class="n">indicator</span>
        <span class="p">}</span>
        <span class="n">checkCancelled</span> <span class="p">=</span> <span class="nc">CheckCancelled</span><span class="p">(</span><span class="n">indicator</span><span class="p">,</span> <span class="n">project</span><span class="p">)</span>
        <span class="n">result</span> <span class="p">=</span> <span class="nf">doWorkInBackground</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">psiFile</span><span class="p">,</span> <span class="n">project</span><span class="p">)</span>
      <span class="p">}</span>

      <span class="k">override</span> <span class="k">fun</span> <span class="nf">onFinished</span><span class="p">()</span> <span class="p">{</span>
        <span class="nc">Pair</span><span class="p">(</span><span class="s">"Background task completed"</span><span class="p">,</span> <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="s">"Link shortened"</span> <span class="k">else</span> <span class="s">"Nothing to do"</span><span class="p">).</span><span class="nf">notify</span><span class="p">()</span>
      <span class="p">}</span>
    <span class="p">}.</span><span class="nf">queue</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="k">enum</span> <span class="kd">class</span> <span class="nc">RunningState</span> <span class="p">{</span>
    <span class="nc">NOT_STARTED</span><span class="p">,</span> <span class="nc">IS_RUNNING</span><span class="p">,</span> <span class="nc">HAS_STOPPED</span><span class="p">,</span> <span class="nc">IS_CANCELLED</span>
  <span class="p">}</span>

  <span class="nd">@VisibleForTesting</span>
  <span class="k">fun</span> <span class="nf">isRunning</span><span class="p">():</span> <span class="nc">RunningState</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">myIndicator</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nc">NOT_STARTED</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">when</span> <span class="p">{</span>
        <span class="n">myIndicator</span><span class="o">!!</span><span class="p">.</span><span class="n">isCanceled</span> <span class="p">-&gt;</span> <span class="nc">IS_CANCELLED</span>
        <span class="n">myIndicator</span><span class="o">!!</span><span class="p">.</span><span class="n">isRunning</span>  <span class="p">-&gt;</span> <span class="nc">IS_RUNNING</span>
        <span class="k">else</span>                     <span class="p">-&gt;</span> <span class="nc">HAS_STOPPED</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nd">@VisibleForTesting</span>
  <span class="k">fun</span> <span class="nf">isCanceled</span><span class="p">():</span> <span class="nc">Boolean</span> <span class="p">=</span> <span class="n">myIndicator</span><span class="o">?.</span><span class="n">isCanceled</span> <span class="o">?:</span> <span class="k">false</span>

  <span class="cm">/**
   * This function returns true when it executes successfully. If there is no work for this function to do then it
   * returns false. However, if the task is cancelled (when wrapped w/ a [Task.Backgroundable], then it will throw
   * an exception (and aborts) when [callCheckCancelled] is called.
   */</span>
  <span class="nd">@VisibleForTesting</span>
  <span class="k">fun</span> <span class="nf">doWorkInBackground</span><span class="p">(</span><span class="n">editor</span><span class="p">:</span> <span class="nc">Editor</span><span class="p">,</span> <span class="n">psiFile</span><span class="p">:</span> <span class="nc">PsiFile</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span> <span class="nc">Project</span><span class="p">):</span> <span class="nc">Boolean</span> <span class="p">{</span>
    <span class="c1">// Acquire a read lock in order to find the link information.</span>
    <span class="kd">val</span> <span class="py">linkInfo</span> <span class="p">=</span> <span class="nf">runReadAction</span> <span class="p">{</span> <span class="nf">findLink</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">psiFile</span><span class="p">)</span> <span class="p">}</span>

    <span class="nf">callCheckCancelled</span><span class="p">()</span>

    <span class="c1">// Actually shorten the link in this background thread (ok to block here).</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">linkInfo</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span> <span class="k">false</span>
    <span class="n">linkInfo</span><span class="p">.</span><span class="n">linkDestination</span> <span class="p">=</span> <span class="n">shortenUrlService</span><span class="p">.</span><span class="nf">shorten</span><span class="p">(</span><span class="n">linkInfo</span><span class="p">.</span><span class="n">linkDestination</span><span class="p">)</span> <span class="c1">// Blocking call, does network IO.</span>

    <span class="nf">callCheckCancelled</span><span class="p">()</span>

    <span class="c1">// Mutate the PSI in this write command action.</span>
    <span class="c1">// - The write command action enables undo.</span>
    <span class="c1">// - The lambda inside of this call runs in the EDT.</span>
    <span class="nc">WriteCommandAction</span><span class="p">.</span><span class="nf">runWriteCommandAction</span><span class="p">(</span><span class="n">project</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(!</span><span class="n">psiFile</span><span class="p">.</span><span class="n">isValid</span><span class="p">)</span> <span class="k">return</span><span class="nd">@runWriteCommandAction</span>
      <span class="nf">replaceExistingLinkWith</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">linkInfo</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nf">callCheckCancelled</span><span class="p">()</span>

    <span class="k">return</span> <span class="k">true</span>
  <span class="p">}</span>

  <span class="c1">// All the other functions shown in paragraphs above about going up and down the PSI tree.</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Notes on <code class="language-plaintext highlighter-rouge">callCheckCancelled()</code>:</p>

<ol>
  <li>It is also important to have checks to see whether the task has been cancelled or not through out
the code. You will find these calls in the functions to walk and up down the tree above. The idea
is to include these in every iteration in a loop to ensure that the task is aborted if this task
cancellation is detected as soon as possible.</li>
  <li>Also, in some other places in the code where make heavy use of the PSI API, we can avoid making
these checks, since the JetBrains code is doing these cancellation checks for us. However, in
places where we are mainly manipulating our own code, we have to make these checks manually.</li>
</ol>

<p>Here‚Äôs the <code class="language-plaintext highlighter-rouge">CheckCancelled</code> class that is used throughout the code.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">callCheckCancelled</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="n">checkCancelled</span><span class="p">.</span><span class="nf">invoke</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nc">UninitializedPropertyAccessException</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// For some tests [checkCancelled] is not initialized. And accessing a lateinit var will throw an exception.</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**
 * Both parameters are marked Nullable for testing. In unit tests, a class of this object is not created.
 */</span>
<span class="kd">class</span> <span class="nc">CheckCancelled</span><span class="p">(</span><span class="k">private</span> <span class="kd">val</span> <span class="py">indicator</span><span class="p">:</span> <span class="nc">ProgressIndicator</span><span class="p">?,</span> <span class="k">private</span> <span class="kd">val</span> <span class="py">project</span><span class="p">:</span> <span class="nc">Project</span><span class="p">?)</span> <span class="p">{</span>
  <span class="k">operator</span> <span class="k">fun</span> <span class="nf">invoke</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">indicator</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span> <span class="n">project</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span>

    <span class="nf">println</span><span class="p">(</span><span class="s">"Checking for cancellation"</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">indicator</span><span class="p">.</span><span class="n">isCanceled</span><span class="p">)</span> <span class="p">{</span>
      <span class="nf">println</span><span class="p">(</span><span class="s">"Task was cancelled"</span><span class="p">)</span>
      <span class="nc">ApplicationManager</span>
          <span class="p">.</span><span class="nf">getApplication</span><span class="p">()</span>
          <span class="p">.</span><span class="nf">invokeLater</span> <span class="p">{</span>
            <span class="nc">Messages</span><span class="p">.</span><span class="nf">showWarningDialog</span><span class="p">(</span>
                <span class="n">project</span><span class="p">,</span> <span class="s">"Task was cancelled"</span><span class="p">,</span> <span class="s">"Cancelled"</span><span class="p">)</span>
          <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">indicator</span><span class="p">.</span><span class="nf">checkCanceled</span><span class="p">()</span>
    <span class="c1">// Can use ProgressManager.checkCancelled() as well, if we don't want to pass the indicator around.</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
      <h3 id="additional-references">
        
        
          Additional references <a href="#additional-references">#</a>
        
        
      </h3>
    

<p>Please take a look at the JetBrains (JB) Platform SDK DevGuide
<a href="https://www.jetbrains.org/intellij/sdk/docs/basics/architectural_overview/psi.html">section on PSI</a>.</p>

<p>Also, please take a look at the <a href="#vfs-and-document">VFS and Document section</a> to get an idea of the
other ways to access file contents in your plugin.</p>

<ol>
  <li><a href="https://www.jetbrains.org/intellij/sdk/docs/basics/architectural_overview/general_threading_rules.html">JB docs on threading</a></li>
  <li><a href="https://www.jetbrains.org/intellij/sdk/docs/reference_guide/performance/performance.html#avoiding-ui-freezes">Threading issues</a></li>
  <li><a href="https://github.com/JetBrains/android/blob/master/android/src/com/android/tools/idea/actions/ExportProjectZip.java"><code class="language-plaintext highlighter-rouge">ExportProjectZip.java</code> example</a></li>
</ol>
      <h2 id="dynamic-plugins">
        
        
          Dynamic plugins <a href="#dynamic-plugins">#</a>
        
        
      </h2>
    

<p>One of the biggest changes that JetBrains has introduced to the platform SDK in 2020 is the
introduction of
<a href="https://www.jetbrains.org/intellij/sdk/docs/basics/plugin_structure/dynamic_plugins.html">Dynamic Plugins</a>.
Moving forwards the use of components of any kind are banned.</p>

<p>Here are some reasons why:</p>

<ol>
  <li>The use of components result in plugins that are unloadable (due to it being impossible to
dereference the Plugin component classes that was loaded by a classloader when IDEA itself
launched).</li>
  <li>Also, they impact startup performance since code is not lazily loaded if its needed, which slows
down IDEA startup.</li>
  <li>Plugins can be kept around for a long time even after they might be unloaded, due to attaching
disposer to a parent that might outlive the lifetime of the project itself.</li>
</ol>

<p>In the new dynamic world, everything is loaded lazily and can be garbage collected. Here is more
information on the
<a href="https://www.jetbrains.org/intellij/sdk/docs/basics/plugin_structure/plugin_components.html">deprecation of components</a>.</p>

<p>There are some caveats of doing this that you have to keep in mind if you are used to working with
components.</p>

<ol>
  <li>Here‚Äôs a
<a href="https://jetbrains.org/intellij/sdk/docs/basics/plugin_structure/plugin_components.html">very short migration guide from JetBrains</a>
that provides some highlights of what to do in order to move components over to be services,
<a href="https://www.plugin-dev.com/intellij/general/plugin-initial-load/">startup activities</a>,
listeners, or extensions.</li>
  <li>You have to pick different parent disposables for services, extensions, or listeners (in what
used to be a component). You can‚Äôt scope a
<a href="https://jetbrains.org/intellij/sdk/docs/basics/disposers.html#choosing-a-disposable-parent">Disposable</a>
to the project anymore, since the plugin can be unloaded during the life of a project.</li>
  <li>Don‚Äôt cache copies of the implementations of registered extension points, as these might cause
leaks due to the dynamic nature of the plugin. Here‚Äôs more information on
<a href="https://jetbrains.org/intellij/sdk/docs/basics/plugin_structure/plugin_extension_points.html#dynamic-extension-points">dynamic extension points</a>.
These are extension points that are marked as dynamic so that IDEA can reload them if needed.</li>
  <li>Please read up on
<a href="https://jetbrains.org/intellij/sdk/docs/basics/plugin_structure/dynamic_plugins.html">the dynamic plugins restrictions and troubleshooting guide</a>
that might be of use as you migrate your components to be dynamic.</li>
  <li>Plugins now support
<a href="https://www.jetbrains.org/intellij/sdk/docs/basics/ide_development_instance.html#enabling-auto-reload">auto-reloading</a>,
which you can disable if this causes you issues.</li>
</ol>
      <h3 id="extension-points-poststartupactivity-backgroundpoststartupactivity-to-initialize-a-plugin-on-project-load">
        
        
          Extension points postStartupActivity, backgroundPostStartupActivity to initialize a plugin on project load <a href="#extension-points-poststartupactivity-backgroundpoststartupactivity-to-initialize-a-plugin-on-project-load">#</a>
        
        
      </h3>
    

<p>There are 2 extension points to do just this <code class="language-plaintext highlighter-rouge">com.intellij.postStartupActivity</code> and
<code class="language-plaintext highlighter-rouge">com.intellij.backgroundPostStartupActivity</code>.</p>

<ul>
  <li><a href="https://www.jetbrains.org/intellij/sdk/docs/basics/plugin_structure/plugin_components.html">Official docs</a></li>
  <li><a href="https://intellij-support.jetbrains.com/hc/en-us/community/posts/360002476840-How-to-auto-start-initialize-plugin-on-project-loaded-">Usage examples</a></li>
</ul>

<p>Here are all the ways in which to use a <code class="language-plaintext highlighter-rouge">StartupActivity</code>:</p>

<ul>
  <li>Use a <code class="language-plaintext highlighter-rouge">postStartupActivity</code> to run something on the EDT during project open.</li>
  <li>Use a <code class="language-plaintext highlighter-rouge">postStartupActivity</code> implementing <code class="language-plaintext highlighter-rouge">DumbAware</code> to run something on a background thread
during project open in parallel with other dumb-aware post-startup activities. Indexing is not
complete when these are running.</li>
  <li>Use a <code class="language-plaintext highlighter-rouge">backgroundPostStartupActivity</code> to run something on a background thread approx 5 seconds
after project open.</li>
  <li>More information from the IntelliJ platform codebase about these
<a href="https://github.com/JetBrains/intellij-community/blob/165e3b323c90e884972999e546f1e7085995ef7d/platform/service-container/overview.md">startup activities</a>.</li>
</ul>

<blockquote>
  <p>üí° You wil find many examples of how these can be used in the
<a href="#migration-strategies">migration strategies</a> section.</p>
</blockquote>
      <h3 id="light-services">
        
        
          Light services <a href="#light-services">#</a>
        
        
      </h3>
    

<p>A light service allows you to declare a class as a service simply by using an annotation and not
having to create a corresponding entry in
<a href="https://plugins.jetbrains.com/docs/intellij/plugin-configuration-file.html"><code class="language-plaintext highlighter-rouge">plugin.xml</code></a>.</p>

<blockquote>
  <p>Read all about light services
<a href="https://www.jetbrains.org/intellij/sdk/docs/basics/plugin_structure/plugin_services.html#light-services">here</a>.</p>
</blockquote>

<p>The following are some code examples of using the <code class="language-plaintext highlighter-rouge">@Service</code> annotation for a very simple service
that isn‚Äôt project or module scoped (but is application scoped).</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.intellij.openapi.components.Service</span>
<span class="k">import</span> <span class="nn">com.intellij.openapi.components.ServiceManager</span>

<span class="nd">@Service</span>
<span class="kd">class</span> <span class="nc">LightService</span> <span class="p">{</span>

  <span class="kd">val</span> <span class="py">instance</span><span class="p">:</span> <span class="nc">LightService</span>
    <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="nc">ServiceManager</span><span class="p">.</span><span class="nf">getService</span><span class="p">(</span><span class="nc">LightService</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>

  <span class="k">fun</span> <span class="nf">serviceFunction</span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">println</span><span class="p">(</span><span class="s">"LightService.serviceFunction() run"</span><span class="p">)</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<p>Notes on the snippet:</p>

<ul>
  <li>There is no need to register these w/ <code class="language-plaintext highlighter-rouge">plugin.xml</code> making them really easy to use.</li>
  <li>Depending on the constructor that is overloaded, IDEA will figure out whether this is a project,
module, or application scope service.</li>
  <li>The only restriction to using light services is that they must be <code class="language-plaintext highlighter-rouge">final</code> (which all Kotlin
classes are by default).</li>
</ul>

<blockquote>
  <p>‚ö†Ô∏è The use of module scoped light services are discouraged, and not supported.</p>

  <p>‚ö†Ô∏è You might find yourself looking for a <code class="language-plaintext highlighter-rouge">projectService</code> declaration that‚Äôs missing from
<code class="language-plaintext highlighter-rouge">plugin.xml</code> but is still available as a service, in this case, make sure to look out for the
following annotation on the service class <code class="language-plaintext highlighter-rouge">@Service</code>.</p>
</blockquote>

<p>Here‚Äôs a code snippet for a light service that is scoped to a project.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">class</span> <span class="nc">LightService</span><span class="p">(</span><span class="k">private</span> <span class="kd">val</span> <span class="py">project</span><span class="p">:</span> <span class="nc">Project</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
    <span class="k">fun</span> <span class="nf">getInstance</span><span class="p">(</span><span class="n">project</span><span class="p">:</span> <span class="nc">Project</span><span class="p">):</span> <span class="nc">LightService</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nc">ServiceManager</span><span class="p">.</span><span class="nf">getService</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="nc">LightService</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">fun</span> <span class="nf">serviceFunction</span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">println</span><span class="p">(</span><span class="s">"LightService.serviceFunction() run w/ project: $project"</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>üí°Ô∏è You can save a reference to the open project, since a new instance of a service is created per
project (for project-scope services).</p>
</blockquote>
      <h3 id="migration-strategies">
        
        
          Migration strategies <a href="#migration-strategies">#</a>
        
        
      </h3>
    

<p>There are a handful of ways to go about removing components and replacing them w/ services, startup
activities, listeners, etc. The following is a list of common refactoring strategies that you can
use depending on your specific needs.</p>
      <h4 id="1-component---service">
        
        
          1. Component -&gt; Service <a href="#1-component---service">#</a>
        
        
      </h4>
    

<p>In many cases you can just replace the component w/ a service, and get rid of the project opened and
closed methods, along w/ the component name and dispose component methods.</p>

<p>Another thing to watch out for is to make sure that the <code class="language-plaintext highlighter-rouge">getInstance()</code> methods all make a
<code class="language-plaintext highlighter-rouge">getService()</code> call and not <code class="language-plaintext highlighter-rouge">getComponent()</code>. Look at tests as well to see if they are using
<code class="language-plaintext highlighter-rouge">getComponent()</code> instead of <code class="language-plaintext highlighter-rouge">getService()</code> to get an instance of the migrated component.</p>

<p>Here‚Äôs an XML snippet of what this might look like:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;projectService</span> <span class="na">serviceImplementation=</span><span class="s">"MyServiceClass"</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<blockquote>
  <p>üí°Ô∏è If you use a <a href="#light-services">light service</a> then you can skip registering the service class
in <code class="language-plaintext highlighter-rouge">plugin.xml</code>.</p>
</blockquote>

<p>Here‚Äôs the code for the service class:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MyServiceClass</span> <span class="p">:</span> <span class="nc">Disposable</span> <span class="p">{</span>
  <span class="k">fun</span> <span class="nf">dispose</span><span class="p">()</span> <span class="p">{</span> <span class="cm">/** Custom logic that runs when the project is closed. */</span> <span class="p">}</span>

  <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
    <span class="nd">@JvmStatic</span>
    <span class="k">fun</span> <span class="nf">getInstance</span><span class="p">(</span><span class="n">project</span><span class="p">:</span> <span class="nc">Project</span><span class="p">)</span> <span class="p">=</span> <span class="n">project</span><span class="p">.</span><span class="nf">getService</span><span class="p">(</span><span class="nc">MyServiceClass</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>üí°Ô∏è If you don‚Äôt need to perform any custom login in your service when the project is closed, then
there is no need to implement <code class="language-plaintext highlighter-rouge">Disposable</code> and you can just remove the <code class="language-plaintext highlighter-rouge">dispose()</code> method.</p>
</blockquote>

<blockquote>
      <h4 id="disposing-the-service-and-choosing-a-parent-disposable">
        
        
          Disposing the service and choosing a parent disposable <a href="#disposing-the-service-and-choosing-a-parent-disposable">#</a>
        
        
      </h4>
    

  <p>In order to clean up after the service, it can simply implement the <code class="language-plaintext highlighter-rouge">Disposable</code> interface and put
the logic for clean up in the <code class="language-plaintext highlighter-rouge">dispose()</code> method. This should suffice for most situations, since
IDEA will
<a href="https://jetbrains.org/intellij/sdk/docs/basics/disposers.html#automatically-disposed-objects">automatically take care of cleaning up</a>
the service instance.</p>

  <ol>
    <li>Application-level services are automatically disposed by the platform when the IDE is closed,
or the plugin providing the service is unloaded.</li>
    <li>Project-level services are automatically disposed when the project is closed or the plugin is
unloaded.</li>
  </ol>

  <p>However, if you still want to exert finer control over when you want your service to be disposed,
you can use <code class="language-plaintext highlighter-rouge">Disposer.register()</code> by passing a <code class="language-plaintext highlighter-rouge">Project</code> or <code class="language-plaintext highlighter-rouge">Application</code> service instance as the
parent argument.</p>
</blockquote>

<blockquote>
  <p>üí°Ô∏è Here‚Äôs more information from
<a href="https://jetbrains.org/intellij/sdk/docs/basics/disposers.html#choosing-a-disposable-parent">JetBrains official docs on choosing a disposable parent</a>.</p>
</blockquote>

<blockquote>
      <h4 id="summary">
        
        
          Summary <a href="#summary">#</a>
        
        
      </h4>
    

  <ol>
    <li>For resources required for the entire lifetime of a plugin use an application-level or
project-level service.</li>
    <li>For resources required while a dialog is displayed, use a <code class="language-plaintext highlighter-rouge">DialogWrapper.getDisposable()</code>.</li>
    <li>For resources required while a tool window is displayed, pass your instance implementing
<code class="language-plaintext highlighter-rouge">Disposable</code> to <code class="language-plaintext highlighter-rouge">Context.setDisposer()</code>.</li>
    <li>For resources w/ a shorter lifetime, create a disposable using a <code class="language-plaintext highlighter-rouge">Disposer.newDisposable()</code> and
dispose it manually using <code class="language-plaintext highlighter-rouge">Disposable.dispose()</code>.</li>
    <li>Finally, when passing our own parent object be careful about
<a href="/2020/07/14/non-capturing-lambda-problems/">non-capturing-lambdas</a>.</li>
  </ol>
</blockquote>
      <h4 id="2-component---poststartupactivity">
        
        
          2. Component -&gt; postStartupActivity <a href="#2-component---poststartupactivity">#</a>
        
        
      </h4>
    

<p>This is a very straightforward replacement of a component w/ a
<a href="#extension-points-poststartupactivity-backgroundpoststartupactivity-to-initialize-a-plugin-on-project-load">startup activity</a>.
The logic that is in <code class="language-plaintext highlighter-rouge">projectOpened()</code> simply goes into the <code class="language-plaintext highlighter-rouge">runActivity(project: Project)</code> method.
The same approach used in <a href="#1-component---service">Component -&gt; Service</a> still applies (w/ removing
needless methods and using <code class="language-plaintext highlighter-rouge">getService()</code> calls).</p>
      <h4 id="3-component---poststartupactivity--service">
        
        
          3. Component -&gt; postStartupActivity + Service <a href="#3-component---poststartupactivity--service">#</a>
        
        
      </h4>
    

<p>This is a combination of the two strategies above. Here‚Äôs a pattern that you can use to detect if
this is the right approach or not. If the component had some logic that executed in
<code class="language-plaintext highlighter-rouge">projectOpened()</code> which requires a <code class="language-plaintext highlighter-rouge">Project</code> instance then you can do the following:</p>

<ol>
  <li>Make the component a service in the <code class="language-plaintext highlighter-rouge">plugin.xml</code> file. Also, add a startup activity.</li>
  <li>Instead of your component extending <code class="language-plaintext highlighter-rouge">ProjectComponent</code> have it implement <code class="language-plaintext highlighter-rouge">Disposable</code> if you need
to run some logic when it is disposed (when the project is closed). Or just have it not implement
any interface or extend any class. Make sure to accept a parameter of <code class="language-plaintext highlighter-rouge">Project</code> in the
constructor.</li>
  <li>Rename the <code class="language-plaintext highlighter-rouge">projectOpened()</code> method to <code class="language-plaintext highlighter-rouge">onProjectOpened()</code>. Add any logic you might have had in
any <code class="language-plaintext highlighter-rouge">init{}</code> block or any other constructors to this method.</li>
  <li>Create a <code class="language-plaintext highlighter-rouge">getInstance(project: Project)</code> function that looks up the service instance from the
given project.</li>
  <li>Create a startup activity inner class called eg: <code class="language-plaintext highlighter-rouge">MyStartupActivity</code> which simply calls
<code class="language-plaintext highlighter-rouge">onProjectOpened()</code>.</li>
</ol>

<p>This is roughly what things will end up looking like:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;projectService</span> <span class="na">serviceImplementation=</span><span class="s">"MyServiceClass"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;postStartupActivity</span> <span class="na">implementation=</span><span class="s">"MyServiceClass$MyStartupActivity"</span><span class="nt">/&gt;</span>
</code></pre></div></div>

<p>And the Kotlin code changes:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MyServiceClass</span> <span class="p">{</span>
  <span class="k">fun</span> <span class="nf">onProjectOpened</span><span class="p">()</span> <span class="p">{</span> <span class="cm">/** Stuff. */</span> <span class="p">}</span>

  <span class="kd">class</span> <span class="nc">MyStartupActivity</span> <span class="p">:</span> <span class="nc">StartupActivity</span><span class="p">.</span><span class="nc">DumbAware</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">runActivity</span><span class="p">(</span><span class="n">project</span><span class="p">:</span> <span class="nc">Project</span><span class="p">)</span> <span class="p">=</span> <span class="nf">getInstance</span><span class="p">(</span><span class="n">project</span><span class="p">).</span><span class="nf">onProjectOpened</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
    <span class="nd">@JvmStatic</span>
    <span class="k">fun</span> <span class="nf">getInstance</span><span class="p">(</span><span class="n">project</span><span class="p">:</span> <span class="nc">Project</span><span class="p">):</span> <span class="nc">MyServiceClass</span> <span class="p">=</span> <span class="n">project</span><span class="p">.</span><span class="nf">getService</span><span class="p">(</span><span class="nc">YourServiceClass</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
      <h4 id="4-component---projectlistener">
        
        
          4. Component -&gt; projectListener <a href="#4-component---projectlistener">#</a>
        
        
      </h4>
    

<p>Many components just subscribe to a topic on the message bus in the <code class="language-plaintext highlighter-rouge">projectOpened()</code> method. In
these cases, it is possible to replace the component entirely by (declaratively) registering a
<a href="https://jetbrains.org/intellij/sdk/docs/basics/plugin_structure/plugin_listeners.html"><code class="language-plaintext highlighter-rouge">projectListener</code></a>
in your module‚Äôs <code class="language-plaintext highlighter-rouge">plugin.xml</code>.</p>

<p>Here‚Äôs an XML snippet of what this might look like (goes in <code class="language-plaintext highlighter-rouge">plugin.xml</code>):</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;listener</span> <span class="na">class=</span><span class="s">"MyListenerClass"</span>
          <span class="na">topic=</span><span class="s">"com.intellij.execution.testframework.sm.runner.SMTRunnerEventsListener"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;listener</span> <span class="na">class=</span><span class="s">"MyListenerClass"</span>
          <span class="na">topic=</span><span class="s">"com.intellij.execution.ExecutionListener"</span><span class="nt">/&gt;</span>
</code></pre></div></div>

<p>And the listener class itself:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MyListenerClass</span><span class="p">(</span><span class="kd">val</span> <span class="py">project</span><span class="p">:</span> <span class="nc">Project</span><span class="p">)</span> <span class="p">:</span> <span class="nc">SMTRunnerEventsAdapter</span><span class="p">(),</span> <span class="nc">ExecutionListener</span> <span class="p">{}</span>
</code></pre></div></div>
      <h4 id="5-component---projectlistener--service">
        
        
          5. Component -&gt; projectListener + Service <a href="#5-component---projectlistener--service">#</a>
        
        
      </h4>
    

<p>Sometimes a component can be replaced w/ a service and a <code class="language-plaintext highlighter-rouge">projectListener</code>, which is simply
combining two of the strategies shown above.</p>
      <h4 id="6-delete-component">
        
        
          6. Delete Component <a href="#6-delete-component">#</a>
        
        
      </h4>
    

<p>There are some situations where the component might have been deprecated already. In this case
simply remove it from the appropriate module‚Äôs <code class="language-plaintext highlighter-rouge">plugin.xml</code> and you can delete those files as well.</p>
      <h4 id="7-component---applifecyclelistener">
        
        
          7. Component -&gt; AppLifecycleListener <a href="#7-component---applifecyclelistener">#</a>
        
        
      </h4>
    

<p>There are some situations where an application component has to be launched when IDEA starts up and
it has to be notified when it shuts down. In this case you can use
<a href="https://github.com/JetBrains/intellij-community/blob/master/platform/platform-impl/src/com/intellij/ide/AppLifecycleListener.java">AppLifecycleListener</a>
to attach a
<a href="https://jetbrains.org/intellij/sdk/docs/basics/plugin_structure/plugin_listeners.html">listener</a> to
IDEA that does just
<a href="https://jetbrains.org/intellij/sdk/docs/basics/plugin_structure/plugin_components.html">this</a>.</p>
      <h2 id="vfs-document-psi">
        
        
          VFS, Document, PSI <a href="#vfs-document-psi">#</a>
        
        
      </h2>
    

<p>The virtual file system (VFS) is an abstraction that is available inside the IntelliJ Platform that
allows access to files on your computer (on your local file system, or even in JAR files), or from a
source code repository, or over the network. There are multiple ways of accessing the contents of
files in the IDE:</p>

<ol>
  <li>VFS allows access to files at the lowest level (closest the actual file system and not an
abstraction like PSI).</li>
  <li>Document provides an object model to access file contents as plain text (so its somewhere between
VFS and PSI).</li>
  <li>PSI (Program Structure Interface) allows access to the contents of a file in a hierarchical
object model which takes the syntax and semantics of specific languages into account (kind of
like how DOM represents HTML and CSS content in a web browser). You can learn more about PSI in
<a href="#psi-access-and-mutation">in this section</a>.</li>
</ol>
      <h3 id="vfs">
        
        
          VFS <a href="#vfs">#</a>
        
        
      </h3>
    

<p>The VFS is what the IntelliJ Platform uses to work with files. It provides:</p>

<ol>
  <li>A universal API for working with files regardless of where they are located (on disk, in a JAR
file, on a HTTP server, in a VCS, etc).</li>
  <li>Information for tracking file modifications and providing both new and old versions of a file
when a change is detected in a file.</li>
  <li>Ability to associate additional persistent data with a file in the VFS.</li>
</ol>

<p>The VFS manages a persistent snapshot of the files that are accessed via the IDE. These snapshots
store only those files which have been requested at least once via the VFS API. Here are some
important things to keep in mind about the nature of VFS:</p>

<ul>
  <li>The contents of the cache is refreshed asynchronously to match any changes on disk.</li>
  <li>Keep in mind that the snapshot is stored at the application level, as you might expect, so a file
that is open in multiple projects will only have one snapshot.</li>
  <li>The snapshot is updated from disk during refresh operations, which generally happen
asynchronously. All write operations made through the VFS are synchronous and the contents is
saved to disk immediately.</li>
</ul>

<blockquote>
  <p>Read more about VFS from the
<a href="https://www.jetbrains.org/intellij/sdk/docs/basics/virtual_file_system.html">official docs</a>.</p>
</blockquote>

<p>There are quite a few common scenarios that you face when using VFS to work with files that your
plugin needs. The following are some of these scenarios with code samples to help you deal with
them.</p>
      <h4 id="getting-a-list-of-all-the-virtual-files-in-a-project">
        
        
          Getting a list of all the virtual files in a project <a href="#getting-a-list-of-all-the-virtual-files-in-a-project">#</a>
        
        
      </h4>
    

<p>Snippet to get a list of virtual files by name <code class="language-plaintext highlighter-rouge">Lambdas.kt</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">getListOfProjectVirtualFilesByName</span><span class="p">(</span><span class="n">project</span><span class="p">:</span> <span class="nc">Project</span><span class="p">,</span>
                                     <span class="n">caseSensitivity</span><span class="p">:</span> <span class="nc">Boolean</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
                                     <span class="n">fileName</span><span class="p">:</span> <span class="nc">String</span> <span class="p">=</span> <span class="s">"Lambdas.kt"</span>
<span class="p">):</span> <span class="nc">MutableCollection</span><span class="p">&lt;</span><span class="nc">VirtualFile</span><span class="p">&gt;</span> <span class="p">{</span>
<span class="kd">val</span> <span class="py">scope</span> <span class="p">=</span> <span class="nc">GlobalSearchScope</span><span class="p">.</span><span class="nf">projectScope</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
<span class="k">return</span> <span class="nc">FilenameIndex</span><span class="p">.</span><span class="nf">getVirtualFilesByName</span><span class="p">(</span>
    <span class="n">project</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">caseSensitivity</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Snippet to get a list of virtual files with extension <code class="language-plaintext highlighter-rouge">kt</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">getListOfProjectVirtualFilesByExt</span><span class="p">(</span><span class="n">project</span><span class="p">:</span> <span class="nc">Project</span><span class="p">,</span>
                                    <span class="n">caseSensitivity</span><span class="p">:</span> <span class="nc">Boolean</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
                                    <span class="n">extName</span><span class="p">:</span> <span class="nc">String</span> <span class="p">=</span> <span class="s">"kt"</span>
<span class="p">):</span> <span class="nc">MutableCollection</span><span class="p">&lt;</span><span class="nc">VirtualFile</span><span class="p">&gt;</span> <span class="p">{</span>
<span class="kd">val</span> <span class="py">scope</span> <span class="p">=</span> <span class="nc">GlobalSearchScope</span><span class="p">.</span><span class="nf">projectScope</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
<span class="k">return</span> <span class="nc">FilenameIndex</span><span class="p">.</span><span class="nf">getAllFilesByExt</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">extName</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Snippet to get a list of all virtual files in a project.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">getListOfAllProjectVFiles</span><span class="p">(</span><span class="n">project</span><span class="p">:</span> <span class="nc">Project</span><span class="p">):</span> <span class="nc">MutableCollection</span><span class="p">&lt;</span><span class="nc">VirtualFile</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">collection</span> <span class="p">=</span> <span class="n">mutableListOf</span><span class="p">&lt;</span><span class="nc">VirtualFile</span><span class="p">&gt;()</span>
  <span class="nc">ProjectFileIndex</span><span class="p">.</span><span class="nf">getInstance</span><span class="p">(</span><span class="n">project</span><span class="p">).</span><span class="nf">iterateContent</span> <span class="p">{</span>
    <span class="n">collection</span> <span class="p">+=</span> <span class="n">it</span>
    <span class="c1">// Return true to process all the files (no early escape).</span>
    <span class="k">true</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">collection</span>
<span class="p">}</span>
</code></pre></div></div>
      <h4 id="attach-listeners-to-see-changes-to-virtual-files-programmatically">
        
        
          Attach listeners to see changes to virtual files programmatically <a href="#attach-listeners-to-see-changes-to-virtual-files-programmatically">#</a>
        
        
      </h4>
    

<p>You can attach the listeners programmatically or declaratively.</p>

<p>This is the deprecated way of programmatically attaching a listener for VFS changes:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">VirtualFileManager</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">addVirtualFileListener</span><span class="o">()</span>
</code></pre></div></div>

<p>The new way to add a listener programmatically is to listen to <code class="language-plaintext highlighter-rouge">VirtualFileManager.VFS_CHANGES</code>
events on the bus (aka the topic).</p>

<blockquote>
  <p>There is no way to filter for these change events by path or filename, so the logic to filer out
unwanted events needs to go in the listener.</p>
</blockquote>

<p>The following function shows how to register this in code. Note that this function runs in the EDT.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * VFS listeners are application level and will receive events for changes happening in all the projects opened by the
 * user. You may need to filter out events that aren‚Äôt relevant to your task (e.g., via
 * `ProjectFileIndex#isInContent()`). A listener for VFS events, invoked inside write-action.
 */</span>
<span class="k">private</span> <span class="k">fun</span> <span class="nf">attachListenerForProjectVFileChanges</span><span class="p">():</span> <span class="nc">Unit</span> <span class="p">{</span>
  <span class="nf">println</span><span class="p">(</span><span class="s">"MyPlugin: attachListenerForProjectFileChanges()"</span><span class="p">)</span>

  <span class="kd">val</span> <span class="py">connection</span> <span class="p">=</span> <span class="n">project</span><span class="p">.</span><span class="n">messageBus</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="cm">/*parentDisposable=*/</span> <span class="n">project</span><span class="p">)</span>
  <span class="n">connection</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span>
      <span class="nc">VirtualFileManager</span><span class="p">.</span><span class="nc">VFS_CHANGES</span><span class="p">,</span>
      <span class="kd">object</span> <span class="err">: </span><span class="nc">BulkFileListener</span> <span class="p">{</span>
        <span class="k">override</span> <span class="k">fun</span> <span class="nf">after</span><span class="p">(</span><span class="n">events</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">VFileEvent</span><span class="p">&gt;)</span> <span class="p">=</span> <span class="nf">doAfter</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
      <span class="p">})</span>
<span class="p">}</span>

<span class="k">fun</span> <span class="nf">handleEvent</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nc">VFileEvent</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">when</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">is</span> <span class="nc">VFilePropertyChangeEvent</span> <span class="p">-&gt;</span> <span class="p">{</span>
      <span class="nf">println</span><span class="p">(</span><span class="s">"VFile property change event: $event"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">is</span> <span class="nc">VFileContentChangeEvent</span>  <span class="p">-&gt;</span> <span class="p">{</span>
      <span class="nf">println</span><span class="p">(</span><span class="s">"VFile content change event: $event"</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">fun</span> <span class="nf">doAfter</span><span class="p">(</span><span class="n">events</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">VFileEvent</span><span class="p">&gt;)</span> <span class="p">{</span>
  <span class="nf">println</span><span class="p">(</span><span class="s">"VFS_CHANGES: #events: ${events.size}"</span><span class="p">)</span>
  <span class="kd">val</span> <span class="py">projectFileIndex</span> <span class="p">=</span> <span class="nc">ProjectRootManager</span><span class="p">.</span><span class="nf">getInstance</span><span class="p">(</span><span class="n">project</span><span class="p">).</span><span class="n">fileIndex</span>
  <span class="n">events</span><span class="p">.</span><span class="nf">withIndex</span><span class="p">().</span><span class="nf">forEach</span> <span class="p">{</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span> <span class="p">-&gt;</span>
    <span class="nf">println</span><span class="p">(</span><span class="s">"$index. VFile event: $event"</span><span class="p">)</span>
    <span class="c1">// Filter out file events that are not in the project's content.</span>
    <span class="n">events</span>
        <span class="p">.</span><span class="nf">filter</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">file</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">projectFileIndex</span><span class="p">.</span><span class="nf">isInContent</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">file</span><span class="o">!!</span><span class="p">)</span> <span class="p">}</span>
        <span class="p">.</span><span class="nf">forEach</span> <span class="p">{</span> <span class="nf">handleEvent</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Using this approach, the code attaching the listener itself has to be run at some point. So if this
is a listener that should run when your project is opened, then you might need to add a
<code class="language-plaintext highlighter-rouge">postStartupActivity</code>, which is just a class supplied by your plugin that will be run after the IDE
opens a project. Please read all about this in the <a href="#dynamic-plugins">dynamic plugins section</a>.</p>

<blockquote>
  <p>üí° You might want to use this approach over the declarative approach shown below in case you want
a reference to the currently open project.</p>
</blockquote>
      <h4 id="attach-listeners-to-see-changes-to-virtual-files-declaratively">
        
        
          Attach listeners to see changes to virtual files declaratively <a href="#attach-listeners-to-see-changes-to-virtual-files-declaratively">#</a>
        
        
      </h4>
    

<p>You can also register a listener declaratively in your <code class="language-plaintext highlighter-rouge">plugin.xml</code>. There are some differences to
using this approach over the code approach shown above. Instead of subscribing to a topic, you can
simply register a listener for a specific event class in your <code class="language-plaintext highlighter-rouge">plugin.xml</code>.</p>

<p>Here‚Äôs a snippet that does something similar to the code above. So the
<code class="language-plaintext highlighter-rouge">VirtualFileManager.VFS_CHANGES</code> topic is equivalent to the
<code class="language-plaintext highlighter-rouge">com.intellij.openapi.vfs.newvfs.BulkFileListener</code> class.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;applicationListeners&gt;</span>
  <span class="nt">&lt;listener</span> <span class="na">class=</span><span class="s">"MyListener"</span> <span class="na">topic=</span><span class="s">"com.intellij.openapi.vfs.newvfs.BulkFileListener"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/applicationListeners&gt;</span>
</code></pre></div></div>

<p>Here‚Äôs the code.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MyVfsListener</span> <span class="p">:</span> <span class="nc">BulkFileListener</span> <span class="p">{</span>
  <span class="nd">@Override</span>
  <span class="k">fun</span> <span class="nf">after</span><span class="p">(</span><span class="nd">@NotNull</span> <span class="n">events</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">VFileEvent</span><span class="p">?&gt;?)</span> <span class="p">{</span>
    <span class="c1">// handle the events</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>Here‚Äôs more information on registering VFS listeners in the
<a href="https://www.jetbrains.org/intellij/sdk/docs/basics/plugin_structure/plugin_listeners.html#defining-application-level-listeners">official docs</a>.</p>
</blockquote>

<blockquote>
  <p>üí° You can also declaratively attach listeners that are scoped to a project. However, this
requires that the interface / class that you will register in the XML can take a project object as
a parameter. In the case of VFS listeners it does not take a project parameter, since VFS
operations are application level. So if you want to get a hold of the currently open project, then
you have to use the programmatic approach.</p>
</blockquote>
      <h4 id="asynchronously-process-file-system-events">
        
        
          Asynchronously process file system events <a href="#asynchronously-process-file-system-events">#</a>
        
        
      </h4>
    

<p>It is possible to get these file system events asynchronously (in a background thread). Take a Look
at the
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-7cf49a16e4e15a18fa2f742635053647ae94abfb/platform/core-api/src/com/intellij/openapi/vfs/AsyncFileListener.java"><code class="language-plaintext highlighter-rouge">AsyncFileListener.java</code></a>
class for examples on how to do this. The async versions are not as trivial to implement as the
version that runs on the UI thread. Here are some notes on this:</p>

<ol>
  <li>You can register an extension for <code class="language-plaintext highlighter-rouge">vfs.asyncListener</code> that registers your async listener in
<code class="language-plaintext highlighter-rouge">plugin.xml</code>.</li>
  <li>Or you can call
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-7cf49a16e4e15a18fa2f742635053647ae94abfb/platform/core-api/src/com/intellij/openapi/vfs/VirtualFileManager.java"><code class="language-plaintext highlighter-rouge">VirtualFileManager.java</code></a>‚Äôs
<code class="language-plaintext highlighter-rouge">addVirtualFileListener()</code> method.</li>
</ol>
      <h4 id="intercept-when-the-currently-open-file-gets-saved">
        
        
          Intercept when the currently open file gets saved <a href="#intercept-when-the-currently-open-file-gets-saved">#</a>
        
        
      </h4>
    

<p>This is a code snippet that can use the <code class="language-plaintext highlighter-rouge">AppTopics.FILE_DOCUMENT_SYNC</code> topic to get an event just
before a file is saved. Read more about
<a href="https://www.jetbrains.org/intellij/sdk/docs/basics/architectural_overview/documents.html#how-do-i-get-notified-when-documents-change"><code class="language-plaintext highlighter-rouge">Document</code></a>
to get an understanding of what this event does and where it comes from.</p>

<blockquote>
  <p>Note that this listener will fire on any file that is being saved, not just the only one that is
currently being edited.</p>

  <ul>
    <li>So if you‚Äôre relying on this to fire JUST for the file that is currently open, then this is not
the way to go.</li>
    <li>However, if you want to do something before any files that are open in editors are going to be
saved, then this is the place to trap these events.</li>
  </ul>
</blockquote>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * - [Tutorial](http://arhipov.blogspot.com/2011/04/code-snippet-intercepting-on-save.html)
 * - [FileDocumentManagerListener]
 * - [AppTopics]
 */</span>
<span class="k">private</span> <span class="k">fun</span> <span class="nf">attachFileSaveListener</span><span class="p">()</span> <span class="p">{</span>
  <span class="nf">printHeader</span><span class="p">()</span>
  <span class="kd">val</span> <span class="py">connection</span> <span class="p">=</span> <span class="n">project</span><span class="p">.</span><span class="n">messageBus</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="cm">/*parentDisposable=*/</span> <span class="n">project</span><span class="p">)</span>
  <span class="n">connection</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span>
      <span class="nc">AppTopics</span><span class="p">.</span><span class="nc">FILE_DOCUMENT_SYNC</span><span class="p">,</span>
      <span class="kd">object</span> <span class="err">: </span><span class="nc">FileDocumentManagerListener</span> <span class="p">{</span>
        <span class="k">override</span> <span class="k">fun</span> <span class="nf">beforeDocumentSaving</span><span class="p">(</span><span class="n">document</span><span class="p">:</span> <span class="nc">Document</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">val</span> <span class="py">vFile</span> <span class="p">=</span> <span class="nc">FileDocumentManager</span><span class="p">.</span><span class="nf">getInstance</span><span class="p">().</span><span class="nf">getFile</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
          <span class="nf">println</span><span class="p">(</span><span class="nc">StringBuilder</span><span class="p">().</span><span class="nf">apply</span> <span class="p">{</span>
              <span class="nf">append</span><span class="p">(</span><span class="s">"A VirtualFile is about to be saved\n"</span><span class="p">)</span>
              <span class="nf">append</span><span class="p">(</span><span class="s">"\tvFile: $vFile\n"</span><span class="p">)</span>
              <span class="nf">append</span><span class="p">(</span><span class="s">"\tdocument: $document\n"</span><span class="p">)</span>
          <span class="p">})</span>
        <span class="p">}</span>
      <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>
      <h3 id="document">
        
        
          Document <a href="#document">#</a>
        
        
      </h3>
    

<p>The Document API is a way to access a file from the IDE as a simple text file. The IntelliJ Platform
handles encoding and line break conversions when loading or saving the file transparently. There are
a few ways of getting a <code class="language-plaintext highlighter-rouge">Document</code> object.</p>

<ul>
  <li>From an action using <code class="language-plaintext highlighter-rouge">e.getRequiredData(CommonDataKeys.EDITOR).document</code>.</li>
  <li>From a virtual file using <code class="language-plaintext highlighter-rouge">FileDocumentManager.document</code>.</li>
  <li>From a PSI file using <code class="language-plaintext highlighter-rouge">PsiDocumentManager.getInstance().document</code>.</li>
</ul>
      <h4 id="example-of-an-action-that-uses-the-document-api">
        
        
          Example of an action that uses the Document API <a href="#example-of-an-action-that-uses-the-document-api">#</a>
        
        
      </h4>
    

<p>Here‚Äôs an example of an action that uses the Document API to replace some selected text in the IDE
with another string.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">EditorReplaceTextAction</span> <span class="p">:</span> <span class="nc">AnAction</span><span class="p">()</span> <span class="p">{</span>
  <span class="cm">/**
   * [Tutorial](https://www.jetbrains.org/intellij/sdk/docs/tutorials/editor_basics/working_with_text.html)
   */</span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">actionPerformed</span><span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nc">AnActionEvent</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">editor</span><span class="p">:</span> <span class="nc">Editor</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nf">getRequiredData</span><span class="p">(</span><span class="nc">CommonDataKeys</span><span class="p">.</span><span class="nc">EDITOR</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">project</span><span class="p">:</span> <span class="nc">Project</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nf">getRequiredData</span><span class="p">(</span><span class="nc">CommonDataKeys</span><span class="p">.</span><span class="nc">PROJECT</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">document</span><span class="p">:</span> <span class="nc">Document</span> <span class="p">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">document</span>
    <span class="kd">val</span> <span class="py">caretModel</span><span class="p">:</span> <span class="nc">CaretModel</span> <span class="p">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">caretModel</span>
    <span class="kd">val</span> <span class="py">primaryCaret</span> <span class="p">=</span> <span class="n">caretModel</span><span class="p">.</span><span class="n">primaryCaret</span>

    <span class="c1">// start and end offsets of the selected text (based on the primaryCaret).</span>
    <span class="kd">val</span> <span class="py">selection</span> <span class="p">=</span>
        <span class="nc">Pair</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">,</span> <span class="nc">Int</span><span class="p">&gt;(</span><span class="n">primaryCaret</span><span class="p">.</span><span class="n">selectionStart</span><span class="p">,</span> <span class="n">primaryCaret</span><span class="p">.</span><span class="n">selectionEnd</span><span class="p">)</span>

    <span class="c1">// Actual content that is selected at the caret.</span>
    <span class="kd">val</span> <span class="py">selectedText</span><span class="p">:</span> <span class="nc">String</span> <span class="p">=</span> <span class="n">primaryCaret</span><span class="p">.</span><span class="n">selectedText</span><span class="o">!!</span>

    <span class="c1">// Change the document in a write action in a command (for undo).</span>
    <span class="nc">WriteCommandAction</span><span class="p">.</span><span class="nf">runWriteCommandAction</span><span class="p">(</span><span class="n">project</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">document</span><span class="p">.</span><span class="nf">replaceString</span><span class="p">(</span><span class="n">selection</span><span class="p">.</span><span class="n">first</span><span class="p">,</span> <span class="n">selection</span><span class="p">.</span><span class="n">second</span><span class="p">,</span> <span class="s">"&gt;&gt; $selectedText &lt;&lt;"</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// Deselect the selection of the text that that was just replaced.</span>
    <span class="n">primaryCaret</span><span class="p">.</span><span class="nf">removeSelection</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">update</span><span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nc">AnActionEvent</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">project</span><span class="p">:</span> <span class="nc">Project</span><span class="p">?</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="n">project</span>
    <span class="kd">val</span> <span class="py">editor</span><span class="p">:</span> <span class="nc">Editor</span><span class="p">?</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nf">getData</span><span class="p">(</span><span class="nc">CommonDataKeys</span><span class="p">.</span><span class="nc">EDITOR</span><span class="p">)</span>
    <span class="c1">// Action visible only if the editor in the open project has text selected.</span>
    <span class="n">e</span><span class="p">.</span><span class="n">presentation</span><span class="p">.</span><span class="n">isEnabledAndVisible</span> <span class="p">=</span>
        <span class="n">project</span> <span class="p">!=</span> <span class="k">null</span>
        <span class="p">&amp;&amp;</span> <span class="n">editor</span> <span class="p">!=</span> <span class="k">null</span>
        <span class="p">&amp;&amp;</span> <span class="n">editor</span><span class="p">.</span><span class="n">selectionModel</span><span class="p">.</span><span class="nf">hasSelection</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>Read more about Documents from the
<a href="https://www.jetbrains.org/intellij/sdk/docs/basics/architectural_overview/documents.html">official docs</a>.</p>
</blockquote>
      <h2 id="ui-jetbrains-ui-components-swing-and-kotlin-ui-dsl">
        
        
          UI (JetBrains UI components, Swing and Kotlin UI DSL) <a href="#ui-jetbrains-ui-components-swing-and-kotlin-ui-dsl">#</a>
        
        
      </h2>
    

<p>There are many ways for a plugin to interact w/ an end user - keyboard shortcuts that bind to
actions, and UI components that the plugin provides, which can be totally custom, or integrated into
the existing IDE‚Äôs UI components. JetBrains also provides many UI controls that are applicable for
different scenarios.</p>

<p>There is a range of components that span from simple fire and forget notifications, to more
sophisticated UI that allows intense interaction w/ the user. There is even a Kotlin DSL for UI
components that makes it relatively easy to create forms in IDEA.</p>

<p>There is even a way to create forms using Swing, which is being phased out in favor of the Kotlin UI
DSL. In addition to all of this, you can even create custom themes for IDEA.</p>

<p>One effective approach to writing UI code for plugins is to take a look at how some UI code is
written in <code class="language-plaintext highlighter-rouge">intellij-community</code> repo itself, to see how JetBrains does it. Documentation is sparse
to non existent, and the best way sometimes is to take a look at the source for IDEA itself to find
out how certain UI is created.</p>

<p>Here are good resources to take a look when considering writing UI code for plugins.</p>

<ul>
  <li><a href="https://docs.oracle.com/javase/tutorial/uiswing/layout/visual.html">Swing Layout Managers</a></li>
  <li><a href="https://docs.oracle.com/javase/tutorial/uiswing/index.html">Introduction to Swing</a></li>
  <li><a href="https://github.com/mikaelgrev/miglayout">MigLayout, used in Kotlin UI DSL</a></li>
</ul>
      <h3 id="simple-ui-components---notifications-popups-dialogs">
        
        
          Simple UI components - notifications, popups, dialogs <a href="#simple-ui-components---notifications-popups-dialogs">#</a>
        
        
      </h3>
    

<p>This section covers some simple UI components, and the next sections get into more sophisticated
interactions w/ users (via forms, dialogs, and the settings UI).</p>
      <h4 id="notifications">
        
        
          Notifications <a href="#notifications">#</a>
        
        
      </h4>
    

<p>Notifications are a really simple way to provide some information to the user. You can even attach
actions to notifications in case you want the user to perform an action when they get notified.</p>

<ul>
  <li>Notifications show up in the ‚ÄúEvent Log‚Äù tool window in the IDE.</li>
  <li>You can choose to have any shown notifications to be logged as well.</li>
  <li>Notifications can be project specific (and be shown in the IDE window containing a project), or be
a general notification for the entire IDE.</li>
  <li>Here are the
<a href="https://www.jetbrains.org/intellij/sdk/docs/user_interface_components/notifications.html">official docs</a>
on notifications.</li>
</ul>

<p>This is an example of a simple action that displays two notifications using slightly different ways.
Here is the snippet for this action that goes into <code class="language-plaintext highlighter-rouge">plugin.xml</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="n">actions</span><span class="p">&gt;</span>
  <span class="p">&lt;!--</span> <span class="nc">Add</span> <span class="n">notification</span> <span class="n">action</span><span class="p">.</span> <span class="p">--&gt;</span>
  <span class="p">&lt;</span><span class="n">action</span> <span class="n">id</span><span class="p">=</span><span class="s">"MyPlugin.actions.ShowNotificationSample"</span> <span class="k">class</span><span class="p">=</span><span class="s">"ui.ShowNotificationSampleAction"</span>
      <span class="n">description</span><span class="p">=</span><span class="s">"Show sample notifications"</span> <span class="n">text</span><span class="p">=</span><span class="s">"Sample Notification"</span> <span class="n">icon</span><span class="p">=</span><span class="s">"/icons/ic_extension.svg"</span> <span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="n">actions</span><span class="p">&gt;</span>
</code></pre></div></div>

<p>Here‚Äôs the start of the class that implements this action, to set things up.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">ui</span>

<span class="kd">class</span> <span class="nc">ShowNotificationSampleAction</span> <span class="p">:</span> <span class="nc">AnAction</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">GROUP_DISPAY_ID</span> <span class="p">=</span> <span class="s">"UI Samples"</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">messageTitle</span> <span class="p">=</span> <span class="s">"Title of notification"</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">messageDetails</span> <span class="p">=</span> <span class="s">"Details of notification"</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">actionPerformed</span><span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nc">AnActionEvent</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">aNotification</span><span class="p">()</span>
    <span class="nf">anotherNotification</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="k">fun</span> <span class="nf">anotherNotification</span><span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nc">AnActionEvent</span><span class="p">)</span> <span class="p">{</span><span class="o">..</span><span class="p">.}</span>
  <span class="k">private</span> <span class="k">fun</span> <span class="nf">aNotification</span><span class="p">()</span> <span class="p">{</span><span class="o">..</span><span class="p">.}</span>
</code></pre></div></div>

<p>Approach 1 - The following is an example of using a static method on the
<a href="https://github.com/JetBrains/intellij-community/blob/master/platform/platform-api/src/com/intellij/notification/Notifications.java"><code class="language-plaintext highlighter-rouge">Notifications.Bus</code></a>
to display a notification.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * One way to show notifications.
 * 1) This notification won't be logged to "Event Log" tool window.
 * 2) And it is project specific.
 */</span>
<span class="k">private</span> <span class="k">fun</span> <span class="nf">aNotification</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">notification</span> <span class="p">=</span> <span class="nc">Notification</span><span class="p">(</span><span class="nc">GROUP_DISPAY_ID</span><span class="p">,</span>
                                  <span class="s">"1 .$messageTitle"</span><span class="p">,</span>
                                  <span class="s">"1 .$messageDetails"</span><span class="p">,</span>
                                  <span class="nc">NotificationType</span><span class="p">.</span><span class="nc">INFORMATION</span><span class="p">)</span>
  <span class="nc">Notifications</span><span class="p">.</span><span class="nc">Bus</span><span class="p">.</span><span class="nf">notify</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Approach 2 - Here‚Äôs an another way to show notifications by creating a notification group.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Another way to show notifications.
 * 1) This will be logged to "Event Log" and is not tied to a specific project.
 */</span>
<span class="k">private</span> <span class="k">fun</span> <span class="nf">anotherNotification</span><span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nc">AnActionEvent</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">project</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nf">getRequiredData</span><span class="p">(</span><span class="nc">CommonDataKeys</span><span class="p">.</span><span class="nc">PROJECT</span><span class="p">)</span>
  <span class="kd">val</span> <span class="py">notificationGroup</span> <span class="p">=</span> <span class="nc">NotificationGroup</span><span class="p">(</span><span class="nc">GROUP_DISPAY_ID</span><span class="p">,</span> <span class="nc">NotificationDisplayType</span><span class="p">.</span><span class="nc">BALLOON</span><span class="p">,</span> <span class="k">false</span><span class="p">)</span>
  <span class="kd">val</span> <span class="py">notification</span> <span class="p">=</span> <span class="n">notificationGroup</span>
      <span class="p">.</span><span class="nf">createNotification</span><span class="p">(</span><span class="s">"2. $messageTitle"</span><span class="p">,</span>
                          <span class="s">"2. $messageDetails"</span><span class="p">,</span>
                          <span class="nc">NotificationType</span><span class="p">.</span><span class="nc">INFORMATION</span><span class="p">,</span>
                          <span class="k">null</span><span class="p">)</span>
  <span class="n">notification</span><span class="p">.</span><span class="nf">notify</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
      <h4 id="popups">
        
        
          Popups <a href="#popups">#</a>
        
        
      </h4>
    

<p>Popups are a way to get some input from the user w/out interrupting what they‚Äôre doing. Popups are
displayed w/out any chrome (UI to close them), and they disappear automatically when they lose
keyboard focus. IDE uses them extensively in type ahead completion, auto complete, etc.</p>

<ul>
  <li>Popups allow the user to make a single choice from a list of options that are displayed. Once the
user makes a choice you can provide some code (<code class="language-plaintext highlighter-rouge">itemChosenCallback</code>) that will be run on this
selection.</li>
  <li>Popups can display a title.</li>
  <li>They can be movable and resizable (and support remembering their size).</li>
  <li>They can even be nested (show another popup when an item is selected).</li>
</ul>

<p>The following is an example of an action that shows two nested popups. Here‚Äôs the snippet from
<code class="language-plaintext highlighter-rouge">plugin.xml</code> for registering the action.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- Add popup action. --&gt;</span>
<span class="nt">&lt;action</span> <span class="na">id=</span><span class="s">"MyPlugin.actions.ShowPopupSample"</span> <span class="na">class=</span><span class="s">"ui.ShowPopupSampleAction"</span> <span class="na">text=</span><span class="s">"Sample Popup"</span>
    <span class="na">description=</span><span class="s">"Shows sample popups"</span> <span class="na">icon=</span><span class="s">"/icons/ic_extension.svg"</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<p>Here‚Äôs the class that implements the action (which shows one popup, and when the user selects an
option in the first popup, the second one is shown). It shows multiple ways in which a popup can be
created to display a list of items. One approach is to use the <code class="language-plaintext highlighter-rouge">createPopupChooserBuilder()</code>, and
the other is to use <code class="language-plaintext highlighter-rouge">createListPopup()</code>, both of which are methods on
<a href="https://github.com/JetBrains/intellij-community/blob/master/platform/platform-api/src/com/intellij/openapi/ui/popup/JBPopupFactory.java"><code class="language-plaintext highlighter-rouge">JBPopupFactory.getInstance()</code></a>
method.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">ui</span>

<span class="kd">class</span> <span class="nc">ShowPopupSampleAction</span> <span class="p">:</span> <span class="nc">AnAction</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">editor</span><span class="p">:</span> <span class="nc">Editor</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">actionPerformed</span><span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nc">AnActionEvent</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">editor</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nf">getRequiredData</span><span class="p">(</span><span class="nc">CommonDataKeys</span><span class="p">.</span><span class="nc">EDITOR</span><span class="p">)</span>

    <span class="c1">// One way to show a list.</span>
    <span class="nc">JBPopupFactory</span>
        <span class="p">.</span><span class="nf">getInstance</span><span class="p">()</span>
        <span class="p">.</span><span class="nf">createListPopup</span><span class="p">(</span><span class="nc">MyList</span> <span class="p">{</span>
          <span class="c1">// Another way to show a list, using the builder.</span>
          <span class="nc">JBPopupFactory</span>
              <span class="p">.</span><span class="nf">getInstance</span><span class="p">()</span>
              <span class="p">.</span><span class="nf">createPopupChooserBuilder</span><span class="p">(</span><span class="nf">mutableListOf</span><span class="p">(</span><span class="s">"one"</span><span class="p">,</span> <span class="s">"two"</span><span class="p">,</span> <span class="s">"three"</span><span class="p">))</span>
              <span class="p">.</span><span class="nf">setTitle</span><span class="p">(</span><span class="s">"PopupChooserBuilder"</span><span class="p">)</span>
              <span class="p">.</span><span class="nf">setItemChosenCallback</span> <span class="p">{</span> <span class="nf">println</span><span class="p">(</span><span class="s">"PopupChooserBuilder.onChosen $it"</span><span class="p">)</span> <span class="p">}</span>
              <span class="p">.</span><span class="nf">createPopup</span><span class="p">()</span>
              <span class="p">.</span><span class="nf">showInBestPositionFor</span><span class="p">(</span><span class="n">editor</span><span class="p">)</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nf">showInBestPositionFor</span><span class="p">(</span><span class="n">editor</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">MyList</span><span class="p">(</span><span class="kd">val</span> <span class="py">onChosenHandler</span><span class="p">:</span> <span class="p">(</span><span class="nc">String</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nc">Unit</span><span class="p">)</span> <span class="p">:</span> <span class="nc">BaseListPopupStep</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;()</span> <span class="p">{</span>
  <span class="nf">init</span> <span class="p">{</span>
    <span class="nf">init</span><span class="p">(</span><span class="s">"Popup title"</span><span class="p">,</span> <span class="nf">mutableListOf</span><span class="p">(</span><span class="s">"Choice 1"</span><span class="p">,</span> <span class="s">"Choice 2"</span><span class="p">,</span> <span class="s">"Choice 3"</span><span class="p">),</span> <span class="k">null</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">getTextFor</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">String</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">"TEXT: $value"</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onChosen</span><span class="p">(</span><span class="n">selectedValue</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">finalChoice</span><span class="p">:</span> <span class="nc">Boolean</span><span class="p">):</span> <span class="nc">PopupStep</span><span class="p">&lt;</span><span class="err">*</span><span class="p">&gt;?</span> <span class="p">{</span>
    <span class="nf">println</span><span class="p">(</span><span class="s">"MyList.onChosen $selectedValue"</span><span class="p">)</span>
    <span class="nf">onChosenHandler</span><span class="p">(</span><span class="n">selectedValue</span><span class="p">)</span>
    <span class="k">return</span> <span class="nc">PopupStep</span><span class="p">.</span><span class="nc">FINAL_CHOICE</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
      <h4 id="dialogs">
        
        
          Dialogs <a href="#dialogs">#</a>
        
        
      </h4>
    

<p>When user input is required by your plugin dialogs might be the right component to use. They are
modal unlike notifications and popups. IDEA allows a simple boolean response to be returned from a
dialog.</p>

<p>In order to create sophisticated UIs that go inside the dialog, it is best to use the
<a href="#create-complex-uis-using-kotlin-ui-dsl-forms-dialogs-settings-screens">Kotlin UI DSL</a>.</p>

<p>Here‚Äôs a really simple example of an action that shows a dialog displaying ‚ÄúPress OK or Cancel‚Äù and
allowing the user and showing OK and Cancel buttons. Here‚Äôs the snippet for <code class="language-plaintext highlighter-rouge">plugin.xml</code>.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- Add dialog action. --&gt;</span>
<span class="nt">&lt;action</span> <span class="na">id=</span><span class="s">"MyPlugin.actions.ShowDialogSample"</span> <span class="na">class=</span><span class="s">"ui.ShowDialogSampleAction"</span> <span class="na">text=</span><span class="s">"Sample Dialog"</span>
    <span class="na">description=</span><span class="s">"Show sample dialog"</span> <span class="na">icon=</span><span class="s">"/icons/ic_extension.svg"</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<p>Here‚Äôs the action that uses the
<a href="https://github.com/JetBrains/intellij-community/blob/master/platform/platform-api/src/com/intellij/openapi/ui/DialogWrapper.java"><code class="language-plaintext highlighter-rouge">DialogWrapper</code></a>
class to actually show the dialog.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">ui</span>

<span class="kd">class</span> <span class="nc">ShowDialogSampleAction</span> <span class="p">:</span> <span class="nc">AnAction</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">actionPerformed</span><span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nc">AnActionEvent</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">response</span> <span class="p">=</span> <span class="nc">SampleDialogWrapper</span><span class="p">().</span><span class="nf">showAndGet</span><span class="p">()</span>
    <span class="nf">println</span><span class="p">(</span><span class="s">"Response selected:${if (response) "</span><span class="nc">Yes</span><span class="s">" else "</span><span class="nc">No</span><span class="s">"}"</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">SampleDialogWrapper</span> <span class="p">:</span> <span class="nc">DialogWrapper</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
  <span class="nf">init</span> <span class="p">{</span>
    <span class="nf">init</span><span class="p">()</span>
    <span class="n">title</span> <span class="p">=</span> <span class="s">"Sample Dialog"</span>
  <span class="p">}</span>

  <span class="c1">// More info on layout managers: https://docs.oracle.com/javase/tutorial/uiswing/layout/visual.html</span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">createCenterPanel</span><span class="p">():</span> <span class="nc">JComponent</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">panel</span> <span class="p">=</span> <span class="nc">JPanel</span><span class="p">(</span><span class="nc">BorderLayout</span><span class="p">())</span>
    <span class="kd">val</span> <span class="py">label</span> <span class="p">=</span> <span class="nc">JLabel</span><span class="p">(</span><span class="s">"Press OK or Cancel"</span><span class="p">)</span>
    <span class="n">label</span><span class="p">.</span><span class="n">preferredSize</span> <span class="p">=</span> <span class="nc">Dimension</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">panel</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nc">BorderLayout</span><span class="p">.</span><span class="nc">CENTER</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">panel</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Note that in this case, <code class="language-plaintext highlighter-rouge">showAndGet()</code> is used to both show the dialog, and get the response. You
can also break this into two steps with <code class="language-plaintext highlighter-rouge">show()</code> and <code class="language-plaintext highlighter-rouge">isOK()</code>.</p>

<blockquote>
  <p>Please refer to the
<a href="https://github.com/JetBrains/intellij-community/blob/master/platform/platform-api/src/com/intellij/openapi/ui/DialogWrapper.java">official docs</a>
for more information on dialogs.</p>
</blockquote>

<blockquote>
  <p>For more information on Swing layout managers, please refer to this
<a href="https://docs.oracle.com/javase/tutorial/uiswing/layout/visual.html">Java Tutorial article</a>.</p>
</blockquote>
      <h3 id="create-complex-uis-using-kotlin-ui-dsl-forms-dialogs-settings-screens">
        
        
          Create complex UIs using Kotlin UI DSL (forms, dialogs, settings screens) <a href="#create-complex-uis-using-kotlin-ui-dsl-forms-dialogs-settings-screens">#</a>
        
        
      </h3>
    

<p>In the sections below, we will be using <code class="language-plaintext highlighter-rouge">DialogWrapper</code> to take the UI we create using the Kotlin UI
DSL and show them.</p>

<p>In order to create more complex UIs, you can use the Kotlin UI DSL. You can display these forms in
the <a href="#create-ide-settings-ui-for-plugin">IDEA Settings UI</a>, or directly in a dialog box. You can
also bind the forms to data objects, that you can persist across IDE restarts as well.</p>
      <h4 id="understanding-the-structure-of-the-dsl-layout-row-and-cell">
        
        
          Understanding the structure of the DSL (layout, row, and cell) <a href="#understanding-the-structure-of-the-dsl-layout-row-and-cell">#</a>
        
        
      </h4>
    

<p>The Kotlin UI DSL allows UIs to be expressed in a layout that contains rows and cells. Things are
left to right aligned inside of each row, but you can specify if an item needs to be right aligned.
Type ahead completion in the IDE also provides guidance on how to use this DSL.</p>

<p>Here‚Äôs an example of a simple UI using this DSL, which contains the following UI components.</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">textField</code></li>
  <li><code class="language-plaintext highlighter-rouge">spinner</code></li>
  <li><code class="language-plaintext highlighter-rouge">checkBox</code></li>
  <li><code class="language-plaintext highlighter-rouge">noteRow</code></li>
</ol>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">data class</span> <span class="nc">MyData</span><span class="p">(</span><span class="kd">var</span> <span class="py">myFlag</span><span class="p">:</span> <span class="nc">Boolean</span><span class="p">,</span> <span class="kd">var</span> <span class="py">myString</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="kd">var</span> <span class="py">myInt</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="kd">var</span> <span class="py">myStringChoice</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span>
<span class="kd">val</span> <span class="py">myDataObject</span> <span class="p">=</span> <span class="nc">MyData</span><span class="p">()</span>

<span class="k">fun</span> <span class="nf">createDialogPanel</span><span class="p">():</span> <span class="nc">DialogPanel</span> <span class="p">=</span> <span class="nf">panel</span> <span class="p">{</span>
  <span class="c1">// Restore the selection state of the combo box.</span>
  <span class="kd">val</span> <span class="py">comboBoxChoices</span> <span class="p">=</span> <span class="nf">listOf</span><span class="p">(</span><span class="s">"choice1"</span><span class="p">,</span> <span class="s">"choice2"</span><span class="p">,</span> <span class="s">"choice3"</span><span class="p">)</span>
  <span class="kd">val</span> <span class="py">savedSelection</span> <span class="p">=</span> <span class="n">myDataObject</span><span class="p">.</span><span class="n">myStringChoice</span> <span class="c1">// This is an empty string by default.</span>
  <span class="kd">val</span> <span class="py">selection</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">savedSelection</span><span class="p">.</span><span class="nf">isEmpty</span><span class="p">())</span> <span class="n">comboBoxChoices</span><span class="p">.</span><span class="nf">first</span><span class="p">()</span> <span class="k">else</span> <span class="n">savedSelection</span>
  <span class="kd">val</span> <span class="py">comboBoxModel</span> <span class="p">=</span> <span class="nc">CollectionComboBoxModel</span><span class="p">(</span><span class="n">comboBoxChoices</span><span class="p">,</span> <span class="n">selection</span><span class="p">)</span>

  <span class="nf">noteRow</span><span class="p">(</span><span class="s">"This is a row with a note"</span><span class="p">)</span>

  <span class="nf">row</span> <span class="p">{</span>
    <span class="nf">label</span><span class="p">(</span><span class="s">"a string"</span><span class="p">)</span>
    <span class="nf">textField</span><span class="p">(</span><span class="n">myDataObject</span><span class="o">::</span><span class="n">myString</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nf">row</span> <span class="p">{</span>
    <span class="nf">label</span><span class="p">(</span><span class="s">"an int"</span><span class="p">)</span>
    <span class="nf">spinner</span><span class="p">(</span><span class="n">myDataObject</span><span class="o">::</span><span class="n">myInt</span><span class="p">,</span> <span class="n">minValue</span> <span class="p">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">maxValue</span> <span class="p">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">step</span> <span class="p">=</span> <span class="mi">5</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nf">row</span><span class="p">(</span><span class="s">"ComboBox / Drop down list"</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">comboBox</span><span class="p">(</span><span class="n">comboBoxModel</span><span class="p">,</span> <span class="n">myDataObject</span><span class="o">::</span><span class="n">myStringChoice</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nf">row</span> <span class="p">{</span>
    <span class="nf">cell</span> <span class="p">{</span>
      <span class="nf">checkBox</span><span class="p">(</span><span class="s">""</span><span class="p">,</span> <span class="n">myDataObject</span><span class="o">::</span><span class="n">myFlag</span><span class="p">)</span>
      <span class="nf">label</span><span class="p">(</span><span class="s">"Boolean state::myFlag"</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nf">noteRow</span><span class="p">(</span><span class="s">"""Note with a link. &lt;a href="http://github.com"&gt;Open source&lt;/a&gt;"""</span><span class="p">)</span> <span class="p">{</span>
    <span class="nc">BrowserUtil</span><span class="p">.</span><span class="nf">browse</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
      <h4 id="how-to-bind-data-to-the-form-ui">
        
        
          How to bind data to the form UI <a href="#how-to-bind-data-to-the-form-ui">#</a>
        
        
      </h4>
    

<p>One really simple way of binding the UI to a data object that you create is by passing a reference
to the <code class="language-plaintext highlighter-rouge">KProperty</code> for each property that should be rendered by a UI component. This ensures that:</p>

<ol>
  <li>The data object populates the UI component to its correct initial state before it is shown.</li>
  <li>When the user manipulates the UI component and its state changes, this is reflected in the data
object‚Äôs property.</li>
</ol>

<p>In the example above, note that some UI components that hold state information require a Kotlin
property (from a data object that you provide) to bind to. This is an easy way that the DSL handles
data binding in the forms for you.</p>

<p>It is possible to provide explicit setters and getters as well instead of just using the
<a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.reflect/-k-property/"><code class="language-plaintext highlighter-rouge">KProperty</code></a>. This makes
it really simple to create forms, since the state is loaded and saved for you, automatically.</p>
      <h4 id="what-ui-elements-are-available-for-use-in-the-forms">
        
        
          What UI elements are available for use in the forms <a href="#what-ui-elements-are-available-for-use-in-the-forms">#</a>
        
        
      </h4>
    

<ol>
  <li>The <code class="language-plaintext highlighter-rouge">panel</code> function creates a
<a href="https://github.com/JetBrains/intellij-community/blob/master/platform/platform-impl/src/com/intellij/ui/layout/LayoutBuilder.kt"><code class="language-plaintext highlighter-rouge">LayoutBuilder</code></a>
and inside of this you can add <code class="language-plaintext highlighter-rouge">row</code> (or <code class="language-plaintext highlighter-rouge">noteRow</code>, or <code class="language-plaintext highlighter-rouge">titledRow</code>, etc). Check out
<a href="https://github.com/JetBrains/intellij-community/blob/master/platform/platform-impl/src/com/intellij/ui/layout/Row.kt"><code class="language-plaintext highlighter-rouge">RowBuilder</code></a>
to see all the row based components you can add here.</li>
  <li>To see what objects can be added inside each <code class="language-plaintext highlighter-rouge">row</code>, check out
<a href="https://github.com/JetBrains/intellij-community/blob/master/platform/platform-impl/src/com/intellij/ui/layout/Cell.kt"><code class="language-plaintext highlighter-rouge">Cell</code></a>.
You can add things like <code class="language-plaintext highlighter-rouge">browserLink</code>, <code class="language-plaintext highlighter-rouge">comboBox</code>, <code class="language-plaintext highlighter-rouge">checkBox</code>, etc.</li>
</ol>

<blockquote>
  <p>Please make sure to read the
<a href="http://www.jetbrains.org/intellij/sdk/docs/user_interface_components/kotlin_ui_dsl.html">official docs</a>
on the DSL.</p>
</blockquote>
      <h4 id="how-to-display-a-form-in-a-dialog">
        
        
          How to display a form in a dialog <a href="#how-to-display-a-form-in-a-dialog">#</a>
        
        
      </h4>
    

<p>The form that‚Äôs created using this DSL can be displayed anywhere a <code class="language-plaintext highlighter-rouge">DisplayPanel</code> can be used (which
is just a subclass of <code class="language-plaintext highlighter-rouge">JPanel</code>). This includes the Settings UI (shown in the
<a href="#create-ide-settings-ui-for-plugin">section below</a>) and in a dialog. Here‚Äôs an sample action that
takes the object returned by
<a href="#understanding-the-structure-of-the-dsl-layout-row-and-cell"><code class="language-plaintext highlighter-rouge">createDialogPanel()</code></a> above, and
displays it in a dialog, using a <code class="language-plaintext highlighter-rouge">DialogWrapper</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">ShowKotlinUIDSLSampleInDialogAction</span> <span class="p">:</span> <span class="nc">AnAction</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">actionPerformed</span><span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nc">AnActionEvent</span><span class="p">)</span> <span class="p">{</span>
    <span class="nc">MyDialogWrapper</span><span class="p">().</span><span class="nf">show</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">private</span> <span class="kd">class</span> <span class="nc">MyDialogWrapper</span> <span class="p">:</span> <span class="nc">DialogWrapper</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
  <span class="nf">init</span> <span class="p">{</span>
    <span class="nf">init</span><span class="p">()</span>
    <span class="n">title</span> <span class="p">=</span> <span class="s">"Sample Dialog with Kotlin UI DSL"</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">createCenterPanel</span><span class="p">():</span> <span class="nc">JComponent</span> <span class="p">=</span> <span class="nf">createDialogPanel</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>
      <h4 id="how-to-persist-the-data-createdselected-by-the-user-between-ide-restarts-persistentstatecomponent">
        
        
          How to persist the data created/selected by the user, between IDE restarts (PersistentStateComponent) <a href="#how-to-persist-the-data-createdselected-by-the-user-between-ide-restarts-persistentstatecomponent">#</a>
        
        
      </h4>
    

<p>If you want the data that you‚Äôve created in your form to be used in the rest of the IDE, it makes
sense to persist this data and make it available to other pieces of your plugin. This is where
<a href="https://github.com/JetBrains/intellij-community/blob/master/platform/projectModel-api/src/com/intellij/openapi/components/PersistentStateComponent.java"><code class="language-plaintext highlighter-rouge">PersistentStateComponent</code></a>
comes in. It allows you serialize the state of your data object to disk, and deserialize it from
disk. In order to have IDEA persist your data object, simply do two things:</p>

<ol>
  <li>Make your data class extend <code class="language-plaintext highlighter-rouge">PersistentStateComponent</code>.</li>
  <li>Wrap this in a <code class="language-plaintext highlighter-rouge">Service</code> so that you can access it in any code in your plugin.</li>
</ol>

<p>Here‚Äôs an example that shows this. The <code class="language-plaintext highlighter-rouge">KotlinDSLUISampleService</code> service contains a <code class="language-plaintext highlighter-rouge">State</code> object
called <code class="language-plaintext highlighter-rouge">myState</code> that actually holds the data which is bound to the forms. <code class="language-plaintext highlighter-rouge">State</code> simply holds 4
properties (which can be bound to various UI components in a form): <code class="language-plaintext highlighter-rouge">myFlag: Boolean</code>,
<code class="language-plaintext highlighter-rouge">myString: String</code>, <code class="language-plaintext highlighter-rouge">myInt: Int</code>, <code class="language-plaintext highlighter-rouge">myStringChoice: String</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="nd">@State</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="s">"KotlinDSLUISampleData"</span><span class="p">,</span> <span class="n">storages</span> <span class="p">=</span> <span class="p">[</span><span class="nc">Storage</span><span class="p">(</span><span class="s">"kotlinDSLUISampleData.xml"</span><span class="p">)])</span>
<span class="kd">class</span> <span class="nc">KotlinDSLUISampleService</span> <span class="p">:</span> <span class="nc">PersistentStateComponent</span><span class="p">&lt;</span><span class="nc">KotlinDSLUISampleService</span><span class="p">.</span><span class="nc">State</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">instance</span><span class="p">:</span> <span class="nc">KotlinDSLUISampleService</span>
      <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="nf">getService</span><span class="p">(</span><span class="nc">KotlinDSLUISampleService</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="py">myState</span> <span class="p">=</span> <span class="nc">State</span><span class="p">()</span>

  <span class="c1">// PersistentStateComponent methods.</span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">getState</span><span class="p">():</span> <span class="nc">State</span> <span class="p">{</span>
    <span class="nf">println</span><span class="p">(</span><span class="s">"KotlinDSLUISampleData.getState, state: $myState"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">myState</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">loadState</span><span class="p">(</span><span class="n">stateLoadedFromPersistence</span><span class="p">:</span> <span class="nc">State</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">println</span><span class="p">(</span><span class="s">"KotlinDSLUISampleData.loadState, stateLoadedFromPersistence: $stateLoadedFromPersistence"</span><span class="p">)</span>
    <span class="n">myState</span> <span class="p">=</span> <span class="n">stateLoadedFromPersistence</span>
  <span class="p">}</span>

  <span class="c1">// Properties in this class are bound to the Kotlin DSL UI.</span>
  <span class="kd">class</span> <span class="nc">State</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="py">myFlag</span><span class="p">:</span> <span class="nc">Boolean</span> <span class="k">by</span> <span class="kd">object</span> <span class="err">: </span><span class="nc">LoggingProperty</span><span class="p">&lt;</span><span class="nc">State</span><span class="p">,</span> <span class="nc">Boolean</span><span class="p">&gt;(</span><span class="k">false</span><span class="p">)</span> <span class="p">{}</span>
    <span class="kd">var</span> <span class="py">myString</span><span class="p">:</span> <span class="nc">String</span> <span class="k">by</span> <span class="kd">object</span> <span class="err">: </span><span class="nc">LoggingProperty</span><span class="p">&lt;</span><span class="nc">State</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;(</span><span class="s">""</span><span class="p">)</span> <span class="p">{}</span>
    <span class="kd">var</span> <span class="py">myInt</span><span class="p">:</span> <span class="nc">Int</span> <span class="k">by</span> <span class="kd">object</span> <span class="err">: </span><span class="nc">LoggingProperty</span><span class="p">&lt;</span><span class="nc">State</span><span class="p">,</span> <span class="nc">Int</span><span class="p">&gt;(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
    <span class="kd">var</span> <span class="py">myStringChoice</span><span class="p">:</span> <span class="nc">String</span> <span class="k">by</span> <span class="kd">object</span> <span class="err">: </span><span class="nc">LoggingProperty</span><span class="p">&lt;</span><span class="nc">State</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;(</span><span class="s">""</span><span class="p">)</span> <span class="p">{}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">toString</span><span class="p">():</span> <span class="nc">String</span> <span class="p">=</span>
        <span class="s">"State{ myFlag: '$myFlag', myString: '$myString', myInt: '$myInt', myStringChoice: '$myStringChoice' }"</span>

    <span class="cm">/** Factory class to generate synthetic properties, that log every access and mutation to each property. */</span>
    <span class="k">open</span> <span class="kd">class</span> <span class="nc">LoggingProperty</span><span class="p">&lt;</span><span class="nc">R</span><span class="p">,</span> <span class="nc">T</span><span class="p">&gt;(</span><span class="n">initValue</span><span class="p">:</span> <span class="nc">T</span><span class="p">)</span> <span class="p">:</span> <span class="nc">ReadWriteProperty</span><span class="p">&lt;</span><span class="nc">R</span><span class="p">,</span> <span class="nc">T</span><span class="p">&gt;</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="py">backingField</span><span class="p">:</span> <span class="nc">T</span> <span class="p">=</span> <span class="n">initValue</span>

      <span class="k">override</span> <span class="k">fun</span> <span class="nf">getValue</span><span class="p">(</span><span class="n">thisRef</span><span class="p">:</span> <span class="nc">R</span><span class="p">,</span> <span class="n">property</span><span class="p">:</span> <span class="nc">KProperty</span><span class="p">&lt;</span><span class="err">*</span><span class="p">&gt;):</span> <span class="nc">T</span> <span class="p">{</span>
        <span class="nf">println</span><span class="p">(</span><span class="s">"State::${property.name}.getValue(), value: '$backingField'"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">backingField</span>
      <span class="p">}</span>

      <span class="k">override</span> <span class="k">fun</span> <span class="nf">setValue</span><span class="p">(</span><span class="n">thisRef</span><span class="p">:</span> <span class="nc">R</span><span class="p">,</span> <span class="n">property</span><span class="p">:</span> <span class="nc">KProperty</span><span class="p">&lt;</span><span class="err">*</span><span class="p">&gt;,</span> <span class="n">value</span><span class="p">:</span> <span class="nc">T</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">backingField</span> <span class="p">=</span> <span class="n">value</span>
        <span class="nf">println</span><span class="p">(</span><span class="s">"State::${property.name}.setValue(), value: '$backingField'"</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In the form UI example above, we just bound the data for the UI components to an object created from
a simple data class. Here‚Äôs an example.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">row</span> <span class="p">{</span>
  <span class="nf">label</span><span class="p">(</span><span class="s">"a string"</span><span class="p">)</span>
  <span class="nf">textField</span><span class="p">(</span><span class="n">myDataObject</span><span class="o">::</span><span class="n">myString</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In order to replace that with the <code class="language-plaintext highlighter-rouge">PersistentStateComponent</code> instance, we would do something like
this instead.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">row</span> <span class="p">{</span>
  <span class="nf">label</span><span class="p">(</span><span class="s">"a string"</span><span class="p">)</span>
  <span class="nf">textField</span><span class="p">(</span><span class="nc">KotlinDSLUISampleService</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">myState</span><span class="o">::</span><span class="n">myString</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In other words, <code class="language-plaintext highlighter-rouge">myDataObject</code> is replaced with <code class="language-plaintext highlighter-rouge">KotlinDSLUISampleService.instance.myState</code>.</p>

<p>There is one very important thing to note in the code above. The <code class="language-plaintext highlighter-rouge">getState()</code> and <code class="language-plaintext highlighter-rouge">loadState(...)</code>
methods should not be called by your code. These are hooks for IDEA to call into the service in
order to manage loading and saving the state to persistence. You should provide accessors to your
data properties that do not involve the use of <code class="language-plaintext highlighter-rouge">getState()</code>. And make sure that these accessors can
handle <code class="language-plaintext highlighter-rouge">loadState(...)</code> providing the ‚Äúinitial‚Äù state (if there is anything stored in persistence).
And you must make sure that by default, your initial state has to be defined (if there is no
customized data to load from persistence, then your state will contain default values). IDEA uses
this default state to figure out if the user changed anything in the form UI (the diffs will deviate
from the default state).</p>

<p>Also, you can specify many options to IDEA on where to store the persistent data. In this example,
we have told IDEA to store any user modified data to an XML file called <code class="language-plaintext highlighter-rouge">kotlinDSLUISampleData.xml</code>
in the <code class="language-plaintext highlighter-rouge">config/options/</code> folder where IDEA settings are stored. You can also specify options for
<code class="language-plaintext highlighter-rouge">storages</code> that determine whether this data should be roaming disabled or not, and even if you
should only store the data on specific platforms.</p>
      <h4 id="example-of-a-form-ui">
        
        
          Example of a form UI <a href="#example-of-a-form-ui">#</a>
        
        
      </h4>
    

<p>Here‚Äôs a form that uses Kotlin DSL and the <code class="language-plaintext highlighter-rouge">State</code> object (provided by the
<code class="language-plaintext highlighter-rouge">PersistentStateComponent</code> service).</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">createDialogPanel</span><span class="p">():</span> <span class="nc">DialogPanel</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">comboBoxChoices</span> <span class="p">=</span> <span class="nf">listOf</span><span class="p">(</span><span class="s">"choice1"</span><span class="p">,</span> <span class="s">"choice2"</span><span class="p">,</span> <span class="s">"choice3"</span><span class="p">)</span>

  <span class="c1">// Restore the selection state of the combo box.</span>
  <span class="kd">val</span> <span class="py">savedSelection</span> <span class="p">=</span> <span class="n">instance</span><span class="p">.</span><span class="n">myState</span><span class="p">.</span><span class="n">myStringChoice</span> <span class="c1">// This is an empty string by default.</span>
  <span class="kd">val</span> <span class="py">selection</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">savedSelection</span><span class="p">.</span><span class="nf">isEmpty</span><span class="p">())</span> <span class="n">comboBoxChoices</span><span class="p">.</span><span class="nf">first</span><span class="p">()</span> <span class="k">else</span> <span class="n">savedSelection</span>
  <span class="kd">val</span> <span class="py">comboBoxModel</span> <span class="p">=</span> <span class="nc">CollectionComboBoxModel</span><span class="p">(</span><span class="n">comboBoxChoices</span><span class="p">,</span> <span class="n">selection</span><span class="p">)</span>

  <span class="k">return</span> <span class="nf">panel</span> <span class="p">{</span>
    <span class="nf">noteRow</span><span class="p">(</span><span class="s">"This is a row with a note"</span><span class="p">)</span>

    <span class="nf">row</span><span class="p">(</span><span class="s">"[Boolean]"</span><span class="p">)</span> <span class="p">{</span>
      <span class="nf">row</span> <span class="p">{</span>
        <span class="nf">cell</span> <span class="p">{</span>
          <span class="nf">checkBox</span><span class="p">(</span><span class="s">""</span><span class="p">,</span> <span class="n">instance</span><span class="p">.</span><span class="n">myState</span><span class="o">::</span><span class="n">myFlag</span><span class="p">)</span>
          <span class="nf">label</span><span class="p">(</span><span class="s">"Boolean state::myFlag"</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nf">row</span><span class="p">(</span><span class="s">"[String]"</span><span class="p">)</span> <span class="p">{</span>
      <span class="nf">row</span> <span class="p">{</span>
        <span class="nf">label</span><span class="p">(</span><span class="s">"String state::myString"</span><span class="p">)</span>
        <span class="nf">textField</span><span class="p">(</span><span class="n">instance</span><span class="p">.</span><span class="n">myState</span><span class="o">::</span><span class="n">myString</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nf">row</span><span class="p">(</span><span class="s">"[Int]"</span><span class="p">)</span> <span class="p">{</span>
      <span class="nf">row</span> <span class="p">{</span>
        <span class="nf">label</span><span class="p">(</span><span class="s">"Int state::myInt"</span><span class="p">)</span>
        <span class="nf">spinner</span><span class="p">(</span><span class="n">instance</span><span class="p">.</span><span class="n">myState</span><span class="o">::</span><span class="n">myInt</span><span class="p">,</span> <span class="n">minValue</span> <span class="p">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">maxValue</span> <span class="p">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">step</span> <span class="p">=</span> <span class="mi">5</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nf">row</span><span class="p">(</span><span class="s">"ComboBox / Drop down list"</span><span class="p">)</span> <span class="p">{</span>
      <span class="nf">comboBox</span><span class="p">(</span><span class="n">comboBoxModel</span><span class="p">,</span> <span class="n">instance</span><span class="p">.</span><span class="n">myState</span><span class="o">::</span><span class="n">myStringChoice</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nf">noteRow</span><span class="p">(</span><span class="s">"""Note with a link. &lt;a href="http://github.com"&gt;Open source&lt;/a&gt;"""</span><span class="p">)</span> <span class="p">{</span>
      <span class="nf">println</span><span class="p">(</span><span class="s">"link url: '$it' clicked"</span><span class="p">)</span>
      <span class="nc">BrowserUtil</span><span class="p">.</span><span class="nf">browse</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
      <h4 id="miglayout-panel-and-grow">
        
        
          MigLayout, panel, and grow <a href="#miglayout-panel-and-grow">#</a>
        
        
      </h4>
    

<p>The <code class="language-plaintext highlighter-rouge">panel</code> function (in Kotlin UI DSL) actually creates a
<a href="https://github.com/jetbrains/intellij-community/blob/master/platform/platform-impl/src/com/intellij/ui/layout/migLayout/patched/MigLayout.kt#L43"><code class="language-plaintext highlighter-rouge">MigLayout</code></a>.
<code class="language-plaintext highlighter-rouge">MigLayout</code> can produce flowing, grid based, absolute (with links), grouped and docking layouts. You
can read the docs <a href="MigLayout can produce flowing, grid based, absolute (with links), grouped
and docking layouts">here</a>.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">panel</code> accepts <code class="language-plaintext highlighter-rouge">row</code> functions, which in turn accepts <code class="language-plaintext highlighter-rouge">cell</code> functions.</li>
  <li>You can pass <code class="language-plaintext highlighter-rouge">grow</code> and <code class="language-plaintext highlighter-rouge">fill</code> attributes to <code class="language-plaintext highlighter-rouge">panel</code> and <code class="language-plaintext highlighter-rouge">cell</code> functions.</li>
  <li>You can also wrap <code class="language-plaintext highlighter-rouge">JComponents</code> using the <code class="language-plaintext highlighter-rouge">component</code> function, which can also take <code class="language-plaintext highlighter-rouge">grow</code> and
<code class="language-plaintext highlighter-rouge">fill</code> attributes.</li>
  <li><code class="language-plaintext highlighter-rouge">panel</code> automatically sizes the dialog, however, you can override it using your own predefined
width and height.</li>
</ul>

<p>Here‚Äôs an example (<code class="language-plaintext highlighter-rouge">myJComponent</code> is just a <code class="language-plaintext highlighter-rouge">JComponent</code> that is created somewhere else).</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">override</span> <span class="k">fun</span> <span class="nf">createCenterPanel</span><span class="p">():</span> <span class="nc">JComponent</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nf">panel</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">row</span> <span class="p">{</span>
            <span class="nf">cell</span> <span class="p">{</span>
                <span class="nf">label</span><span class="p">(</span><span class="s">"Type into this editor component"</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nf">row</span> <span class="p">{</span>
            <span class="nf">cell</span> <span class="p">{</span>
                <span class="nf">component</span><span class="p">(</span><span class="n">myJComponent</span><span class="p">).</span><span class="nf">constraints</span><span class="p">(</span><span class="n">growX</span><span class="p">,</span> <span class="n">growY</span><span class="p">,</span> <span class="n">pushX</span><span class="p">,</span> <span class="n">pushY</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}.</span><span class="nf">apply</span> <span class="p">{</span>
        <span class="n">preferredSize</span> <span class="p">=</span> <span class="nc">JBUI</span><span class="p">.</span><span class="nf">size</span><span class="p">(</span><span class="nc">WIDTH</span><span class="p">,</span> <span class="nc">HEIGHT</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kd">val</span> <span class="py">WIDTH</span> <span class="p">=</span> <span class="mi">1000</span>
    <span class="k">const</span> <span class="kd">val</span> <span class="py">HEIGHT</span> <span class="p">=</span> <span class="mi">400</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>Note that <code class="language-plaintext highlighter-rouge">JComponent</code> objects become callable within the <code class="language-plaintext highlighter-rouge">panel</code> function and they accept
<code class="language-plaintext highlighter-rouge">CCFLags</code> that constrain their growth.</p>
</blockquote>

<blockquote>
  <p>Please note that it might be simpler at times to use the
<a href="https://docs.oracle.com/javase/tutorial/uiswing/layout/visual.html">Swing layout managers</a>
directly w/out using this DSL.</p>
</blockquote>
      <h3 id="create-ide-settings-ui-for-plugin">
        
        
          Create IDE Settings UI for plugin <a href="#create-ide-settings-ui-for-plugin">#</a>
        
        
      </h3>
    

<p>Let‚Äôs say that we wanted to display the form created above (by <code class="language-plaintext highlighter-rouge">createDialogPanel()</code>) and we want to
display it in a Settings UI, in addition to it being available in a <code class="language-plaintext highlighter-rouge">Dialog</code>. Note that you can
display the form in both places, and have it update the data in the same <code class="language-plaintext highlighter-rouge">PersistentStateComponent</code>
service, which is really convenient.</p>

<p>In order to tell IDEA that you want a form to be displayed in the Settings UI, you can use one of
two extension points. In <code class="language-plaintext highlighter-rouge">plugin.xml</code> you can declare 2 types of ‚Äúconfigurables‚Äù that allow you to
customize the IDE settings UI, where a ‚Äúconfigurable‚Äù is a base class provided by the JetBrains
platform that allows you show your form UI.</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">projectConfigurable</code> - these are settings that are specific to a given project.</li>
  <li><code class="language-plaintext highlighter-rouge">applicationConfigurable</code> - these are settings that apply to the entire IDE.</li>
</ol>

<p>References:</p>

<ul>
  <li><a href="https://confluence.jetbrains.com/display/IDEADEV/Customizing+the+IDEA+Settings+Dialog">Old JB docs</a>.</li>
  <li><a href="https://www.jetbrains.org/intellij/sdk/docs/user_interface_components/kotlin_ui_dsl.html#configurables">New JB docs</a>.</li>
  <li><a href="https://github.com/gilday/dark-mode-sync-plugin">MacOS dark mode sync plugin source</a></li>
</ul>

<p>When using the Kotlin UI DSL instead of implementing <code class="language-plaintext highlighter-rouge">Configurable</code> interface, simply extend
<code class="language-plaintext highlighter-rouge">BoundConfigurable</code>. When doing this you can:</p>

<ol>
  <li>Pass a <code class="language-plaintext highlighter-rouge">displayName</code> to the constructor of the <code class="language-plaintext highlighter-rouge">BoundConfigurable</code> that will actually show up in
the Settings UI, (and you can type-ahead search for).</li>
  <li>Pass any number of JB platform objects in the constructor, eg:
    <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MyConfigurable</span><span class="p">(</span><span class="k">private</span> <span class="kd">val</span> <span class="py">lafManager</span><span class="p">:</span> <span class="nc">LafManager</span><span class="p">)</span> <span class="p">:</span> <span class="nc">BoundConfigurable</span><span class="p">(</span><span class="s">"Display Name"</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
</ol>

<p>The following is an example of this (<code class="language-plaintext highlighter-rouge">plugin.xml</code> entry, and a class that extends
<code class="language-plaintext highlighter-rouge">BoundConfigurable</code>).</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- Add Settings Dialog that is similar to what ShowKotlinUIDSLSampleAction does. --&gt;</span>
<span class="nt">&lt;extensions</span> <span class="na">defaultExtensionNs=</span><span class="s">"com.intellij"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;applicationConfigurable</span> <span class="na">instance=</span><span class="s">"ui.KotlinDSLUISampleConfigurable"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/extensions&gt;</span>
</code></pre></div></div>

<p>The code from the previous section
(<a href="#create-complex-uis-using-kotlin-ui-dsl-forms-dialogs-settings-screens">Kotlin UI DSL</a>)) is used
here to generate the form itself.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">ui</span>

<span class="cm">/**
 * This application level configurable shows up the in IDE Settings UI.
 */</span>
<span class="kd">class</span> <span class="nc">KotlinDSLUISampleConfigurable</span> <span class="p">:</span> <span class="nc">BoundConfigurable</span><span class="p">(</span><span class="s">"Kotlin UI DSL"</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">apply</span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">println</span><span class="p">(</span><span class="s">"KotlinDSLUISampleConfigurable apply() called"</span><span class="p">)</span>
    <span class="k">super</span><span class="p">.</span><span class="nf">apply</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">cancel</span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">println</span><span class="p">(</span><span class="s">"KotlinDSLUISampleConfigurable cancel() called"</span><span class="p">)</span>
    <span class="k">super</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="cm">/** When the form is changed by the user, this returns `true` and enables the "Apply" button. */</span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">isModified</span><span class="p">():</span> <span class="nc">Boolean</span> <span class="p">{</span>
    <span class="nf">println</span><span class="p">(</span><span class="s">"KotlinDSLUISampleConfigurable isModified() called, return ${super.isModified()}"</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">super</span><span class="p">.</span><span class="nf">isModified</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">reset</span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">println</span><span class="p">(</span><span class="s">"KotlinDSLUISampleConfigurable reset() called"</span><span class="p">)</span>
    <span class="k">super</span><span class="p">.</span><span class="nf">reset</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">createPanel</span><span class="p">():</span> <span class="nc">DialogPanel</span> <span class="p">=</span> <span class="nf">createDialogPanel</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>
      <h3 id="complex-ui-creation-in-dialogs">
        
        
          Complex UI creation in dialogs <a href="#complex-ui-creation-in-dialogs">#</a>
        
        
      </h3>
    

<p>There are cases where complex UI components need to be created in a <code class="language-plaintext highlighter-rouge">DialogWrapper</code>. In this case,
Kotlin UI DSL can be used or directly creating Swing components using Swing layout managers.</p>

<blockquote>
  <p>Please take a look at the
<a href="https://github.com/nazmulidris/idea-plugin-example2">idea-plugin-example2</a> repo that contains a
plugin that has some of the functionality shown below.</p>
</blockquote>

<p>The following is an example of doing the latter to create a dialog that allows the user to paste
text from the clipboard into an <code class="language-plaintext highlighter-rouge">Editor</code> component. The paste operation is actually implemented as
an undoable command. It automatically pastes any text that is in the clipboard into the editor when
the dialog is shown.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">ComplexDialog</span><span class="p">(</span><span class="k">private</span> <span class="kd">val</span> <span class="py">project</span><span class="p">:</span> <span class="nc">Project</span><span class="p">)</span> <span class="p">:</span> <span class="nc">DialogWrapper</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">private</span> <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">editor</span><span class="p">:</span> <span class="nc">Editor</span>

    <span class="nf">init</span> <span class="p">{</span>
        <span class="nf">createEditorPanel</span><span class="p">()</span>
        <span class="nf">init</span><span class="p">()</span>
        <span class="n">title</span> <span class="p">=</span> <span class="s">"Type a bunch of text into the editor in this dialog"</span>
    <span class="p">}</span>

    <span class="c1">// More info on layout managers: https://docs.oracle.com/javase/tutorial/uiswing/layout/visual.html</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">createCenterPanel</span><span class="p">():</span> <span class="nc">JComponent</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">panel</span> <span class="p">=</span> <span class="nc">JPanel</span><span class="p">()</span>
        <span class="n">panel</span><span class="p">.</span><span class="n">preferredSize</span> <span class="p">=</span> <span class="nc">JBUI</span><span class="p">.</span><span class="nf">size</span><span class="p">(</span><span class="nc">WIDTH</span><span class="p">,</span> <span class="nc">HEIGHT</span><span class="p">)</span>
        <span class="n">panel</span><span class="p">.</span><span class="n">layout</span> <span class="p">=</span> <span class="nc">GridLayout</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">panel</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">component</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">panel</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">createEditorPanel</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">editorFactory</span><span class="p">:</span> <span class="nc">EditorFactory</span> <span class="p">=</span> <span class="nc">EditorFactory</span><span class="p">.</span><span class="nf">getInstance</span><span class="p">()</span>
        <span class="kd">val</span> <span class="py">document</span><span class="p">:</span> <span class="nc">Document</span> <span class="p">=</span> <span class="n">editorFactory</span><span class="p">.</span><span class="nf">createDocument</span><span class="p">(</span><span class="s">""</span><span class="p">)</span>
        <span class="n">editor</span> <span class="p">=</span> <span class="n">editorFactory</span><span class="p">.</span><span class="nf">createEditor</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">project</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">settings</span><span class="p">:</span> <span class="nc">EditorSettings</span> <span class="p">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">settings</span>
        <span class="nf">with</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">isFoldingOutlineShown</span> <span class="p">=</span> <span class="k">false</span>
            <span class="n">isLineMarkerAreaShown</span> <span class="p">=</span> <span class="k">false</span>
            <span class="n">isIndentGuidesShown</span> <span class="p">=</span> <span class="k">false</span>
            <span class="n">isLineNumbersShown</span> <span class="p">=</span> <span class="k">false</span>
            <span class="n">isRightMarginShown</span> <span class="p">=</span> <span class="k">false</span>
        <span class="p">}</span>
        <span class="nc">Disposer</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">myDisposable</span><span class="p">,</span> <span class="nc">Disposable</span> <span class="p">{</span>
            <span class="nc">EditorFactory</span><span class="p">.</span><span class="nf">getInstance</span><span class="p">().</span><span class="nf">releaseEditor</span><span class="p">(</span><span class="n">editor</span><span class="p">)</span>
        <span class="p">})</span>
        <span class="nf">pasteTextFromClipboard</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">pasteTextFromClipboard</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">getTextInClipboard</span><span class="p">()</span><span class="o">?.</span><span class="nf">let</span><span class="p">(</span><span class="o">::</span><span class="n">setText</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">setText</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">runnable</span> <span class="p">=</span> <span class="nc">Runnable</span> <span class="p">{</span>
            <span class="nc">ApplicationManager</span><span class="p">.</span><span class="nf">getApplication</span><span class="p">().</span><span class="nf">runWriteAction</span> <span class="p">{</span>
                <span class="n">editor</span><span class="p">.</span><span class="n">document</span><span class="p">.</span><span class="nf">let</span> <span class="p">{</span>
                    <span class="n">it</span><span class="p">.</span><span class="nf">replaceString</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">textLength</span><span class="p">,</span> <span class="nc">StringUtil</span><span class="p">.</span><span class="nf">convertLineSeparators</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">// Undoable command to set the text.</span>
        <span class="nc">CommandProcessor</span><span class="p">.</span><span class="nf">getInstance</span><span class="p">().</span><span class="nf">executeCommand</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">runnable</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">getTextInClipboard</span><span class="p">():</span> <span class="nc">String</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nc">CopyPasteManager</span><span class="p">.</span><span class="nf">getInstance</span><span class="p">().</span><span class="nf">getContents</span><span class="p">(</span><span class="nc">DataFlavor</span><span class="p">.</span><span class="n">stringFlavor</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
        <span class="k">const</span> <span class="kd">val</span> <span class="py">WIDTH</span> <span class="p">=</span> <span class="mi">1000</span>
        <span class="k">const</span> <span class="kd">val</span> <span class="py">HEIGHT</span> <span class="p">=</span> <span class="mi">400</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
      <h3 id="adding-your-plugin-ui-in-tool-windows">
        
        
          Adding your plugin UI in Tool windows <a href="#adding-your-plugin-ui-in-tool-windows">#</a>
        
        
      </h3>
    

<p>Tool windows provide in IDEA access to useful development tasks such as viewing your project
structure, running and debugging your code, Git integration, and so on. Your plugin can create UI
that will fit in tool windows in IDEA, instead of for example displaying it in a dialog box.</p>

<blockquote>
  <p>Read more about Tool windows in the
<a href="https://www.jetbrains.com/help/idea/tool-windows.html">official docs</a>.</p>
</blockquote>

<p>For both of these types of Tool windows, the following applies:</p>

<ol>
  <li>Each tool window can have multiple tabs (aka ‚Äúcontents‚Äù).</li>
  <li>Each side of the IDE can only show 2 tool windows at any given time, as the primary or the
secondary. For eg: you can move the ‚ÄúProject‚Äù tool window to ‚ÄúLeft Top‚Äù, and move the ‚ÄúStructure‚Äù
tool window to ‚ÄúLeft Bottom‚Äù. This way you can open both of them at the same time. Note that when
you move these tool windows to ‚ÄúLeft Top‚Äù or ‚ÄúLeft Bottom‚Äù how they actually move to the top or
bottom of the side of the IDE.</li>
</ol>

<p>There are two main types of tool windows: 1) Declarative, and 2) Programmatic.</p>

<blockquote>
  <p>Please take a look at the
<a href="https://github.com/nazmulidris/idea-plugin-example2">idea-plugin-example2</a> repo that contains a
plugin that has some of the functionality shown below.</p>
</blockquote>
      <h4 id="1-declarative-tool-window">
        
        
          1. Declarative tool window <a href="#1-declarative-tool-window">#</a>
        
        
      </h4>
    

<p>Always visible and the user can interact with it at anytime (eg: Gradle plugin tool window).</p>

<ul>
  <li>This type of tool window must be registered in <code class="language-plaintext highlighter-rouge">plugin.xml</code> using the <code class="language-plaintext highlighter-rouge">com.intellij.toolWindow</code>
extension point. You can specify things to register this in XML:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">id</code>: Text displayed in the tool window button.</li>
      <li><code class="language-plaintext highlighter-rouge">anchor</code>: Side of the screen in which the tool window is displayed (‚Äúleft‚Äù, ‚Äúright‚Äù, or
‚Äúbottom‚Äù).</li>
      <li><code class="language-plaintext highlighter-rouge">secondary</code>: Specify whether it is displayed in the primary or secondary group.</li>
      <li><code class="language-plaintext highlighter-rouge">icon</code>: Icon displayed in the tool window button (<code class="language-plaintext highlighter-rouge">13px</code> x <code class="language-plaintext highlighter-rouge">13px</code>).</li>
      <li><code class="language-plaintext highlighter-rouge">factoryClass</code>: A class implementing <code class="language-plaintext highlighter-rouge">ToolWindowFactory</code> interface, which is used to instantiate
the tool window when the user clicks on the tool window button (by calling
<code class="language-plaintext highlighter-rouge">createToolWindowContent()</code>). Note that if a user does not interact with the button, then a tool
window doesn‚Äôt get created.</li>
      <li>For versions 2020.1 and later, also implement the <code class="language-plaintext highlighter-rouge">isApplicable(Project)</code> method if there‚Äôs no
need to display a tool window for all projects. Note this condition is only evaluated the first
time a project is loaded.</li>
    </ul>
  </li>
</ul>

<p>Here‚Äôs an example.</p>

<p>The factory class.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">DeclarativeToolWindowFactory</span> <span class="p">:</span> <span class="nc">ToolWindowFactory</span><span class="p">,</span> <span class="nc">DumbAware</span> <span class="p">{</span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">createToolWindowContent</span><span class="p">(</span><span class="n">project</span><span class="p">:</span> <span class="nc">Project</span><span class="p">,</span> <span class="n">toolWindow</span><span class="p">:</span> <span class="nc">ToolWindow</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">contentManager</span> <span class="p">=</span> <span class="n">toolWindow</span><span class="p">.</span><span class="n">contentManager</span>
    <span class="kd">val</span> <span class="py">content</span> <span class="p">=</span> <span class="n">contentManager</span><span class="p">.</span><span class="n">factory</span><span class="p">.</span><span class="nf">createContent</span><span class="p">(</span><span class="nf">createDialogPanel</span><span class="p">(),</span> <span class="k">null</span><span class="p">,</span> <span class="k">false</span><span class="p">)</span>
    <span class="n">contentManager</span><span class="p">.</span><span class="nf">addContent</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">fun</span> <span class="nf">createDialogPanel</span><span class="p">():</span> <span class="nc">DialogPanel</span> <span class="p">=</span> <span class="nf">panel</span> <span class="p">{</span>
  <span class="nf">noteRow</span><span class="p">(</span><span class="s">"""Note with a link. &lt;a href="http://github.com"&gt;Open source&lt;/a&gt;"""</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">colorConsole</span> <span class="p">{</span>
      <span class="nf">printLine</span> <span class="p">{</span>
        <span class="nf">span</span><span class="p">(</span><span class="nc">Colors</span><span class="p">.</span><span class="nc">Purple</span><span class="p">,</span> <span class="s">"link url: '$it' clicked"</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nc">BrowserUtil</span><span class="p">.</span><span class="nf">browse</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">plugin.xml</code> snippet.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;extensions</span> <span class="na">defaultExtensionNs=</span><span class="s">"com.intellij"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;toolWindow</span>
      <span class="na">icon=</span><span class="s">"/icons/ic_toolwindow.svg"</span>
      <span class="na">id=</span><span class="s">"Declarative tool window"</span>
      <span class="na">anchor=</span><span class="s">"left"</span>
      <span class="na">secondary=</span><span class="s">"true"</span>
      <span class="na">factoryClass=</span><span class="s">"ui.DeclarativeToolWindowFactory"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/extensions&gt;</span>
</code></pre></div></div>
      <h4 id="2-programmatic-tool-window">
        
        
          2. Programmatic tool window <a href="#2-programmatic-tool-window">#</a>
        
        
      </h4>
    

<p>Only visible when a plugin creates it to show the results of an operation (eg: Analyze Dependencies
action). This type of tool window must be added programmatically by calling
<code class="language-plaintext highlighter-rouge">ToolWindowManager.getInstance().registerToolWindow(RegisterToolWindowTask)</code>.</p>

<p>A couple of things to remember.</p>

<ol>
  <li>You have to register the tool window (w/ the tool window manager) before using it. This is a one
time operation. There‚Äôs no need to register the tool window if it‚Äôs already been registered.
Registering simply shows the tool window in the IDEA UI. Unregistering removes it from the UI.</li>
  <li>You can tell the tool window to auto hide itself when there are no contents inside of it.</li>
  <li>You can create as many ‚Äúcontents‚Äù as you want and add it to the tool window. Each content is
basically a tab. You can also specify that the content is closable.</li>
  <li>You can also attach a disposer to a content so that you can take some action when the content or
tab is closed. For eg you can just unregister the tool window when there are no contents left in
the tool window.</li>
</ol>

<p>Here‚Äôs an example of all of the things listed above.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">internal</span> <span class="kd">class</span> <span class="nc">AnotherToolWindow</span> <span class="p">:</span> <span class="nc">AnAction</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">actionPerformed</span><span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nc">AnActionEvent</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">project</span><span class="p">:</span> <span class="nc">Project</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nf">getRequiredData</span><span class="p">(</span><span class="nc">CommonDataKeys</span><span class="p">.</span><span class="nc">PROJECT</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">toolWindowManager</span> <span class="p">=</span> <span class="nc">ToolWindowManager</span><span class="p">.</span><span class="nf">getInstance</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
    <span class="kd">var</span> <span class="py">toolWindow</span> <span class="p">=</span> <span class="n">toolWindowManager</span><span class="p">.</span><span class="nf">getToolWindow</span><span class="p">(</span><span class="nc">ID</span><span class="p">)</span>

    <span class="c1">// One time registration of the tool window (does not add any content).</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">toolWindow</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">toolWindow</span> <span class="p">=</span> <span class="n">toolWindowManager</span><span class="p">.</span><span class="nf">registerToolWindow</span><span class="p">(</span>
          <span class="nc">RegisterToolWindowTask</span><span class="p">(</span>
              <span class="n">id</span> <span class="p">=</span> <span class="nc">ID</span><span class="p">,</span>
              <span class="n">icon</span> <span class="p">=</span> <span class="nc">IconLoader</span><span class="p">.</span><span class="nf">getIcon</span><span class="p">(</span><span class="s">"/icons/ic_extension.svg"</span><span class="p">,</span> <span class="n">javaClass</span><span class="p">),</span>
              <span class="n">component</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
              <span class="n">canCloseContent</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
          <span class="p">))</span>
      <span class="n">toolWindow</span><span class="p">.</span><span class="nf">setToHideOnEmptyContent</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">val</span> <span class="py">contentManager</span> <span class="p">=</span> <span class="n">toolWindow</span><span class="p">.</span><span class="n">contentManager</span>
    <span class="kd">val</span> <span class="py">contentFactory</span><span class="p">:</span> <span class="nc">ContentFactory</span> <span class="p">=</span> <span class="nc">ContentFactory</span><span class="p">.</span><span class="nc">SERVICE</span><span class="p">.</span><span class="nf">getInstance</span><span class="p">()</span>
    <span class="kd">val</span> <span class="py">contentTab</span> <span class="p">=</span> <span class="n">contentFactory</span><span class="p">.</span><span class="nf">createContent</span><span class="p">(</span>
        <span class="nf">createComponent</span><span class="p">(</span><span class="n">project</span><span class="p">),</span>
        <span class="s">"${LocalDate.now()}"</span><span class="p">,</span>
        <span class="k">false</span><span class="p">)</span>
    <span class="n">contentTab</span><span class="p">.</span><span class="nf">setDisposer</span> <span class="p">{</span>
      <span class="nf">colorConsole</span> <span class="p">{</span>
        <span class="nf">printLine</span> <span class="p">{</span>
          <span class="nf">span</span><span class="p">(</span><span class="nc">Colors</span><span class="p">.</span><span class="nc">Purple</span><span class="p">,</span> <span class="s">"contentTab is disposed, contentCount: ${contentManager.contentCount}"</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">contentManager</span><span class="p">.</span><span class="n">contents</span><span class="p">.</span><span class="nf">isEmpty</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">toolWindowManager</span><span class="p">.</span><span class="nf">unregisterToolWindow</span><span class="p">(</span><span class="nc">ID</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">contentManager</span><span class="p">.</span><span class="nf">addContent</span><span class="p">(</span><span class="n">contentTab</span><span class="p">)</span>

    <span class="n">toolWindow</span><span class="p">.</span><span class="nf">show</span> <span class="p">{</span> <span class="n">contentManager</span><span class="p">.</span><span class="nf">setSelectedContent</span><span class="p">(</span><span class="n">contentTab</span><span class="p">,</span> <span class="k">true</span><span class="p">)</span> <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="k">fun</span> <span class="nf">createComponent</span><span class="p">(</span><span class="n">project</span><span class="p">:</span> <span class="nc">Project</span><span class="p">):</span> <span class="nc">JComponent</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">panel</span> <span class="p">=</span> <span class="nc">JPanel</span><span class="p">(</span><span class="nc">BorderLayout</span><span class="p">())</span>
    <span class="n">panel</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">BorderLayout</span><span class="p">.</span><span class="nc">CENTER</span><span class="p">,</span> <span class="nc">JLabel</span><span class="p">(</span><span class="s">"TODO add component"</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">panel</span>
  <span class="p">}</span>

  <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kd">val</span> <span class="py">ID</span> <span class="p">=</span> <span class="s">"AnotherToolWindow"</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">plugin.xml</code> snippet, to register the action.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;actions&gt;</span>
  <span class="nt">&lt;action</span> <span class="na">id=</span><span class="s">"MyPlugin.AnotherToolWindow"</span> <span class="na">class=</span><span class="s">"actions.AnotherToolWindow"</span> <span class="na">text=</span><span class="s">"Open Tool Window"</span>
      <span class="na">description=</span><span class="s">"Opens tool window programmatically"</span> <span class="na">icon=</span><span class="s">"/icons/ic_extension.svg"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;add-to-group</span> <span class="na">group-id=</span><span class="s">"EditorPopupMenu"</span> <span class="na">anchor=</span><span class="s">"first"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/action&gt;</span>
<span class="nt">&lt;/actions&gt;</span>
</code></pre></div></div>
      <h4 id="indices-and-dumb-aware">
        
        
          Indices and dumb aware <a href="#indices-and-dumb-aware">#</a>
        
        
      </h4>
    

<p>Displaying the contents of many tool windows requires access to the indices. Because of that, tool
windows are normally disabled while building indices, unless true is passed as the value of
<code class="language-plaintext highlighter-rouge">canWorkInDumbMode</code> to the <code class="language-plaintext highlighter-rouge">registerToolWindow()</code> function (for programmatic tool windows). You can
also implement <code class="language-plaintext highlighter-rouge">DumbAware</code> in your factory class to let IDEA know that your tool window can be shown
while indices are being built.</p>
      <h4 id="creating-a-content-for-any-kind-of-tool-window">
        
        
          Creating a content for any kind of tool window <a href="#creating-a-content-for-any-kind-of-tool-window">#</a>
        
        
      </h4>
    

<p>Regardless of the type of tool window (declarative or programmatic) here is the sequence of
operations that you have to perform in order to add a content:</p>

<ol>
  <li>Create the component / UI that you need for the content, ie, a Swing component (eg:
<code class="language-plaintext highlighter-rouge">createDialogPanel()</code> above).</li>
  <li>Add the component / UI to the content to the <code class="language-plaintext highlighter-rouge">ToolWindowManager</code> (programmatic) or the tool
window <code class="language-plaintext highlighter-rouge">ContentManager</code> (declarative).</li>
</ol>
      <h4 id="content-closeability">
        
        
          Content closeability <a href="#content-closeability">#</a>
        
        
      </h4>
    

<p>A plugin can control whether the user is allowed to close tabs either 1) globally or 2) on a per
content basis.</p>

<ol>
  <li><strong>Globally</strong>: This is done by passing the <code class="language-plaintext highlighter-rouge">canCloseContents</code> parameter to the
<code class="language-plaintext highlighter-rouge">registerToolWindow()</code> function, or by specifying <code class="language-plaintext highlighter-rouge">canCloseContents="true"</code> in <code class="language-plaintext highlighter-rouge">plugin.xml</code>. The
default value is <code class="language-plaintext highlighter-rouge">false</code>. Note that calling <code class="language-plaintext highlighter-rouge">setClosable(true)</code> on <code class="language-plaintext highlighter-rouge">ContentManager</code> content will
be ignored unless <code class="language-plaintext highlighter-rouge">canCloseContents</code> is explicitly set.</li>
  <li><strong>Per content basis</strong>: This is done by calling <code class="language-plaintext highlighter-rouge">setCloseable(Boolean)</code> on each content object
itself.</li>
</ol>

<p>If closing tabs is enabled in general, a plugin can disable closing of specific tabs by calling
<code class="language-plaintext highlighter-rouge">Content.setCloseable(false)</code>.</p>
      <h3 id="add-line-marker-provider-in-your-plugin">
        
        
          Add Line marker provider in your plugin <a href="#add-line-marker-provider-in-your-plugin">#</a>
        
        
      </h3>
    

<p>Line marker providers allow your plugin to display an icon in the gutter of an editor window. You
can also provide actions that can be run when the user interacts with the gutter icon, along with a
tooltip that can be generated when the user hovers over the gutter icon.</p>

<blockquote>
  <p>Please take a look at the
<a href="https://github.com/nazmulidris/idea-plugin-example2">idea-plugin-example2</a> repo that contains a
plugin that has some of the functionality shown below.</p>
</blockquote>

<p>In order to use line marker providers, you have to do two things:</p>

<ol>
  <li>Create a class that implements <code class="language-plaintext highlighter-rouge">LineMarkerProvider</code> that generates the <code class="language-plaintext highlighter-rouge">LineMarkerInfo</code> for the
correct <code class="language-plaintext highlighter-rouge">PsiElement</code> that you want IDEA to highlight in the IDE.</li>
  <li>Register this provider in <code class="language-plaintext highlighter-rouge">plugin.xml</code> and associate it to be run for a specific language.</li>
</ol>

<p>When your plugin is loaded, IDEA will then run your line marker provider when a file of that
language type is loaded in the editor. This happens in two passes for performance reasons.</p>

<ol>
  <li>IDEA will first call your provider implementation with the <code class="language-plaintext highlighter-rouge">PsiElements</code> that are currently
visible.</li>
  <li>IDEA will then call your provider implementation with the <code class="language-plaintext highlighter-rouge">PsiElements</code> that are currently
hidden.</li>
</ol>

<p>It is very important that you only return a <code class="language-plaintext highlighter-rouge">LineMarkerInfo</code> for the more specific <code class="language-plaintext highlighter-rouge">PsiElement</code> that
you wish IDEA to highlight, as if you scope it too broadly, there will be scenarios where your
gutter icon will blink! Here‚Äôs a detailed explanation as to why (a comment from the source for
<a href="https://github.com/JetBrains/intellij-community/blob/master/platform/lang-api/src/com/intellij/codeInsight/daemon/LineMarkerProvider.java"><code class="language-plaintext highlighter-rouge">LineMarkerProvider.java source file</code></a>).</p>

<blockquote>
  <p>Please create line marker info for leaf elements only - i.e. the smallest possible elements. For
example, instead of returning method marker for <code class="language-plaintext highlighter-rouge">PsiMethod</code>, create the marker for the
<code class="language-plaintext highlighter-rouge">PsiIdentifier</code> which is a name of this method.</p>

  <p>Highlighting (specifically, <code class="language-plaintext highlighter-rouge">LineMarkersPass</code>) queries all <code class="language-plaintext highlighter-rouge">LineMarkerProvider</code>s in two passes
(for performance reasons):</p>

  <ol>
    <li>first pass for all elements in visible area</li>
    <li>second pass for all the rest elements If provider returned nothing for both areas, its line
markers are cleared.</li>
  </ol>

  <p>So imagine a <code class="language-plaintext highlighter-rouge">LineMarkerProvider</code> which (incorrectly) written like this:</p>

  <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MyBadLineMarkerProvider</span> <span class="kd">implements</span> <span class="nc">LineMarkerProvider</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nc">LineMarkerInfo</span> <span class="nf">getLineMarkerInfo</span><span class="o">(</span><span class="nc">PsiElement</span> <span class="n">element</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">element</span> <span class="k">instanceof</span> <span class="nc">PsiMethod</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// ACTUALLY DONT!</span>
       <span class="k">return</span> <span class="k">new</span> <span class="nf">LineMarkerInfo</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="n">element</span><span class="o">.</span><span class="na">getTextRange</span><span class="o">(),</span> <span class="n">icon</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span><span class="kc">null</span><span class="o">,</span> <span class="n">alignment</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div>  </div>

  <p>Note that it create <code class="language-plaintext highlighter-rouge">LineMarkerInfo</code> for the whole method body. Following will happen when this
method is half-visible (e.g. its name is visible but a part of its body isn‚Äôt):</p>

  <ol>
    <li>the first pass would remove line marker info because the whole <code class="language-plaintext highlighter-rouge">PsiMethod</code> isn‚Äôt visible</li>
    <li>the second pass would try to add line marker info back because <code class="language-plaintext highlighter-rouge">LineMarkerProvider</code> was called
for the <code class="language-plaintext highlighter-rouge">PsiMethod</code> at last</li>
  </ol>

  <p>As a result, line marker icon will blink annoyingly. Instead, write this:</p>

  <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MyGoodLineMarkerProvider</span> <span class="kd">implements</span> <span class="nc">LineMarkerProvider</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nc">LineMarkerInfo</span> <span class="nf">getLineMarkerInfo</span><span class="o">(</span><span class="nc">PsiElement</span> <span class="n">element</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">element</span> <span class="k">instanceof</span> <span class="nc">PsiIdentifier</span> <span class="o">&amp;&amp;</span>
        <span class="o">(</span><span class="n">parent</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">getParent</span><span class="o">())</span> <span class="k">instanceof</span> <span class="nc">PsiMethod</span> <span class="o">&amp;&amp;</span>
        <span class="o">((</span><span class="nc">PsiMethod</span><span class="o">)</span><span class="n">parent</span><span class="o">).</span><span class="na">getMethodIdentifier</span><span class="o">()</span> <span class="o">==</span> <span class="n">element</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// aha, we are at method name</span>
         <span class="k">return</span> <span class="k">new</span> <span class="nf">LineMarkerInfo</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="n">element</span><span class="o">.</span><span class="na">getTextRange</span><span class="o">(),</span> <span class="n">icon</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span><span class="kc">null</span><span class="o">,</span> <span class="n">alignment</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div>  </div>
</blockquote>
      <h4 id="example-of-a-provider-for-markdown-language">
        
        
          Example of a provider for Markdown language <a href="#example-of-a-provider-for-markdown-language">#</a>
        
        
      </h4>
    

<p>Let‚Äôs say that for Markdown files that are open in the IDE, we want to highlight any lines that have
links in them. We want an icon to show up in the gutter area that the user can see and click on to
take some actions. For example, they can open the link.</p>
      <h4 id="1-declare-dependencies">
        
        
          1. Declare dependencies <a href="#1-declare-dependencies">#</a>
        
        
      </h4>
    

<p>Also, because we are relying on the Markdown plugin, in our plugin, we have to add the following
dependencies.</p>

<p>To <code class="language-plaintext highlighter-rouge">plugin.xml</code>, we must add.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- please see http://www.jetbrains.org/intellij/sdk/docs/basics/getting_started/build_number_ranges.html for description --&gt;</span>
<span class="nt">&lt;idea-version</span> <span class="na">since-build=</span><span class="s">"2020.1"</span> <span class="na">until-build=</span><span class="s">"2020.*"</span> <span class="nt">/&gt;</span>
<span class="c">&lt;!--
  Declare dependency on IntelliJ module `com.intellij.modules.platform` which provides the following:
  Messaging, UI Themes, UI Components, Files, Documents, Actions, Components, Services, Extensions, Editors
  More info: https://www.jetbrains.org/intellij/sdk/docs/basics/getting_started/plugin_compatibility.html
--&gt;</span>
<span class="nt">&lt;depends&gt;</span>com.intellij.modules.platform<span class="nt">&lt;/depends&gt;</span>
<span class="c">&lt;!-- Markdown plugin. --&gt;</span>
<span class="nt">&lt;depends&gt;</span>org.intellij.plugins.markdown<span class="nt">&lt;/depends&gt;</span>
</code></pre></div></div>

<p>To <code class="language-plaintext highlighter-rouge">build.gradle.kts</code> we must add.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// See https://github.com/JetBrains/gradle-intellij-plugin/</span>
<span class="nf">intellij</span> <span class="p">{</span>
    <span class="c1">// Information on IJ versions https://www.jetbrains.org/intellij/sdk/docs/reference_guide/intellij_artifacts.html</span>
    <span class="c1">// You can use release build numbers or snapshot name for the version.</span>
    <span class="c1">// 1) IJ Release Repository w/ build numbers https://www.jetbrains.com/intellij-repository/releases/</span>
    <span class="c1">// 2) IJ Snapshots Repository w/ snapshot names https://www.jetbrains.com/intellij-repository/snapshots/</span>
    <span class="n">version</span> <span class="p">=</span> <span class="s">"2020.1"</span> <span class="c1">// You can also use LATEST-EAP-SNAPSHOT here.</span>

    <span class="c1">// Declare a dependency on the markdown plugin to be able to access the</span>
    <span class="c1">// MarkdownRecursiveElementVisitor.kt file. More info:</span>
    <span class="c1">// https://www.jetbrains.org/intellij/sdk/docs/basics/plugin_structure/plugin_dependencies.html</span>
    <span class="c1">// https://plugins.jetbrains.com/plugin/7793-markdown/versions</span>
    <span class="nf">setPlugins</span><span class="p">(</span><span class="s">"java"</span><span class="p">,</span> <span class="s">"org.intellij.plugins.markdown:201.6668.27"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
      <h4 id="2-register-the-provider-in-xml">
        
        
          2. Register the provider in XML <a href="#2-register-the-provider-in-xml">#</a>
        
        
      </h4>
    

<p>The first thing we need to do is register our line marker provider in <code class="language-plaintext highlighter-rouge">plugin.xml</code>.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;extensions</span> <span class="na">defaultExtensionNs=</span><span class="s">"com.intellij"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;codeInsight.lineMarkerProvider</span> <span class="na">language=</span><span class="s">"Markdown"</span> <span class="na">implementationClass=</span><span class="s">"ui.MarkdownLineMarkerProvider"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/extensions&gt;</span>
</code></pre></div></div>
      <h4 id="3-provide-an-implementation-of-linemarkerprovider">
        
        
          3. Provide an implementation of LineMarkerProvider <a href="#3-provide-an-implementation-of-linemarkerprovider">#</a>
        
        
      </h4>
    

<p>Then we have to provide an implementation of <code class="language-plaintext highlighter-rouge">LineMarkerProvider</code> that returns a <code class="language-plaintext highlighter-rouge">LineMarkerInfo</code>
for the most fine grained <code class="language-plaintext highlighter-rouge">PsiElement</code> that it successfully matches against. In other words, we can
either match against the <code class="language-plaintext highlighter-rouge">LINK_DESTINATION</code> or the <code class="language-plaintext highlighter-rouge">LINK_TEXT</code> elements.</p>

<p>Here‚Äôs an example. For the string containing an inline Markdown link:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[`LineMarkerProvider.java`](https://github.com/JetBrains/intellij-community/blob/master/platform/lang-api/src/com/intellij/codeInsight/daemon/LineMarkerProvider.java)
</code></pre></div></div>

<p>This is what its PSI looks like:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ASTWrapperPsiElement(Markdown:Markdown:INLINE_LINK)(1644,1810)
        ASTWrapperPsiElement(Markdown:Markdown:LINK_TEXT)(1644,1671)
          PsiElement(Markdown:Markdown:[)('[')(1644,1645)
          ASTWrapperPsiElement(Markdown:Markdown:CODE_SPAN)(1645,1670)
            PsiElement(Markdown:Markdown:BACKTICK)('`')(1645,1646)
            PsiElement(Markdown:Markdown:TEXT)('LineMarkerProvider.java')(1646,1669)
            PsiElement(Markdown:Markdown:BACKTICK)('`')(1669,1670)
          PsiElement(Markdown:Markdown:])(']')(1670,1671)
        PsiElement(Markdown:Markdown:()('(')(1671,1672)
        MarkdownLinkDestinationImpl(Markdown:Markdown:LINK_DESTINATION)(1672,1809)
          PsiElement(Markdown:Markdown:GFM_AUTOLINK)('https://github.com/JetBrains/intellij-community/blob/master/platform/lang-api/src/com/intellij/codeInsight/daemon/LineMarkerProvider.java')(1672,1809)
        PsiElement(Markdown:Markdown:))(')')(1809,1810)
</code></pre></div></div>

<p>Here‚Äôs what the implementation of the line marker provider that matches <code class="language-plaintext highlighter-rouge">INLINE_LINK</code> might look
like.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">ui</span>

<span class="k">import</span> <span class="nn">com.intellij.codeInsight.daemon.LineMarkerInfo</span>
<span class="k">import</span> <span class="nn">com.intellij.codeInsight.daemon.LineMarkerProvider</span>
<span class="k">import</span> <span class="nn">com.intellij.openapi.editor.markup.GutterIconRenderer</span>
<span class="k">import</span> <span class="nn">com.intellij.openapi.util.IconLoader</span>
<span class="k">import</span> <span class="nn">com.intellij.psi.PsiElement</span>
<span class="k">import</span> <span class="nn">com.intellij.psi.tree.TokenSet</span>
<span class="k">import</span> <span class="nn">org.intellij.plugins.markdown.lang.MarkdownElementTypes</span>

<span class="k">internal</span> <span class="kd">class</span> <span class="nc">MarkdownLineMarkerProvider</span> <span class="p">:</span> <span class="nc">LineMarkerProvider</span> <span class="p">{</span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">getLineMarkerInfo</span><span class="p">(</span><span class="n">element</span><span class="p">:</span> <span class="nc">PsiElement</span><span class="p">):</span> <span class="nc">LineMarkerInfo</span><span class="p">&lt;</span><span class="err">*</span><span class="p">&gt;?</span> <span class="p">{</span>

    <span class="kd">val</span> <span class="py">node</span> <span class="p">=</span> <span class="n">element</span><span class="p">.</span><span class="n">node</span>
    <span class="kd">val</span> <span class="py">tokenSet</span> <span class="p">=</span> <span class="nc">TokenSet</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="nc">MarkdownElementTypes</span><span class="p">.</span><span class="nc">INLINE_LINK</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">icon</span> <span class="p">=</span> <span class="nc">IconLoader</span><span class="p">.</span><span class="nf">getIcon</span><span class="p">(</span><span class="s">"/icons/ic_linemarkerprovider.svg"</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">tokenSet</span><span class="p">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">elementType</span><span class="p">))</span>
      <span class="k">return</span> <span class="nc">LineMarkerInfo</span><span class="p">(</span><span class="n">element</span><span class="p">,</span>
                            <span class="n">element</span><span class="p">.</span><span class="n">textRange</span><span class="p">,</span>
                            <span class="n">icon</span><span class="p">,</span>
                            <span class="k">null</span><span class="p">,</span>
                            <span class="k">null</span><span class="p">,</span>
                            <span class="nc">GutterIconRenderer</span><span class="p">.</span><span class="nc">Alignment</span><span class="p">.</span><span class="nc">CENTER</span><span class="p">)</span>

    <span class="k">return</span> <span class="k">null</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>You can add the <code class="language-plaintext highlighter-rouge">ic_linemarkerprovider.svg</code> icon here (create this file in the
<code class="language-plaintext highlighter-rouge">$PROJECT_DIR/src/main/resources/icons/</code> folder.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;svg</span> <span class="na">xmlns=</span><span class="s">"http://www.w3.org/2000/svg"</span> <span class="na">viewBox=</span><span class="s">"0 0 24 24"</span> <span class="na">height=</span><span class="s">"13px"</span> <span class="na">width=</span><span class="s">"13px"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;path</span> <span class="na">d=</span><span class="s">"M0 0h24v24H0z"</span> <span class="na">fill=</span><span class="s">"none"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;path</span>
      <span class="na">d=</span><span class="s">"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/svg&gt;</span>
</code></pre></div></div>
      <h4 id="4-provide-a-more-complex-implementation-of-linemarkerprovider">
        
        
          4. Provide a more complex implementation of LineMarkerProvider <a href="#4-provide-a-more-complex-implementation-of-linemarkerprovider">#</a>
        
        
      </h4>
    

<p>The example we have so far, simply shows a gutter icon beside the lines in the editor window, that
match our matching criteria. Let‚Äôs say that we want to show some relevant actions that can be
performed on the <code class="language-plaintext highlighter-rouge">PsiElement</code>(s) that matched and are associated with the gutter icon. In this case
we have to delve a little deeper into the <code class="language-plaintext highlighter-rouge">LineMarkerInfo</code> class.</p>

<p>If you look at
<a href="https://github.com/jetbrains/intellij-community/blob/master/platform/lang-api/src/com/intellij/codeInsight/daemon/LineMarkerInfo.java#L137"><code class="language-plaintext highlighter-rouge">LineMarkerInfo.java</code></a>,
you will find a <code class="language-plaintext highlighter-rouge">createGutterRenderer()</code> method. We can actually override this method and create our
own <code class="language-plaintext highlighter-rouge">GutterIconRenderer</code> objects that have an action group inside of them which will hold all our
related actions.</p>

<p>The following class
<a href="https://github.com/jetbrains/intellij-community/blob/master/platform/execution-impl/src/com/intellij/execution/lineMarker/RunLineMarkerProvider.java#L115"><code class="language-plaintext highlighter-rouge">RunLineMarkerProvider.java</code></a>
actually provides us some clue of how to use all of this. In IDEA, when there are targets that you
can run, a gutter icon (play button) that allows you to execute the run target. This class actually
provides an implementation of that functionality. Using it as inspiration, we can create the more
complex version of our line marker provider.</p>

<p>We are going to change our initial implementation of <code class="language-plaintext highlighter-rouge">MarkdownLineMarkerProvider</code> quite drastically.
First we have to add a class that is our new <code class="language-plaintext highlighter-rouge">LineMarkerInfo</code> implementation called
<code class="language-plaintext highlighter-rouge">RunLineMarkerInfo</code>. This class simply allows us to return an <code class="language-plaintext highlighter-rouge">ActionGroup</code> that we will now have to
provide.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">RunLineMarkerInfo</span><span class="p">(</span><span class="n">element</span><span class="p">:</span> <span class="nc">PsiElement</span><span class="p">,</span>
                        <span class="n">icon</span><span class="p">:</span> <span class="nc">Icon</span><span class="p">,</span>
                        <span class="k">private</span> <span class="kd">val</span> <span class="py">myActionGroup</span><span class="p">:</span> <span class="nc">DefaultActionGroup</span><span class="p">,</span>
                        <span class="n">tooltipProvider</span><span class="p">:</span> <span class="nc">Function</span><span class="p">&lt;</span><span class="k">in</span> <span class="nc">PsiElement</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;?</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">LineMarkerInfo</span><span class="p">&lt;</span><span class="nc">PsiElement</span><span class="p">&gt;(</span><span class="n">element</span><span class="p">,</span>
                               <span class="n">element</span><span class="p">.</span><span class="n">textRange</span><span class="p">,</span>
                               <span class="n">icon</span><span class="p">,</span>
                               <span class="n">tooltipProvider</span><span class="p">,</span>
                               <span class="k">null</span><span class="p">,</span>
                               <span class="nc">GutterIconRenderer</span><span class="p">.</span><span class="nc">Alignment</span><span class="p">.</span><span class="nc">CENTER</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">createGutterRenderer</span><span class="p">():</span> <span class="nc">GutterIconRenderer</span><span class="p">?</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">object</span> <span class="err">: </span><span class="nc">LineMarkerGutterIconRenderer</span><span class="p">&lt;</span><span class="nc">PsiElement</span><span class="p">&gt;(</span><span class="k">this</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">override</span> <span class="k">fun</span> <span class="nf">getClickAction</span><span class="p">():</span> <span class="nc">AnAction</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">null</span>
      <span class="p">}</span>

      <span class="k">override</span> <span class="k">fun</span> <span class="nf">isNavigateAction</span><span class="p">():</span> <span class="nc">Boolean</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">true</span>
      <span class="p">}</span>

      <span class="k">override</span> <span class="k">fun</span> <span class="nf">getPopupMenuActions</span><span class="p">():</span> <span class="nc">ActionGroup</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">myActionGroup</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Next, is the new version of <code class="language-plaintext highlighter-rouge">MarkdownLineMarkerProvider</code> class itself.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MarkdownLineMarkerProvider</span> <span class="p">:</span> <span class="nc">LineMarkerProvider</span> <span class="p">{</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">getLineMarkerInfo</span><span class="p">(</span><span class="n">element</span><span class="p">:</span> <span class="nc">PsiElement</span><span class="p">):</span> <span class="nc">LineMarkerInfo</span><span class="p">&lt;</span><span class="err">*</span><span class="p">&gt;?</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">node</span> <span class="p">=</span> <span class="n">element</span><span class="p">.</span><span class="n">node</span>
    <span class="kd">val</span> <span class="py">tokenSet</span> <span class="p">=</span> <span class="nc">TokenSet</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="nc">MarkdownElementTypes</span><span class="p">.</span><span class="nc">INLINE_LINK</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tokenSet</span><span class="p">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">elementType</span><span class="p">))</span>
      <span class="k">return</span> <span class="nc">RunLineMarkerInfo</span><span class="p">(</span><span class="n">element</span><span class="p">,</span>
                               <span class="nc">IconLoader</span><span class="p">.</span><span class="nf">getIcon</span><span class="p">(</span><span class="s">"/icons/ic_linemarkerprovider.svg"</span><span class="p">),</span>
                               <span class="nf">createActionGroup</span><span class="p">(</span><span class="n">element</span><span class="p">),</span>
                               <span class="nf">createToolTipProvider</span><span class="p">(</span><span class="n">element</span><span class="p">))</span>
    <span class="k">else</span> <span class="k">return</span> <span class="k">null</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="k">fun</span> <span class="nf">createToolTipProvider</span><span class="p">(</span><span class="n">inlineLinkElement</span><span class="p">:</span> <span class="nc">PsiElement</span><span class="p">):</span> <span class="nc">Function</span><span class="p">&lt;</span><span class="k">in</span> <span class="nc">PsiElement</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">tooltipProvider</span> <span class="p">=</span>
        <span class="nc">Function</span> <span class="p">{</span> <span class="n">element1</span><span class="p">:</span> <span class="nc">PsiElement</span> <span class="p">-&gt;</span>
          <span class="kd">val</span> <span class="py">current</span> <span class="p">=</span> <span class="nc">LocalDateTime</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
          <span class="kd">val</span> <span class="py">formatter</span> <span class="p">=</span> <span class="nc">DateTimeFormatter</span><span class="p">.</span><span class="nf">ofLocalizedDateTime</span><span class="p">(</span><span class="nc">FormatStyle</span><span class="p">.</span><span class="nc">SHORT</span><span class="p">)</span>
          <span class="kd">val</span> <span class="py">formatted</span> <span class="p">=</span> <span class="n">current</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
          <span class="nf">buildString</span> <span class="p">{</span>
            <span class="nf">append</span><span class="p">(</span><span class="s">"Tooltip calculated at "</span><span class="p">)</span>
            <span class="nf">append</span><span class="p">(</span><span class="n">formatted</span><span class="p">)</span>
          <span class="p">}</span>
        <span class="p">}</span>
    <span class="k">return</span> <span class="n">tooltipProvider</span>
  <span class="p">}</span>

  <span class="k">fun</span> <span class="nf">createActionGroup</span><span class="p">(</span><span class="n">inlineLinkElement</span><span class="p">:</span> <span class="nc">PsiElement</span><span class="p">):</span> <span class="nc">DefaultActionGroup</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">linkDestinationElement</span> <span class="p">=</span>
        <span class="nf">findChildElement</span><span class="p">(</span><span class="n">inlineLinkElement</span><span class="p">,</span> <span class="nc">MarkdownTokenTypeSets</span><span class="p">.</span><span class="nc">LINK_DESTINATION</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">linkDestination</span> <span class="p">=</span> <span class="n">linkDestinationElement</span><span class="o">?.</span><span class="n">text</span>
    <span class="kd">val</span> <span class="py">group</span> <span class="p">=</span> <span class="nc">DefaultActionGroup</span><span class="p">()</span>
    <span class="n">group</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">OpenUrlAction</span><span class="p">(</span><span class="n">linkDestination</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">group</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">createActionGroup(...)</code> method actually creates an <code class="language-plaintext highlighter-rouge">ActionGroup</code> and adds a bunch of actions
that will be available when the user clicks on the gutter icon for this plugin. Note that you can
also add actions that are registered in your <code class="language-plaintext highlighter-rouge">plugin.xml</code> using something like this.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">group</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">ActionManager</span><span class="p">.</span><span class="nf">getInstance</span><span class="p">().</span><span class="nf">getAction</span><span class="p">(</span><span class="s">"ID of your plugin action"</span><span class="p">))</span>
</code></pre></div></div>

<p>Finally, here‚Äôs the action to open a URL that is associated with the INLINE_LINK that is highlighted
in the gutter.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">OpenUrlAction</span><span class="p">(</span><span class="kd">val</span> <span class="py">linkDestination</span><span class="p">:</span> <span class="nc">String</span><span class="p">?)</span> <span class="p">:</span>
  <span class="nc">AnAction</span><span class="p">(</span><span class="s">"Open Link"</span><span class="p">,</span> <span class="s">"Open URL destination in browser"</span><span class="p">,</span> <span class="nc">IconLoader</span><span class="p">.</span><span class="nf">getIcon</span><span class="p">(</span><span class="s">"/icons/ic_extension.svg"</span><span class="p">))</span> <span class="p">{</span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">actionPerformed</span><span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nc">AnActionEvent</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">linkDestination</span><span class="o">?.</span><span class="nf">apply</span> <span class="p">{</span>
      <span class="nc">BrowserUtil</span><span class="p">.</span><span class="k">open</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>
      <h4 id="references">
        
        
          References <a href="#references">#</a>
        
        
      </h4>
    

<p>Docs</p>

<ul>
  <li><a href="https://tinyurl.com/yc8mmrdl">JB docs</a></li>
</ul>

<p>Code samples</p>

<ul>
  <li><a href="https://github.com/nazmulidris/idea-plugin-example2">idea-plugin-example2 repo</a></li>
  <li><a href="https://tinyurl.com/yayn2or6">HaxeLineMarkerProvider.java</a></li>
  <li><a href="https://tinyurl.com/ydgwt96k">SimpleLineMarkerProvider.java</a></li>
  <li><a href="https://tinyurl.com/y9m2ckm6">Lots of examples of using <code class="language-plaintext highlighter-rouge">LineMarkerInfo</code></a></li>
</ul>

<p>Discussions</p>

<ul>
  <li><a href="https://tinyurl.com/y7ohdv2v">JB forums: LineMarker for PsiElement, no target</a></li>
  <li><a href="https://tinyurl.com/y8gqlz3y">JB forums: Adding ‚ÄúActions‚Äù to Line Markers</a></li>
  <li><a href="https://tinyurl.com/ydhmzew9">JB forums: Is it possible to add line markers (gutter icons) without a file change?</a></li>
  <li><a href="https://tinyurl.com/yd49fc44">JB forums: Set a LineMarker on click, similar to bookmark</a></li>
</ul>

        <!--
    Display all the categories for this page
    More info:
    - Tutorial - http://tinyurl.com/yc6fq6zx
    - Liquid language reference - http://tinyurl.com/y8s4qpwo
-->
<div class="categories-block">
    
    
    <span class="category">
            <a href="/category/IJ">
                #ij</a>
        </span>
    
    <span class="category">
            <a href="/category/KT">
                #kt</a>
        </span>
    
    <span class="category">
            <a href="/category/MP">
                #mp</a>
        </span>
    
</div>

        
<blockquote>

üì¶ Install our useful Rust command line apps using <code>cargo install r3bl-cmdr</code>
(they are from the <a href="https://github.com/r3bl-org/r3bl-open-core">r3bl-open-core</a>
project):
<ul>
  <li>üê±<code>giti</code>: run interactive git commands with confidence in your terminal</li>
  <li>ü¶ú<code>edi</code>: edit Markdown with style in your terminal</li>
</ul>

<p>
<kbd>giti in action</kbd>
<video width="100%" controls>
  <source src="https://github.com/nazmulidris/developerlife.com/assets/2966499/262f59d1-a95c-4af3-accf-c3d6cac6e586" type="video/mp4"/>
</video>
</p>

<p>
<kbd>edi in action</kbd>
<video width="100%" controls>
  <source src="https://github.com/nazmulidris/developerlife.com/assets/2966499/f2c4b07d-b5a2-4f41-af7a-06d1b6660c41" type="video/mp4"/>
</video>
</p>

</blockquote>

        <!--
    Display related posts (by category)
    More info:
    - Tutorial - http://tinyurl.com/j5tevq7
    - Liquid language reference - http://tinyurl.com/y9ru5msq
-->
<div class="related-post-block">

    <h3>Related Posts</h3>

    <!-- Get all the related posts into the string `postsString`-->
    
    
    

    <!--
        At this point `postsString` string might look like:
        Post 3|Post 1|Post 3|Post 2|Post 1|Post 3|Post 2|
    -->

    <!-- Remove all the dupes from the `postsString` string, and split it into an array -->
    

    <ul>
        
            
        
            
                
                <li>
                    <a class="post-list" href="/2020/11/20/idea-plugin-example-intro/">
                        Introduction to creating IntelliJ IDEA plugins
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2021/02/06/publish-kotlin-library-as-gradle-dep/">
                        Publishing a Kotlin library as a Gradle dependency to JitPack or GitHub Package Repository
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2020/07/15/non-capturing-lambda-problems/">
                        Potential problems of using non-capturing lambdas
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2020/07/11/annotation-processing-kotlin-android/">
                        Annotation Processing in Kotlin and Android
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2020/04/05/kotlin-dsl-intro/">
                        Kotlin DSL Introduction
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2019/12/02/project-loom-experiment/">
                        Experimenting w/ Fibers in Project Loom preview
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2019/05/11/kotlin-vs-java/">
                        Java vs Kotlin for Android development
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2019/03/30/algorithms-in-kotlin-8/">
                        Algorithms in Kotlin, Schedule ordered tasks
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2018/10/21/kotlin-testing-setup/">
                        Kotlin and Test Driven Development
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2018/10/21/kotlin-sealed-classes/">
                        Kotlin Sealed Classes and State
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2018/10/21/kotlin-extension-function-expressions/">
                        Kotlin Extension Function Expressions
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2018/10/21/dagger2-and-kotlin/">
                        Advanced Dagger 2 w/ Android and Kotlin
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2018/08/16/algorithms-in-kotlin-7/">
                        Algorithms in Kotlin, Caches, Part 7/7
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2018/08/16/algorithms-in-kotlin-6/">
                        Algorithms in Kotlin, Binary Trees, Part 6/7
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2018/08/16/algorithms-in-kotlin-5/">
                        Algorithms in Kotlin, Graphs, Part 5/7
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2018/08/16/algorithms-in-kotlin-4/">
                        Algorithms in Kotlin, Recursion, Part 4/7
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2018/08/16/algorithms-in-kotlin-3/">
                        Algorithms in Kotlin, Stacks and Queues, Part 3/7
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2018/08/16/algorithms-in-kotlin-2/">
                        Algorithms in Kotlin, Strings, Part 2/7
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2018/08/16/algorithms-in-kotlin-1/">
                        Algorithms in Kotlin, Big-O-Notation, Part 1/7
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2022/08/04/rust-dsl-part-1/">
                        Create a simple DSL for CSS like syntax for TUIs
                    </a>
                </li>
            
        
            
                
                <li>
                    <a class="post-list" href="/2022/03/30/rust-proc-macro/">
                        Guide to Rust procedural macros
                    </a>
                </li>
            
        
    </ul>

</div>

        <a class="u-url" href="/2021/03/13/ij-idea-plugin-advanced/" hidden></a>
    </div></article>
</div>
      </main><div>
  <section class="sidebar">
    <h2 class="star-us-github-heading">
      Subscribe to our Rust live coding
      <a href="https://www.youtube.com/@developerlifecom">YouTube Channel</a
      ><span class="heading-emoji"> ü¶Ä</span>
    </h2>

    <!-- video on intro to testing (with playlist) -->
    <!-- <iframe
      src="https://www.youtube.com/embed/videoseries?si=7gmhXY5DVYJG7OdU&amp;list=PLofhE49PEwmwLR_4Noa0dFOSPmSpIg_l8"
      title="YouTube video player"
      frameborder="0"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
      referrerpolicy="strict-origin-when-cross-origin"
      allowfullscreen
    >
    </iframe> -->

    <!-- rust async readline and spinner & playlist -->
    <!-- <iframe
      src="https://www.youtube.com/embed/videoseries?si=i37Ei9nCfvslOoaI&amp;list=PLofhE49PEwmwelPkhfiqdFQ9IXnmGdnSE"
      title="YouTube video player"
      frameborder="0"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
      referrerpolicy="strict-origin-when-cross-origin"
      allowfullscreen
    >
    </iframe> -->

  <!-- rust tokio tracing and otel for async rust & playlist -->
  <iframe
    src="https://www.youtube.com/embed/Wf8JrLgBuKI?si=cmLaUWs-pbJ39lLc"
    title="YouTube video player"
    frameborder="0"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
    referrerpolicy="strict-origin-when-cross-origin"
    allowfullscreen>
  </iframe>

    <br />
    <br />

    <h2 class="star-us-github-heading">
      Use our extensions, apps, binary and library crates<span class="heading-emoji"> üì¶</span>
    </h2>

    <ul class="sidebar-ul">
      <li class="app-container">
        <a href="https://github.com/r3bl-org/r3bl-open-core/tree/main/cmdr" target="_blank">
          <img class="star-icon-img" src="/assets/r3bl-apps.svg" />
          <div class="sidebar-list-item">
            <p class="p-tag">INSTALL & USE OUR APPS (giti, edi)</p>
            <h3 class="sidebar-h3"><code>r3bl-cmdr</code></h3>
          </div>
        </a>
      </li>
      <li class="app-container">
        <a href="https://github.com/r3bl-org/shortlink" target="_blank">
          <img class="star-icon-img" src="/assets/r3bl-shortlink.svg" />
          <div class="sidebar-list-item">
            <p class="p-tag">SHORTLINK browser extension</p>
            <h3 class="sidebar-h3"><code>shortlink</code></h3>
          </div>
        </a>
      </li>
      <li class="app-container">
        <a href="https://github.com/r3bl-org/r3bl-open-core/tree/main/tui" target="_blank">
          <img class="star-icon-img" src="/assets/crate.png" />
          <div class="sidebar-list-item">
            <p class="p-tag">R3BL TUI LIB</p>
            <h3 class="sidebar-h3"><code>r3bl_tui</code></h3>
          </div>
        </a>
      </li>
      <li class="app-container">
        <a href="https://github.com/r3bl-org/r3bl-open-core/tree/main/tuify" target="_blank">
          <img class="star-icon-img" src="/assets/crate.png" />
          <div class="sidebar-list-item">
            <p class="p-tag">R3BL TUIFY LIB</p>
            <h3 class="sidebar-h3"><code>r3bl_tuify</code></h3>
          </div>
        </a>
      </li>
      <li class="app-container">
        <a
          href="https://github.com/r3bl-org/r3bl-open-core/tree/main/terminal_async"
          target="_blank"
        >
          <img class="star-icon-img" src="/assets/crate.png" />
          <div class="sidebar-list-item">
            <p class="p-tag">R3BL TERMINAL ASYNC LIB</p>
            <h3 class="sidebar-h3"><code>r3bl_terminal_async</code></h3>
          </div>
        </a>
      </li>
    </ul>

    <br />

    <h2 class="star-us-github-heading">
      Join our <a href="https://discord.gg/PhuF4qFpcA">Discord</a>
      <span class="heading-emoji"> üí¨</span>
    </h2>
  </section>
</div>
</div><footer class="site-footer h-card">

    <div class="wrapper">

        <div class="footer-col-wrapper">

            <div class="footer-col"><!-- <p>
    developerlife.com site was started in Nov 1998 with coverage for
    topics related to Java, XML, and web and desktop technologies.
    Today it covers Kotlin, TypeScript, Node.js, React, Android, JDK,
    Web, Cloud technologies, User Experience Engineering (UXE)
    and design topics. ¬© Nazmul Idris 2022. All rights reserved.
</p> -->
<div>
  <p class="footer-p">
    developerlife.com site was started in Nov 1998 by <a href="https://developerlife.com/about-me/">Nazmul Idris</a>, with coverage for topics related to Java, XML,
    and web and desktop technologies. Today it covers Rust, TUI, CLI, Kotlin, TypeScript, Node.js, React, Android,
    JDK, Web, Cloud technologies, User Experience Engineering (UXE) and design topics. ¬© Nazmul
    Idris 2022. All rights reserved.
  </p>
  <div class="footer-container">
    <!-- element 1 -->
    <kbd>
      <a class="footer-elem-1" href="/subscribe.html" target="_blank"
        >Subscribe for updates</a
      >
    </kbd>

    <!-- element 2 -->
    <kbd>
      <a class="footer-elem-2" href="https://r3bl.com" target="_blank">Sponsored by R3BL</a>
    </kbd>
  </div>
</div>
</div>

        </div>

    </div>

</footer>
<script>
//open external links in a new window
function external_new_window() {
    for(var c = document.getElementsByTagName("a"), a = 0;a < c.length;a++) {
    var b = c[a];
    b.getAttribute("href") && b.hostname !== location.hostname && (b.target = "_blank")
    }
}
//open PDF links in a new window
function pdf_new_window ()
{
    if (!document.getElementsByTagName) return false;
    var links = document.getElementsByTagName("a");
    for (var eleLink=0; eleLink < links.length; eleLink ++) {
    if ((links[eleLink].href.indexOf('.pdf') !== -1)||(links[eleLink].href.indexOf('.doc') !== -1)||(links[eleLink].href.indexOf('.docx') !== -1)) {
        links[eleLink].onclick =
        function() {
            window.open(this.href);
            return false;
        }
    }
    }
} 
pdf_new_window()
external_new_window();
</script></body>
</html>
